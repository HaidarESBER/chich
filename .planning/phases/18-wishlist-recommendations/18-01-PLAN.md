---
phase: 18-wishlist-recommendations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  supabase/migrations/wishlist.sql,
  src/types/wishlist.ts,
  src/app/api/wishlist/route.ts,
  src/app/api/wishlist/[productId]/route.ts,
  src/app/compte/wishlist/page.tsx,
  src/components/product/WishlistButton.tsx,
  src/components/layout/Header.tsx
]
autonomous: true
---

<objective>
Implement product wishlist feature allowing users to save favorite products for later viewing.

Purpose: Increase engagement and conversion by letting users save products they're interested in, creating a persistent shopping intent signal.
Output: Complete wishlist system with database, API, UI page, and wishlist buttons throughout the site.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-wishlist-recommendations/DISCOVERY.md

# User accounts and session management
@.planning/phases/17-customer-accounts-profiles/17-01-SUMMARY.md
@.planning/phases/09-supabase-migration-auth/09-03-SUMMARY.md

# Existing patterns
@supabase/schema.sql
@src/types/user.ts
@src/lib/session.ts
@src/components/product/ProductCard.tsx
@src/app/compte/profil/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wishlist database schema and types</name>
  <files>supabase/migrations/wishlist.sql, src/types/wishlist.ts</files>
  <action>
Create migration `supabase/migrations/wishlist.sql`:

```sql
-- Wishlist table for saving favorite products
CREATE TABLE wishlist (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  added_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(user_id, product_id)
);

-- Indexes for performance
CREATE INDEX idx_wishlist_user ON wishlist(user_id);
CREATE INDEX idx_wishlist_product ON wishlist(product_id);
CREATE INDEX idx_wishlist_user_added ON wishlist(user_id, added_at DESC);

-- RLS policies: users can only see and modify their own wishlist items
ALTER TABLE wishlist ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own wishlist items" ON wishlist
  FOR SELECT USING (user_id = auth.uid());

CREATE POLICY "Users can add to own wishlist" ON wishlist
  FOR INSERT WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can remove from own wishlist" ON wishlist
  FOR DELETE USING (user_id = auth.uid());

-- Admins can view all wishlists (for analytics)
CREATE POLICY "Admins can view all wishlists" ON wishlist
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND profiles.is_admin = true)
  );
```

Create `src/types/wishlist.ts`:
```typescript
import { Product } from './product';

export interface WishlistItem {
  id: string;
  userId: string;
  productId: string;
  addedAt: string;
}

export interface WishlistItemWithProduct extends WishlistItem {
  product: Product;
}

export interface WishlistResponse {
  items: WishlistItemWithProduct[];
  count: number;
}
```

Run migration in Supabase SQL Editor (paste contents, execute).
  </action>
  <verify>
Check migration applied: SELECT * FROM wishlist LIMIT 1;
TypeScript compilation: npm run build
  </verify>
  <done>
Migration applied, wishlist table exists with RLS policies, TypeScript types compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create wishlist API endpoints</name>
  <files>src/app/api/wishlist/route.ts, src/app/api/wishlist/[productId]/route.ts</files>
  <action>
Create `src/app/api/wishlist/route.ts`:
- GET: Fetch user's wishlist with product details
  - Use `requireAuth()` from session helpers (returns user or throws 401)
  - Query: `SELECT wishlist.*, products.* FROM wishlist JOIN products ON wishlist.product_id = products.id WHERE wishlist.user_id = $1 ORDER BY wishlist.added_at DESC`
  - Return `{items: WishlistItemWithProduct[], count: number}`

- POST: Add product to wishlist
  - Accept `{productId: string}` in body
  - Use `requireAuth()`
  - Validate product exists: `SELECT id FROM products WHERE id = $1`
  - Insert: `INSERT INTO wishlist (user_id, product_id) VALUES ($1, $2) ON CONFLICT (user_id, product_id) DO NOTHING RETURNING *`
  - Return created item with 201 status (or 200 if already exists)

Create `src/app/api/wishlist/[productId]/route.ts`:
- DELETE: Remove product from wishlist
  - Use `requireAuth()`
  - Delete: `DELETE FROM wishlist WHERE user_id = $1 AND product_id = $2 RETURNING *`
  - Return 204 No Content on success, 404 if not found

Use createAdminClient for queries (following Phase 9 pattern), wrap in try/catch with proper error responses.
  </action>
  <verify>
curl -X POST http://localhost:3000/api/wishlist -H "Cookie: auth-token=..." -d '{"productId":"uuid"}' - returns 201
curl http://localhost:3000/api/wishlist -H "Cookie: auth-token=..." - returns wishlist items
curl -X DELETE http://localhost:3000/api/wishlist/uuid -H "Cookie: auth-token=..." - returns 204
  </verify>
  <done>
Wishlist API endpoints work end-to-end: add product returns 201, fetch returns items with product details, delete removes item and returns 204
  </done>
</task>

<task type="auto">
  <name>Task 3: Build wishlist UI with page, buttons, and header icon</name>
  <files>src/app/compte/wishlist/page.tsx, src/components/product/WishlistButton.tsx, src/components/layout/Header.tsx</files>
  <action>
Create `src/components/product/WishlistButton.tsx`:
- Client component accepting `{productId: string, className?: string}`
- Use session context to check if product is in wishlist
- Heart icon (outline when not in wishlist, filled when in wishlist)
- Click handler:
  - If not authenticated: redirect to /compte/connexion
  - If in wishlist: DELETE /api/wishlist/:productId
  - If not in wishlist: POST /api/wishlist with productId
- Optimistic UI update (update state immediately, revert on error)
- Toast notification: "Ajouté aux favoris" / "Retiré des favoris"
- Styling: matches Nuage design (hover:text-accent-blush, transition-colors)

Create `src/app/compte/wishlist/page.tsx`:
- Server component with metadata (title: "Ma Liste de Souhaits | Nuage", description: "Vos produits favoris")
- Client component WishlistPageClient that fetches GET /api/wishlist
- Grid layout (same as product catalog: 2 cols mobile, 3 cols tablet, 4 cols desktop)
- Each item shows: ProductCard with WishlistButton (remove functionality)
- Empty state: "Votre liste de souhaits est vide" with illustration, link to /produits
- Loading state with skeleton cards
- Use existing motion animations (stagger children pattern from Phase 8)

Update `src/components/layout/Header.tsx`:
- Add wishlist icon next to cart icon
- Heart outline icon with count badge (if count > 0)
- Link to /compte/wishlist
- Fetch wishlist count via GET /api/wishlist on mount (for authenticated users)
- Use same badge styling as cart count (absolute positioning, bg-accent-blush, text-white, rounded-full)
  </action>
  <verify>
Visit http://localhost:3000/compte/wishlist - page loads with empty state for new users
Click WishlistButton on product card - adds to wishlist, icon fills, toast shows
Visit wishlist page - product appears
Click filled heart - removes from wishlist
Header shows wishlist count badge when items exist
  </verify>
  <done>
Wishlist page displays saved products, WishlistButton adds/removes products with optimistic UI, header shows wishlist count, empty state works
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] TypeScript compilation passes
- [ ] Wishlist table created with RLS policies
- [ ] GET /api/wishlist returns user's wishlist items with product details
- [ ] POST /api/wishlist adds product to wishlist
- [ ] DELETE /api/wishlist/:productId removes product
- [ ] Wishlist page displays saved products in grid
- [ ] WishlistButton toggles wishlist state with optimistic UI
- [ ] Header shows wishlist count badge
- [ ] Empty state displays when no wishlist items
- [ ] UI matches Nuage design system (Cormorant Garamond, Inter, Charcoal/Mist/Stone/Blush)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript or build errors
- Users can add products to wishlist from any page
- Users can view wishlist at /compte/wishlist
- Users can remove products from wishlist
- Wishlist count shows in header
- RLS ensures users only see their own wishlist items
- UI is mobile-responsive and follows existing patterns
  </success_criteria>

<output>
After completion, create `.planning/phases/18-wishlist-recommendations/18-01-SUMMARY.md`
</output>
