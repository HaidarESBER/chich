---
phase: 18-wishlist-recommendations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [
  supabase/migrations/browse_history.sql,
  src/types/analytics.ts,
  src/app/api/track/view/route.ts,
  src/app/produits/[slug]/page.tsx,
  src/app/api/profile/route.ts,
  src/types/user.ts
]
autonomous: true
---

<objective>
Implement browse history tracking to power product recommendations while respecting user privacy.

Purpose: Collect behavioral signals (product views) to generate relevant recommendations, with user consent and automatic data cleanup.
Output: Browse history database table, tracking API, client-side integration, and privacy controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-wishlist-recommendations/DISCOVERY.md

# User session and preferences
@.planning/phases/17-customer-accounts-profiles/17-01-SUMMARY.md
@src/types/user.ts
@src/lib/session.ts

# Product page structure
@src/app/produits/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create browse history database schema with auto-cleanup</name>
  <files>supabase/migrations/browse_history.sql, src/types/analytics.ts</files>
  <action>
Create migration `supabase/migrations/browse_history.sql`:

```sql
-- Browse history for tracking product views
CREATE TABLE browse_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  viewed_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes for performance
CREATE INDEX idx_browse_user_time ON browse_history(user_id, viewed_at DESC);
CREATE INDEX idx_browse_product ON browse_history(product_id);

-- RLS policies: users can only see their own browse history
ALTER TABLE browse_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own browse history" ON browse_history
  FOR SELECT USING (user_id = auth.uid());

CREATE POLICY "Users can add to own browse history" ON browse_history
  FOR INSERT WITH CHECK (user_id = auth.uid());

-- Admins can view all browse history (for analytics)
CREATE POLICY "Admins can view all browse history" ON browse_history
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND profiles.is_admin = true)
  );

-- Auto-cleanup function: Delete views older than 90 days
CREATE OR REPLACE FUNCTION cleanup_old_browse_history()
RETURNS trigger AS $$
BEGIN
  DELETE FROM browse_history WHERE viewed_at < now() - INTERVAL '90 days';
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to run cleanup after each insert
CREATE TRIGGER trigger_cleanup_browse_history
  AFTER INSERT ON browse_history
  EXECUTE FUNCTION cleanup_old_browse_history();
```

Create `src/types/analytics.ts`:
```typescript
export interface BrowseHistoryEntry {
  id: string;
  userId: string;
  productId: string;
  viewedAt: string;
}

export interface CategoryAffinity {
  category: string;
  viewCount: number;
  wishlistCount: number;
  purchaseCount: number;
  score: number; // Weighted score based on signals
}

export interface PriceRangePreference {
  minPrice: number;
  maxPrice: number;
  averagePrice: number;
}
```

Run migration in Supabase SQL Editor (paste contents, execute).
  </action>
  <verify>
Check migration applied: SELECT * FROM browse_history LIMIT 1;
Check trigger exists: SELECT tgname FROM pg_trigger WHERE tgname = 'trigger_cleanup_browse_history';
TypeScript compilation: npm run build
  </verify>
  <done>
Migration applied, browse_history table exists with RLS and auto-cleanup trigger, TypeScript types compile
  </done>
</task>

<task type="auto">
  <name>Task 2: Create browse tracking API and integrate with product page</name>
  <files>src/app/api/track/view/route.ts, src/app/produits/[slug]/page.tsx</files>
  <action>
Create `src/app/api/track/view/route.ts`:
- POST: Track product view
  - Accept `{productId: string}` in body
  - Check if user is authenticated via `getSession()` (optional - guest tracking not needed for MVP)
  - If authenticated AND user has `preferences.track_browsing !== false`:
    - Insert: `INSERT INTO browse_history (user_id, product_id) VALUES ($1, $2)`
    - Ignore duplicates within same session (check if viewed in last 30 minutes: `WHERE user_id = $1 AND product_id = $2 AND viewed_at > now() - INTERVAL '30 minutes'`, skip insert if exists)
  - Return 204 No Content (fire-and-forget pattern)
  - Handle errors silently (tracking should never break user experience)

Update `src/app/produits/[slug]/page.tsx`:
- Add client component `<ProductViewTracker productId={product.id} />` at top of page
- ProductViewTracker component:
  - Client component accepting `{productId: string}`
  - useEffect on mount (run once): POST /api/track/view with productId
  - Fire-and-forget (don't wait for response, ignore errors)
  - Lightweight, no UI

Privacy: Only track if user is authenticated and hasn't disabled tracking in preferences.
  </action>
  <verify>
Visit product page while authenticated - check database: SELECT * FROM browse_history WHERE user_id = 'uuid' - new row appears
Visit same product again within 30 minutes - no duplicate row created
Visit different product - new row created
  </verify>
  <done>
Product views tracked for authenticated users, duplicates within 30min prevented, tracking respects privacy preferences, silent failures don't break UX
  </done>
</task>

<task type="auto">
  <name>Task 3: Add privacy control for browse tracking in preferences</name>
  <files>src/types/user.ts, src/app/api/profile/route.ts, src/app/compte/profil/page.tsx</files>
  <action>
Update `src/types/user.ts`:
- Extend EmailPreferences interface:
  ```typescript
  export interface EmailPreferences {
    email_marketing: boolean;
    email_order_updates: boolean;
    email_promotions: boolean;
    track_browsing: boolean; // NEW: Allow browse history tracking for recommendations
  }
  ```

Update default preferences in `supabase/migrations/customer_profiles.sql` (if not already applied):
- Default preferences JSON should include: `"track_browsing": true`
- Run: `UPDATE profiles SET preferences = jsonb_set(preferences, '{track_browsing}', 'true') WHERE preferences->>'track_browsing' IS NULL;`

Update `src/app/compte/profil/page.tsx` Préférences tab:
- Add new toggle: "Historique de navigation"
  - Label: "Suivre les produits que je consulte pour personnaliser mes recommandations"
  - Helper text: "Vos données sont privées et supprimées automatiquement après 90 jours."
  - Checkbox bound to preferences.track_browsing
  - Save via PATCH /api/profile

Ensure `src/app/api/profile/route.ts` PATCH handler saves track_browsing preference (should already work if it saves all preferences fields).
  </action>
  <verify>
Visit /compte/profil, go to Préférences tab - see "Historique de navigation" toggle
Toggle off, save - preference updates in database
Visit product page - browse_history should NOT get new entry
Toggle on, save - visit product page - browse_history gets new entry
  </verify>
  <done>
Users can enable/disable browse tracking in preferences, default is enabled (opt-out model), tracking API respects preference, UI explains privacy policy
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] TypeScript compilation passes
- [ ] browse_history table created with RLS policies
- [ ] Auto-cleanup trigger deletes rows older than 90 days
- [ ] POST /api/track/view creates browse_history entries for authenticated users
- [ ] Duplicate views within 30min not created
- [ ] ProductViewTracker component integrated in product page
- [ ] Privacy preference toggle in /compte/profil works
- [ ] Tracking respects user's track_browsing preference
- [ ] Tracking failures are silent (don't break UX)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript or build errors
- Browse history tracked for authenticated users who haven't opted out
- Product view tracking is fire-and-forget (no UX impact)
- Automatic data cleanup after 90 days
- User can disable tracking via preferences
- Clear privacy explanation in UI
- RLS ensures users only see their own data
  </success_criteria>

<output>
After completion, create `.planning/phases/18-wishlist-recommendations/18-02-SUMMARY.md`
</output>
