---
phase: 17-customer-accounts-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  supabase/migrations/customer_profiles.sql,
  src/types/user.ts,
  src/app/compte/profil/page.tsx,
  src/app/compte/adresses/page.tsx,
  src/app/api/profile/route.ts,
  src/app/api/profile/password/route.ts,
  src/app/api/profile/addresses/route.ts
]
autonomous: true
---

<objective>
Extend customer accounts with profile editing, saved addresses, and communication preferences.

Purpose: Enable users to manage their account details and save addresses for faster checkout, improving UX and conversion.
Output: Complete profile management system with editable profiles, saved shipping addresses, and password change functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (auth foundation)
@.planning/phases/09-supabase-migration-auth/09-01-SUMMARY.md
@.planning/phases/09-supabase-migration-auth/09-03-SUMMARY.md

# Relevant source files
@supabase/schema.sql
@src/types/user.ts
@src/lib/session.ts
@src/app/compte/AccountClient.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend profiles schema with saved addresses and preferences</name>
  <files>supabase/migrations/customer_profiles.sql, src/types/user.ts</files>
  <action>
Create migration `supabase/migrations/customer_profiles.sql`:
- ALTER TABLE profiles ADD COLUMN phone TEXT
- ALTER TABLE profiles ADD COLUMN saved_addresses JSONB DEFAULT '[]'::jsonb
- ALTER TABLE profiles ADD COLUMN preferences JSONB DEFAULT '{"email_marketing": false, "email_order_updates": true, "email_promotions": false}'::jsonb

saved_addresses structure: Array of {id: string, label: string (e.g., "Domicile", "Bureau"), firstName: string, lastName: string, address: string, address2?: string, city: string, postalCode: string, country: string, phone: string, isDefault: boolean}

Update src/types/user.ts:
- Add SavedAddress interface matching schema
- Add preferences interface: {email_marketing: boolean, email_order_updates: boolean, email_promotions: boolean}
- Extend UserSession interface with: phone?: string, savedAddresses?: SavedAddress[], preferences?: EmailPreferences
- Add ProfileUpdateData interface: {firstName?: string, lastName?: string, phone?: string}

Run migration via Supabase dashboard SQL editor (paste contents, execute).
  </action>
  <verify>
Check migration applied: SELECT phone, saved_addresses, preferences FROM profiles LIMIT 1
TypeScript compilation succeeds: npm run build
  </verify>
  <done>
Migration applied, new columns exist, TypeScript types updated with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Build profile management UI with edit and password change</name>
  <files>src/app/compte/profil/page.tsx, src/app/api/profile/route.ts, src/app/api/profile/password/route.ts, src/lib/session.ts</files>
  <action>
Create src/app/api/profile/route.ts:
- GET: Fetch current user profile via getSession(), return full profile data including phone, preferences
- PATCH: Update profile (firstName, lastName, phone) using requireAuth() + Supabase update on profiles table, return updated UserSession

Create src/app/api/profile/password/route.ts:
- POST: Accept {currentPassword, newPassword}, validate newPassword (12+ chars, complexity), use supabase.auth.updateUser({password: newPassword}) after verifying current password via supabase.auth.signInWithPassword(), return success/error

Create src/app/compte/profil/page.tsx:
- Server component with metadata (title: "Mon Profil | Nuage")
- Client component ProfileClient with tabs: "Informations" (name, email, phone edit form), "Sécurité" (password change form), "Préférences" (email notification toggles)
- Informations tab: Form with firstName, lastName, phone inputs, Save button calls PATCH /api/profile
- Sécurité tab: Form with currentPassword, newPassword, confirmNewPassword inputs, button calls POST /api/profile/password
- Préférences tab: Checkboxes for email_marketing, email_order_updates, email_promotions, Save button calls PATCH /api/profile
- Use existing AccountClient.tsx styling patterns (bg-background-secondary/30, rounded-xl, etc.)
- Show success/error toasts after save operations

Update src/lib/session.ts getSession():
- Include phone, saved_addresses, preferences in returned UserSession
  </action>
  <verify>
Visit http://localhost:3000/compte/profil - form loads with current user data
Edit name and save - profile updates in database
Change password - old password verified, new password works for login
Toggle preferences - database updates
  </verify>
  <done>
Profile editing works end-to-end, password change functional, preferences save correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Build saved addresses UI with CRUD operations</name>
  <files>src/app/compte/adresses/page.tsx, src/app/api/profile/addresses/route.ts</files>
  <action>
Create src/app/api/profile/addresses/route.ts:
- GET: Return user's saved_addresses array from profiles
- POST: Add new address to saved_addresses array (generate UUID for address id, validate required fields: firstName, lastName, address, city, postalCode, country, phone), if isDefault=true set all others to false, return updated array
- PATCH: Update existing address by id in saved_addresses array, return updated array
- DELETE: Remove address by id from saved_addresses array, return updated array
- Use requireAuth(), update via Supabase update on profiles.saved_addresses

Create src/app/compte/adresses/page.tsx:
- Server component with metadata (title: "Mes Adresses | Nuage")
- Client component AddressesClient showing:
  - List of saved addresses (card layout with firstName, lastName, full address, phone, Default badge if isDefault)
  - "Ajouter une adresse" button opens modal/form
  - Each address card has Edit and Delete buttons
  - Add/Edit form: All address fields (label dropdown: Domicile/Bureau/Autre, firstName, lastName, address, address2, city, postalCode, country dropdown default FR, phone, isDefault checkbox)
  - Delete confirmation: "Supprimer cette adresse ?" dialog
- Empty state: "Aucune adresse sauvegardée" with illustration, button to add first address
- Use existing component patterns (Container, motion animations, Nuage color scheme)

Validation:
- At least one field (firstName, lastName, address, city, postalCode, country, phone) must be non-empty
- postalCode format check for France (5 digits) when country=FR
  </action>
  <verify>
Visit http://localhost:3000/compte/adresses - empty state shows for new users
Add address - saves to database, appears in list
Edit address - updates correctly
Delete address - removes from list
Set default address - previous default becomes non-default
  </verify>
  <done>
Saved addresses CRUD fully functional, validation working, default address toggle works
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] Profile edit saves to database and persists across refresh
- [ ] Password change works (old password verified, new password allows login)
- [ ] Email preferences save and persist
- [ ] Saved addresses CRUD all operations work
- [ ] Default address logic works (only one default at a time)
- [ ] All new pages follow Nuage design system (Cormorant Garamond headings, Inter body, Charcoal/Mist/Stone/Blush/Cream colors)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors or build warnings
- User can edit profile (name, phone)
- User can change password successfully
- User can manage communication preferences
- User can add, edit, delete, and set default addresses
- UI is mobile-responsive and matches existing /compte styling
  </success_criteria>

<output>
After completion, create `.planning/phases/17-customer-accounts-profiles/17-01-SUMMARY.md`
</output>
