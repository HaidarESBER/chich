---
phase: 19-mobile-ux-excellence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  app/manifest.ts,
  next.config.ts,
  package.json,
  public/sw.js,
  src/app/offline/page.tsx,
  public/icons/*
]
autonomous: true
---

<objective>
Transform the Next.js app into a Progressive Web App with service worker, offline support, and installability.

Purpose: Enable native app-like experience with offline browsing, caching, and "Add to Home Screen" on mobile devices
Output: Full PWA setup with manifest, icons, service worker, and offline fallback
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current mobile setup:
@src/app/layout.tsx
@src/components/mobile/FloatingCartButton.tsx
@src/components/mobile/BottomSheet.tsx
@next.config.ts
@package.json

# Research context:
Modern approach uses Serwist (successor to next-pwa) + Next.js 16 built-in manifest support.
Serwist uses Google Workbox for service worker generation with smart caching strategies.
Next.js 16 has first-class manifest.ts support in App Router.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Serwist and configure PWA foundation</name>
  <files>package.json, next.config.ts, app/manifest.ts</files>
  <action>
Install Serwist packages: `@serwist/next` and `serwist` (use compatible versions, check latest stable).

Create `app/manifest.ts` using Next.js 16 built-in manifest support with:
- name: "Nuage | L'art de la détente"
- short_name: "Nuage"
- description: "Boutique en ligne d'accessoires chicha haut de gamme"
- start_url: "/"
- display: "standalone"
- background_color: "#FAFAF9" (Cream color from brand)
- theme_color: "#2C2C2C" (Charcoal from brand)
- orientation: "portrait-primary"
- scope: "/"
- icons array (will be added in Task 2)
- categories: ["shopping", "lifestyle"]

Update next.config.ts to integrate Serwist:
- Import withSerwist from '@serwist/next'
- Configure dest: "public"
- Configure sw.js generation
- Keep existing withMDX wrapping pattern
- Order: withSerwist(withMDX(nextConfig))

Note: Serwist doesn't support Turbopack yet, but that's fine - webpack works for production builds which is what matters for PWA.
  </action>
  <verify>npm run build succeeds, public/sw.js is generated after build</verify>
  <done>Serwist installed, manifest.ts created with proper metadata, next.config.ts configured for service worker generation</done>
</task>

<task type="auto">
  <name>Task 2: Generate PWA icons and update manifest</name>
  <files>public/icons/*, app/manifest.ts</files>
  <action>
Create PWA icons from the existing Nuage logo (public/nuagelogonobg1.png or similar):

Generate required sizes:
- 72x72, 96x96, 128x128, 144x144, 152x152, 192x192, 384x384, 512x512

Save in public/icons/ directory with naming: icon-72x72.png, icon-96x96.png, etc.

For quick generation, use Next.js Image Optimization or create a simple script:
1. Read logo file
2. Use sharp or canvas to resize (or manually with image editor if needed)
3. Save to public/icons/

Update app/manifest.ts icons array:
```ts
icons: [
  { src: '/icons/icon-72x72.png', sizes: '72x72', type: 'image/png', purpose: 'any' },
  { src: '/icons/icon-96x96.png', sizes: '96x96', type: 'image/png', purpose: 'any' },
  { src: '/icons/icon-128x128.png', sizes: '128x128', type: 'image/png', purpose: 'any' },
  { src: '/icons/icon-144x144.png', sizes: '144x144', type: 'image/png', purpose: 'any' },
  { src: '/icons/icon-152x152.png', sizes: '152x152', type: 'image/png', purpose: 'any' },
  { src: '/icons/icon-192x192.png', sizes: '192x192', type: 'image/png', purpose: 'maskable' },
  { src: '/icons/icon-384x384.png', sizes: '384x384', type: 'image/png', purpose: 'any' },
  { src: '/icons/icon-512x512.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' }
]
```

Note: 192x192 and 512x512 should have purpose: 'maskable' for Android adaptive icons.
  </action>
  <verify>All icon files exist in public/icons/, manifest includes icons array, npm run build succeeds</verify>
  <done>8 PWA icon sizes generated, manifest.ts updated with icons array, icons served from /icons/ path</done>
</task>

<task type="auto">
  <name>Task 3: Create service worker with cache strategies and offline fallback</name>
  <files>public/sw.js (generated), src/app/offline/page.tsx</files>
  <action>
Configure Serwist in next.config.ts with smart cache strategies:

```ts
swSrc: "src/app/sw.ts", // if creating custom sw
swDest: "public/sw.js",
cacheOnNavigation: true,
reloadOnOnline: true,
runtimeCaching: [
  // Images - Cache First (long cache, network fallback)
  {
    urlPattern: /^https:\/\/.*\.(?:png|jpg|jpeg|webp|svg|gif|ico)$/,
    handler: 'CacheFirst',
    options: {
      cacheName: 'images',
      expiration: { maxEntries: 60, maxAgeSeconds: 30 * 24 * 60 * 60 } // 30 days
    }
  },
  // Static assets - Cache First
  {
    urlPattern: /\.(?:js|css|woff|woff2|ttf|otf)$/,
    handler: 'CacheFirst',
    options: {
      cacheName: 'static-assets',
      expiration: { maxEntries: 60, maxAgeSeconds: 7 * 24 * 60 * 60 } // 7 days
    }
  },
  // API routes - Network First (fresh data, cache fallback)
  {
    urlPattern: /^https:\/\/.*\/api\/.*/,
    handler: 'NetworkFirst',
    options: {
      cacheName: 'api-cache',
      networkTimeoutSeconds: 10,
      expiration: { maxEntries: 50, maxAgeSeconds: 5 * 60 } // 5 minutes
    }
  },
  // Pages - Network First (fresh content, cache fallback)
  {
    urlPattern: /^https:\/\/.*/,
    handler: 'NetworkFirst',
    options: {
      cacheName: 'pages',
      networkTimeoutSeconds: 10,
      expiration: { maxEntries: 50, maxAgeSeconds: 24 * 60 * 60 } // 1 day
    }
  }
]
```

Create offline fallback page at src/app/offline/page.tsx:
- Simple, elegant page matching brand aesthetic
- "Vous êtes hors ligne" heading
- "Reconnectez-vous pour continuer votre shopping" message
- Link back to homepage
- Cloud/Nuage logo animation
- Uses Tailwind, no external dependencies (so it works offline)
- No Header/Footer (to avoid failed fetches)

The service worker will automatically serve this page when navigation fails offline.
  </action>
  <verify>npm run build && npm run start, open DevTools Application tab, verify service worker registered, verify cache strategies in DevTools, test offline mode (DevTools Network > Offline)</verify>
  <done>Service worker configured with 4 cache strategies (images, assets, API, pages), offline fallback page created, caching works correctly, offline navigation shows fallback</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with sw.js generated
- [ ] manifest.json accessible at /manifest.json
- [ ] All 8 icon sizes exist and are accessible
- [ ] Service worker registers in DevTools Application tab
- [ ] Cache strategies visible in DevTools Cache Storage
- [ ] Offline mode shows /offline fallback page
- [ ] Network tab shows resources cached on subsequent visits
- [ ] Lighthouse PWA audit passes (installable, offline-ready)
</verification>

<success_criteria>

- Serwist installed and configured in next.config.ts
- app/manifest.ts created with full metadata and icons
- 8 PWA icons generated and included in manifest
- Service worker with 4 cache strategies (images, assets, API, pages)
- Offline fallback page created and accessible
- PWA installable on mobile (passes Lighthouse audit)
- Offline browsing works for cached pages
- No errors in console or build process
  </success_criteria>

<output>
After completion, create `.planning/phases/19-mobile-ux-excellence/19-01-SUMMARY.md`
</output>
