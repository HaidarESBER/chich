---
phase: 13-ai-curation-automation
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified: [src/app/admin/curation/page.tsx, src/app/admin/curation/[id]/page.tsx, src/app/admin/layout.tsx, src/app/api/cron/curate/route.ts, src/lib/pipeline.ts, vercel.json]
autonomous: true
---

<objective>
Build the admin review queue UI and automated curation pipeline. Admins can review AI-translated products, edit/approve/reject them, and publish to the live store. A Vercel Cron job automates the translation of new scraped products.

Purpose: Complete the curation workflow — from raw scraped data to published premium French products in the store.
Output: Admin curation pages, publish-to-products workflow, Vercel Cron automation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/BRAND.md
@.planning/phases/13-ai-curation-automation/13-01-SUMMARY.md

@src/app/admin/layout.tsx
@src/app/admin/produits/page.tsx
@src/app/admin/produits/[id]/page.tsx
@src/types/curation.ts
@src/lib/curation.ts
@src/lib/ai/translate-product.ts
@src/lib/products.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build admin curation review queue UI</name>
  <files>src/app/admin/curation/page.tsx, src/app/admin/curation/[id]/page.tsx, src/app/admin/layout.tsx</files>
  <action>
1. **Add "Curation" to admin sidebar** in `src/app/admin/layout.tsx`:
   - Add a new navigation link: `{ href: '/admin/curation', label: 'Curation', icon: Sparkles }` (use lucide-react Sparkles icon)
   - Place it after "Commandes" in the sidebar nav

2. **Create `/admin/curation` page** (`src/app/admin/curation/page.tsx`):
   - Mark as `export const dynamic = "force-dynamic"` (server-rendered, always fresh)
   - Fetch draft stats using `getDraftStats()` from curation.ts
   - Fetch all drafts using `getAllDrafts()` from curation.ts
   - Display stats summary at top: cards showing count per status (pending_translation, translated, in_review, approved, rejected, published)
   - Display filterable draft list below:
     - Tab/filter bar for status: Tous | A traduire | Traduits | En revue | Approuves | Rejetes | Publies
     - Each row shows: effective name, source name, status badge, AI category, effective price, created date
     - Status badges with colors: pending_translation (gray), translating (blue pulse), translated (blue), in_review (yellow), approved (green), rejected (red), published (emerald)
     - Click row → navigates to `/admin/curation/{id}`
   - Add "Lancer traduction" button at top: calls server action that triggers batchTranslate(10)
   - Follow existing admin page patterns (same layout, typography, Tailwind classes as /admin/produits)

3. **Create `/admin/curation/[id]` page** (`src/app/admin/curation/[id]/page.tsx`):
   - Fetch single draft by ID using `getDraftById(params.id)`
   - If not found, redirect to /admin/curation

   **Layout — two columns:**

   Left column (60%): "Version curatee" (editable form)
   - Pre-filled with effective values (curated > AI > raw)
   - Editable fields: name, description (textarea), short description, category (select), price (number input in EUR, convert to/from cents), compare at price, images (URL list)
   - Save button: updates curated_* fields via updateDraft()

   Right column (40%): "Donnees sources" (read-only reference)
   - Raw product data: raw name, raw description, raw price, source URL (clickable link), source name
   - AI translation: AI name, AI description, AI short description, AI category, AI suggested price
   - Metadata: AI model, prompt version, translated at, status history

   **Action bar at bottom:**
   - If status is 'translated' or 'in_review':
     - "Approuver" button (green): sets status to 'approved', sets reviewed_by and reviewed_at
     - "Rejeter" button (red): opens rejection reason textarea, then sets status to 'rejected' with reason
     - "Retour en revue" button: sets status to 'in_review'
   - If status is 'approved':
     - "Publier" button (primary): calls publishDraft() server action (see Task 2)
     - "Retirer approbation" button: sets status back to 'in_review'
   - If status is 'rejected':
     - Shows rejection reason
     - "Remettre en revue" button: sets status to 'in_review'
   - If status is 'published':
     - Shows "Publie" badge with published_at date
     - Link to the published product: `/admin/produits/{published_product_id}`
   - "Retraduire" button (always visible except when published): resets AI fields and sets status to 'pending_translation'
   - "Supprimer" button (destructive): deletes draft with confirmation

   Use server actions (inline "use server" functions or imported from curation.ts) for all mutations.
   Follow existing admin detail page patterns (same as /admin/produits/[id]).
   All UI text in French.

IMPORTANT: Use the Nuage design system — Cormorant Garamond for headings, Inter for body, brand colors from tailwind config. Match existing admin page aesthetics.
IMPORTANT: Price inputs should display in EUR (e.g., 49.99) but store as cents (4999). Convert on save.
  </action>
  <verify>Run `npm run build`. Navigate to /admin/curation — page loads with stats and draft list. Navigate to /admin/curation/[id] — detail page shows two-column layout. All buttons render correctly.</verify>
  <done>Admin curation pages created. Stats dashboard shows draft counts by status. Draft list is filterable by status. Detail page has two-column layout with editable curated fields and read-only source data. Approve/reject/edit/publish actions work. Sidebar has Curation link.</done>
</task>

<task type="auto">
  <name>Task 2: Implement publish workflow and Vercel Cron automation</name>
  <files>src/lib/pipeline.ts, src/app/api/cron/curate/route.ts, vercel.json</files>
  <action>
1. **Create `src/lib/pipeline.ts`** — Pipeline orchestration:

   - `publishDraft(draftId: string)`: Server action that publishes an approved draft to the products table.
     1. Fetch draft by ID, verify status is 'approved'
     2. Generate slug from effective name (same slug generation as createProduct)
     3. Call createProduct() from products.ts with effective values:
        - name: getEffectiveName(draft)
        - description: getEffectiveDescription(draft)
        - shortDescription: getEffectiveShortDescription(draft)
        - category: getEffectiveCategory(draft) (required — reject if null)
        - price: getEffectivePrice(draft) (required — reject if null)
        - compareAtPrice: draft.curatedCompareAtPrice
        - images: getEffectiveImages(draft)
        - inStock: true (default for new products)
        - featured: false (admin can change later)
     4. On success: update draft status to 'published', set published_product_id and published_at
     5. Return the created product
     6. On error: throw with message (don't change draft status)

   - `processPipeline()`: Full pipeline cycle, meant to be called by cron:
     1. Call batchTranslate(5) from translate-product.ts — translate pending drafts
     2. Log results: "{X} translated, {Y} errors"
     3. Return summary object with counts

   - `createDraftFromScrapedProduct(scrapedData: { name: string; description?: string; priceText?: string; images?: string[]; sourceUrl?: string; sourceName?: string; scrapedProductId?: string })`:
     Helper that creates a new product_draft from scraped data with status 'pending_translation'. This is the bridge between Phase 12's scraper output and Phase 13's curation pipeline.

2. **Create `/api/cron/curate` route** (`src/app/api/cron/curate/route.ts`):

   ```typescript
   import { NextRequest, NextResponse } from 'next/server';
   import { processPipeline } from '@/lib/pipeline';
   ```

   - Export GET handler (Vercel Cron calls GET)
   - Verify the request is from Vercel Cron: check `Authorization` header matches `Bearer ${process.env.CRON_SECRET}`
   - If no CRON_SECRET env var set, allow the request (dev mode)
   - Call processPipeline()
   - Return JSON response with pipeline summary
   - Wrap in try/catch, return 500 on error with error message

   Add CRON_SECRET to .env.local:
   ```
   CRON_SECRET=your-cron-secret
   ```

3. **Create or update `vercel.json`** at project root:

   If vercel.json exists, add the crons config. If not, create:
   ```json
   {
     "crons": [
       {
         "path": "/api/cron/curate",
         "schedule": "0 */6 * * *"
       }
     ]
   }
   ```
   This runs every 6 hours. The cron translates pending scraped products.
   Admin can also trigger manually from the curation page (the "Lancer traduction" button from Task 1).

IMPORTANT: The cron route MUST verify the CRON_SECRET to prevent unauthorized triggers in production. In development (no CRON_SECRET), allow all requests.
IMPORTANT: publishDraft() must validate that effective category and price are set before publishing — a product cannot be published without these.
IMPORTANT: Use "use server" for pipeline.ts functions that are called from client components via server actions.
  </action>
  <verify>Run `npm run build`. Verify /api/cron/curate route exists (curl localhost:3000/api/cron/curate returns JSON). Verify vercel.json has crons config. Test publish flow: create a draft manually → translate → approve → publish → verify product appears in /admin/produits.</verify>
  <done>publishDraft() creates products from approved drafts. processPipeline() orchestrates batch translation. Cron route set up at /api/cron/curate with CRON_SECRET protection. Vercel Cron configured for 6-hour intervals. createDraftFromScrapedProduct() bridges Phase 12 output to Phase 13 pipeline.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] /admin sidebar shows "Curation" link
- [ ] /admin/curation page loads with stats and draft list
- [ ] /admin/curation/[id] shows two-column review layout
- [ ] Status filtering works on curation list page
- [ ] Approve/reject/edit actions update draft status
- [ ] Publish creates a real product in the products table
- [ ] /api/cron/curate returns valid JSON response
- [ ] vercel.json has cron configuration
- [ ] All UI text is in French
</verification>

<success_criteria>

- Admin curation pages fully functional with review queue workflow
- Two-column review layout: editable curated fields + read-only source data
- Approve/reject/publish actions work correctly
- Published drafts create real products in the products table
- Vercel Cron automation configured for 6-hour pipeline runs
- Pipeline bridge function ready for Phase 12 integration
- All admin UI follows existing design patterns and brand guidelines
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-ai-curation-automation/13-02-SUMMARY.md`
</output>
