---
phase: 13-ai-curation-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [supabase/migrations/product_drafts.sql, src/types/curation.ts, src/lib/curation.ts, src/lib/ai/translate-product.ts, src/lib/ai/prompts.ts, package.json, .env.local]
autonomous: true
---

<objective>
Create the AI translation engine and curation database schema. Build the service that takes raw scraped product data and produces brand-consistent premium French copy using Claude API.

Purpose: Foundation for the entire curation pipeline. The AI service and data layer must exist before the admin review queue or automation can be built.
Output: product_drafts table, TypeScript types, data access layer, working AI translation service.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/BRAND.md

@src/types/product.ts
@src/lib/products.ts
@src/lib/supabase/server.ts
@src/lib/supabase/admin.ts
@supabase/schema.sql
@src/app/admin/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create curation database schema, types, and data access layer</name>
  <files>supabase/migrations/product_drafts.sql, src/types/curation.ts, src/lib/curation.ts</files>
  <action>
1. Create `supabase/migrations/product_drafts.sql` with the product_drafts table:

```sql
CREATE TABLE product_drafts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  scraped_product_id UUID, -- References scraped_products(id) from Phase 12. No FK constraint yet since table may not exist.

  -- Raw data snapshot (copied from scraped product for self-containment)
  raw_name TEXT NOT NULL,
  raw_description TEXT,
  raw_price_text TEXT,
  raw_images TEXT[] DEFAULT '{}',
  raw_source_url TEXT,
  raw_source_name TEXT, -- e.g., 'aliexpress', 'wholesaler'

  -- AI-generated fields
  ai_name TEXT,
  ai_description TEXT,
  ai_short_description TEXT,
  ai_category TEXT CHECK (ai_category IS NULL OR ai_category IN ('chicha', 'bol', 'tuyau', 'charbon', 'accessoire')),
  ai_suggested_price INTEGER, -- in cents EUR

  -- Admin-curated fields (override AI when set)
  curated_name TEXT,
  curated_description TEXT,
  curated_short_description TEXT,
  curated_category TEXT CHECK (curated_category IS NULL OR curated_category IN ('chicha', 'bol', 'tuyau', 'charbon', 'accessoire')),
  curated_price INTEGER, -- in cents EUR
  curated_compare_at_price INTEGER,
  curated_images TEXT[] DEFAULT '{}',

  -- Pipeline status
  status TEXT NOT NULL DEFAULT 'pending_translation' CHECK (status IN (
    'pending_translation', 'translating', 'translated',
    'in_review', 'approved', 'rejected', 'published'
  )),

  -- AI metadata
  ai_model TEXT,
  ai_prompt_version TEXT DEFAULT 'v1',
  translation_error TEXT,

  -- Audit trail
  translated_at TIMESTAMPTZ,
  reviewed_by UUID REFERENCES profiles(id),
  reviewed_at TIMESTAMPTZ,
  rejection_reason TEXT,
  published_product_id UUID REFERENCES products(id),
  published_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Index for pipeline queries
CREATE INDEX idx_product_drafts_status ON product_drafts(status);
CREATE INDEX idx_product_drafts_scraped_id ON product_drafts(scraped_product_id);

-- RLS: admin only
ALTER TABLE product_drafts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admins can manage product drafts" ON product_drafts
  FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND profiles.is_admin = true)
  );

-- Updated_at trigger
CREATE TRIGGER product_drafts_updated_at
  BEFORE UPDATE ON product_drafts
  FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

2. Create `src/types/curation.ts`:

```typescript
export type DraftStatus =
  | 'pending_translation'
  | 'translating'
  | 'translated'
  | 'in_review'
  | 'approved'
  | 'rejected'
  | 'published';

export interface ProductDraft {
  id: string;
  scrapedProductId: string | null;

  // Raw data
  rawName: string;
  rawDescription: string | null;
  rawPriceText: string | null;
  rawImages: string[];
  rawSourceUrl: string | null;
  rawSourceName: string | null;

  // AI-generated
  aiName: string | null;
  aiDescription: string | null;
  aiShortDescription: string | null;
  aiCategory: string | null;
  aiSuggestedPrice: number | null;

  // Admin-curated (overrides AI)
  curatedName: string | null;
  curatedDescription: string | null;
  curatedShortDescription: string | null;
  curatedCategory: string | null;
  curatedPrice: number | null;
  curatedCompareAtPrice: number | null;
  curatedImages: string[];

  // Status
  status: DraftStatus;

  // AI metadata
  aiModel: string | null;
  aiPromptVersion: string | null;
  translationError: string | null;

  // Audit
  translatedAt: string | null;
  reviewedBy: string | null;
  reviewedAt: string | null;
  rejectionReason: string | null;
  publishedProductId: string | null;
  publishedAt: string | null;

  createdAt: string;
  updatedAt: string;
}

// Helper: get the "effective" value (curated override > AI > raw)
export function getEffectiveName(draft: ProductDraft): string {
  return draft.curatedName || draft.aiName || draft.rawName;
}

export function getEffectiveDescription(draft: ProductDraft): string {
  return draft.curatedDescription || draft.aiDescription || draft.rawDescription || '';
}

export function getEffectiveShortDescription(draft: ProductDraft): string {
  return draft.curatedShortDescription || draft.aiShortDescription || '';
}

export function getEffectiveCategory(draft: ProductDraft): string | null {
  return draft.curatedCategory || draft.aiCategory;
}

export function getEffectivePrice(draft: ProductDraft): number | null {
  return draft.curatedPrice ?? draft.aiSuggestedPrice;
}

export function getEffectiveImages(draft: ProductDraft): string[] {
  return draft.curatedImages.length > 0 ? draft.curatedImages : draft.rawImages;
}
```

3. Create `src/lib/curation.ts` — Server-side data access for product drafts:

```typescript
"use server";
```

Functions to implement (all use `createAdminClient()` since curation is admin-only):

- `getDraftsByStatus(status: DraftStatus | DraftStatus[])`: Query product_drafts filtered by status, ordered by created_at desc. Return ProductDraft[].
- `getDraftById(id: string)`: Single draft by ID. Return ProductDraft | null.
- `getAllDrafts()`: All drafts ordered by created_at desc. Return ProductDraft[].
- `createDraft(data: Partial<ProductDraft>)`: Insert new draft. Return ProductDraft.
- `updateDraft(id: string, data: Partial<ProductDraft>)`: Update draft fields. Return ProductDraft.
- `updateDraftStatus(id: string, status: DraftStatus, extra?: { rejectionReason?: string; reviewedBy?: string })`: Update status + audit fields (reviewed_at, etc.). Return ProductDraft.
- `getDraftStats()`: Count by status. Return `Record<DraftStatus, number>`.
- `deleteDraft(id: string)`: Hard delete.

Column mapping: Create `toDraft(row)` and `toDraftRow(data)` helpers to convert between snake_case DB columns and camelCase TypeScript properties. Follow the same pattern used in products.ts and orders.ts.

IMPORTANT: Mark all functions with "use server" directive. Use createAdminClient() for all operations (admin-only table).
  </action>
  <verify>Run `npm run build` to verify TypeScript compiles. Check that schema SQL is valid syntax (no syntax errors). Verify curation.ts exports all functions.</verify>
  <done>product_drafts table schema ready for deployment. ProductDraft type defined with effective-value helpers. Full CRUD data access layer in curation.ts with snake_case/camelCase mapping.</done>
</task>

<task type="auto">
  <name>Task 2: Build AI translation service with Anthropic Claude API</name>
  <files>src/lib/ai/translate-product.ts, src/lib/ai/prompts.ts, package.json, .env.local</files>
  <action>
1. Install the Anthropic SDK: `npm install @anthropic-ai/sdk`

2. Add `ANTHROPIC_API_KEY` to `.env.local` (append, don't overwrite existing vars):
   ```
   ANTHROPIC_API_KEY=your-anthropic-api-key
   ```

3. Create `src/lib/ai/prompts.ts` — Brand-consistent prompt templates:

Define a system prompt constant that captures the Nuage brand voice:

```
SYSTEM_PROMPT = `Tu es un redacteur publicitaire expert pour Nuage, une marque premium d'accessoires chicha et lifestyle en France.

Ton de la marque:
- Calme, confiant, jamais agressif commercialement
- Touche francaise naturelle, pas de familiarites
- Parle comme un ami connaisseur, pas comme un vendeur
- Evite le jargon, pas de "smoke shop" — c'est une marque lifestyle
- Met en valeur l'experience, la qualite, l'esthetique
- Vocabulaire: raffine, artisanal, detente, elegance, soin

Categories de produits: chicha, bol, tuyau, charbon, accessoire

Exemples de style (pour reference):
- "Une chicha d'exception au design cristallin. Le verre souffle a la main offre une qualite de fumee incomparable."
- "Bol en ceramique fait main par des artisans. Chaque piece est unique avec des variations subtiles de couleur."

Regles:
- Redige TOUJOURS en francais
- Description longue: 2-4 phrases, met en valeur qualite + experience + esthetique
- Description courte: 1 phrase, accroche evocatrice
- Nom du produit: court, elegant, en francais
- Suggere la categorie parmi: chicha, bol, tuyau, charbon, accessoire
- Suggere un prix en centimes EUR (ex: 4999 = 49.99 EUR), base sur le positionnement premium
- NE JAMAIS mentionner le prix source ou la provenance du produit`
```

Define a `buildTranslationPrompt(rawProduct)` function that creates the user message:

```
Voici un produit brut a rediger pour la marque Nuage:

Nom original: {rawName}
Description originale: {rawDescription}
Prix source: {rawPriceText}
Source: {rawSourceName}

Reponds en JSON strict avec cette structure:
{
  "name": "Nom produit en francais",
  "description": "Description longue (2-4 phrases)",
  "shortDescription": "Description courte (1 phrase)",
  "category": "chicha|bol|tuyau|charbon|accessoire",
  "suggestedPriceCents": 4999
}
```

4. Create `src/lib/ai/translate-product.ts` — Translation service:

```typescript
import Anthropic from '@anthropic-ai/sdk';
```

Functions:

- `translateProduct(rawProduct: { rawName: string; rawDescription: string | null; rawPriceText: string | null; rawSourceName: string | null })`:
  - Create Anthropic client: `new Anthropic()` (reads ANTHROPIC_API_KEY from env automatically)
  - Call `client.messages.create()` with:
    - model: `claude-sonnet-4-5-20250929` (good balance of quality/cost for translation)
    - max_tokens: 1024
    - system: SYSTEM_PROMPT
    - messages: [{ role: 'user', content: buildTranslationPrompt(rawProduct) }]
  - Parse the response: extract the text content block, parse as JSON
  - Validate JSON has required fields (name, description, shortDescription, category, suggestedPriceCents)
  - Validate category is one of the allowed values
  - Validate suggestedPriceCents is a positive integer
  - Return typed result: `{ name, description, shortDescription, category, suggestedPriceCents }`
  - On parse/validation error: throw with clear message (will be caught by caller)

- `translateAndSaveDraft(draftId: string)`:
  - Fetch draft by ID from curation.ts
  - Update status to 'translating'
  - Call translateProduct() with raw data
  - On success: Update draft with AI fields (aiName, aiDescription, aiShortDescription, aiCategory, aiSuggestedPrice), set status to 'translated', set translatedAt to now(), set aiModel to 'claude-sonnet-4-5-20250929'
  - On error: Update draft with translationError message, keep status as 'pending_translation' (can retry)
  - Return updated draft

- `batchTranslate(limit: number = 5)`:
  - Fetch drafts with status 'pending_translation', limited to `limit`
  - Process sequentially (avoid rate limits): call translateAndSaveDraft() for each
  - Add 1-second delay between calls (avoid rate limiting)
  - Return summary: { translated: number, errors: number, errorDetails: string[] }

IMPORTANT: Never expose the API key client-side. All AI calls happen server-side only.
IMPORTANT: Use claude-sonnet-4-5-20250929 (not opus) — translation doesn't need the most expensive model, and sonnet provides excellent French writing quality at lower cost.
IMPORTANT: Handle rate limiting gracefully — if Anthropic returns 429, log the error and skip (will retry on next batch run).
  </action>
  <verify>Run `npm run build` to verify TypeScript compiles. Verify `npm ls @anthropic-ai/sdk` shows package installed. Check that prompts.ts exports are importable from translate-product.ts.</verify>
  <done>Anthropic SDK installed. Brand-consistent French translation prompt defined. translateProduct() service working with JSON parsing and validation. batchTranslate() handles sequential processing with rate limit awareness. ANTHROPIC_API_KEY placeholder in .env.local.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm ls @anthropic-ai/sdk` shows package installed
- [ ] supabase/migrations/product_drafts.sql is valid SQL
- [ ] src/types/curation.ts exports ProductDraft type and effective-value helpers
- [ ] src/lib/curation.ts exports all CRUD functions
- [ ] src/lib/ai/prompts.ts exports system prompt and prompt builder
- [ ] src/lib/ai/translate-product.ts exports translateProduct, translateAndSaveDraft, batchTranslate
- [ ] .env.local has ANTHROPIC_API_KEY placeholder
</verification>

<success_criteria>

- product_drafts table schema created with proper status workflow, RLS, and indexes
- ProductDraft TypeScript type with effective-value helper functions
- Full data access layer for product drafts (CRUD + status updates + stats)
- Working AI translation service using Claude Sonnet with brand-consistent French prompts
- Batch translation with rate limit awareness
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-ai-curation-automation/13-01-SUMMARY.md`
</output>
