---
phase: 08-character-delight
plan: 08
type: execute
wave: 3
depends_on: ["08-01", "08-02", "08-03", "08-04", "08-05", "08-06", "08-07"]
files_modified:
  - src/components/ui/OptimizedImage.tsx
  - src/app/produits/[slug]/page.tsx
  - src/lib/analytics.ts
  - src/app/layout.tsx
  - next.config.ts
  - src/lib/seo.ts
autonomous: true
---

<objective>
Optimize site performance and SEO with image optimization, structured data, and analytics setup.

Purpose: Ensure fast loading, excellent Core Web Vitals, and maximum search engine visibility for organic traffic.
Output: Production-ready performance and SEO infrastructure matching enterprise standards.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/app/layout.tsx
@src/app/produits/[slug]/page.tsx
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement advanced image optimization with WebP, lazy loading, and blur placeholders</name>
  <files>src/components/ui/OptimizedImage.tsx, next.config.ts</files>
  <action>
Create production-grade image optimization system:

**Next.js Image configuration (next.config.ts):**
- Enable Image Optimization API
- Configure domains for external images (if any)
- Set image formats: ['image/webp', 'image/avif'] (modern formats first)
- Device sizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840]
- Image sizes: [16, 32, 48, 64, 96, 128, 256, 384]

**OptimizedImage component:**
- Wrapper around next/image with smart defaults
- Automatic WebP/AVIF conversion
- Lazy loading by default (loading="lazy")
- Blur placeholder generation (blurDataURL)
- Responsive sizes based on layout:
  - Hero: sizes="100vw"
  - Product grid: sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
  - Product detail: sizes="(max-width: 768px) 100vw, 50vw"
- Priority loading for above-fold images (hero, first product grid row)

**Blur placeholder generation:**
- Use plaiceholder library or built-in Next.js blur
- Generate low-quality image placeholders (LQIP)
- Base64 encoded, ~1-2KB per image
- Apply to product images for smooth loading

**Image component features:**
- Props: src, alt (required), priority (optional), objectFit, className
- Automatic srcset generation for responsive images
- Loading state: Blur-up effect as image loads
- Error state: Fallback to placeholder image if load fails
- TypeScript types for all props

**Replace existing Image usage:**
- ProductCard images → OptimizedImage with lazy loading
- Product detail gallery → OptimizedImage with priority for main image
- Hero section → OptimizedImage with priority
- Keep first 2 product cards priority, rest lazy

**Performance targets:**
- LCP (Largest Contentful Paint): < 2.5s
- CLS (Cumulative Layout Shift): < 0.1
- FID (First Input Delay): < 100ms
- Images served as WebP (30-50% smaller than JPEG)
  </action>
  <verify>npm run build succeeds, images load as WebP, blur placeholders show, lazy loading works, no CLS</verify>
  <done>Image optimization production-ready, WebP serving correctly, lazy loading implemented, blur placeholders smooth</done>
</task>

<task type="auto">
  <name>Task 2: Add structured data (JSON-LD) for products, organization, and breadcrumbs</name>
  <files>src/lib/seo.ts, src/app/produits/[slug]/page.tsx, src/app/layout.tsx</files>
  <action>
Implement comprehensive SEO structured data:

**SEO utility functions (src/lib/seo.ts):**

1. **Product schema (Schema.org Product):**
   - Generate JSON-LD for product pages
   - Fields: name, description, image, sku, brand (Nuage), price, currency (EUR), availability (InStock/OutOfStock)
   - AggregateRating: rating value, review count (from review system)
   - Offers: price, currency, availability, shipping details
   - Example:
   ```json
   {
     "@context": "https://schema.org",
     "@type": "Product",
     "name": "Foyer Kaloud",
     "image": ["https://..."],
     "description": "...",
     "sku": "product-1",
     "brand": { "@type": "Brand", "name": "Nuage" },
     "offers": {
       "@type": "Offer",
       "price": "29.90",
       "priceCurrency": "EUR",
       "availability": "https://schema.org/InStock"
     },
     "aggregateRating": {
       "@type": "AggregateRating",
       "ratingValue": "4.5",
       "reviewCount": "127"
     }
   }
   ```

2. **Organization schema (root layout):**
   - Business info: Nuage, e-commerce, France
   - Logo, URL, social media links (placeholder)
   - Contact info (placeholder for future)

3. **Breadcrumb schema (product pages):**
   - Navigation path: Home > Produits > [Category] > [Product]
   - Helps search engines understand site structure

**Integration:**
- Add JSON-LD script tags to page metadata
- Product pages: Include Product + Breadcrumb schema
- Root layout: Include Organization schema
- Use Next.js Metadata API for injection

**Meta tags enhancement:**
- Open Graph tags for social sharing:
  - og:title, og:description, og:image, og:url, og:type (product)
  - og:price:amount, og:price:currency
- Twitter Card tags:
  - twitter:card (summary_large_image)
  - twitter:title, twitter:description, twitter:image
- Canonical URLs for all pages (prevent duplicate content)

**Robots.txt and sitemap:**
- Generate sitemap.xml for all product pages
- Include in robots.txt: Sitemap location
- Allow all crawlers (User-agent: *)
- Disallow admin pages (/admin/*)
  </action>
  <verify>npm run build succeeds, view page source and verify JSON-LD present, test with Rich Results Test tool</verify>
  <done>Structured data complete for products and organization, Open Graph tags present, sitemap generated</done>
</task>

<task type="auto">
  <name>Task 3: Set up analytics tracking with event system and Core Web Vitals monitoring</name>
  <files>src/lib/analytics.ts, src/app/layout.tsx</files>
  <action>
Build analytics foundation for data-driven optimization:

**Analytics wrapper (src/lib/analytics.ts):**
- Create abstraction layer (supports GA4, Plausible, or custom)
- For MVP: Console logging + localStorage event storage
- Future: Easy swap to real analytics provider

**Event tracking functions:**
```typescript
// Page views
trackPageView(url: string)

// E-commerce events
trackProductView(productId: string, productName: string)
trackAddToCart(product: Product, quantity: number)
trackRemoveFromCart(productId: string)
trackPurchase(order: Order)
trackCheckoutStep(step: number, stepName: string)

// Engagement events
trackSearch(query: string, resultsCount: number)
trackFilterApplied(filterType: string, filterValue: string)
trackWishlistAdd(productId: string)
trackComparison(productIds: string[])
trackExitIntentShown()
trackExitIntentConverted()
```

**Core Web Vitals monitoring:**
- Use Next.js built-in reportWebVitals
- Track: LCP, FID, CLS, FCP, TTFB
- Log to console in dev, send to analytics in production
- Create /api/vitals endpoint for server-side collection (placeholder)

**Performance monitoring:**
- Track route change duration
- Monitor slow components (React Profiler)
- Image loading times
- API response times (server actions)

**Privacy compliance:**
- No cookies set without consent (GDPR)
- Anonymous tracking (no PII)
- Respect Do Not Track header
- Privacy policy placeholder link

**Integration:**
- Add analytics provider to root layout
- Trigger events at key interaction points:
  - Product page view (on mount)
  - Add to cart (on button click)
  - Checkout steps (on section complete)
  - Purchase (on order confirmation)
  - Search (on query submit)
- Use React Context for global analytics access

**Development aids:**
- Console.group() for readable event logs in dev
- Event validation (TypeScript types)
- Event batching (reduce network requests)
  </action>
  <verify>npm run build succeeds, events log in console, Core Web Vitals tracked, no errors in analytics calls</verify>
  <done>Analytics foundation ready, event tracking comprehensive, Core Web Vitals monitored, privacy-compliant</done>
</task>

<task type="auto">
  <name>Task 4: Optimize bundle size and implement code splitting for routes</name>
  <files>next.config.ts, src/app/layout.tsx</files>
  <action>
Reduce bundle size and improve initial load time:

**Next.js optimizations (next.config.ts):**
- Enable SWC minification (default in Next.js 15)
- Configure bundle analyzer (optional dev dependency)
- Tree shaking: Import only used components
- Remove unused dependencies

**Code splitting strategies:**
1. **Route-based splitting (automatic):**
   - Next.js splits by route automatically
   - Verify: Check .next/static/chunks/ for route chunks

2. **Component-based splitting (dynamic imports):**
   - Heavy components loaded on-demand:
     - ExitIntentModal (only loads on mouse exit)
     - ProductComparison (only on /comparaison)
     - Wishlist page (only on /favoris)
     - BottomSheet (mobile only)
   - Use next/dynamic with loading placeholder

3. **Library splitting:**
   - Framer Motion: Import only used components (motion.div, not entire library)
   - canvas-confetti: Dynamic import (only on order confirmation)
   - Chart libraries (if added): Lazy load

**Implementation:**
```typescript
// Example: ExitIntentModal
const ExitIntentModal = dynamic(
  () => import('@/components/marketing/ExitIntentModal'),
  { ssr: false, loading: () => <div>Loading...</div> }
)

// Example: Confetti (only on order confirmation)
const confetti = await import('canvas-confetti')
confetti.default({ ... })
```

**Font optimization:**
- Use next/font for Cormorant Garamond and Inter
- Subset fonts to Latin characters only (reduce size)
- Preload critical fonts
- font-display: swap (avoid FOIT)

**CSS optimization:**
- Tailwind purge: Remove unused classes (already configured)
- Critical CSS inline (automatic with Next.js)
- No duplicate CSS imports

**Performance budget:**
- First Load JS: < 200KB (Next.js default target)
- Page-specific JS: < 50KB per route
- Images: WebP, lazy loaded, compressed
- Fonts: Subsetted, <100KB total

**Verification:**
- Run: npm run build
- Check build output for bundle sizes
- Lighthouse score: Performance > 90
  </action>
  <verify>npm run build succeeds, bundle analyzer shows reasonable sizes, dynamic imports working, Lighthouse >90</verify>
  <done>Bundle optimized, code splitting implemented, fonts optimized, performance budget met, Lighthouse scores excellent</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no errors
- [ ] Images serve as WebP with blur placeholders
- [ ] Lazy loading prevents loading off-screen images
- [ ] No Cumulative Layout Shift (CLS < 0.1)
- [ ] JSON-LD structured data present on product pages
- [ ] Open Graph and Twitter Card meta tags complete
- [ ] Sitemap.xml generated and accessible
- [ ] Analytics events log correctly (console in dev)
- [ ] Core Web Vitals tracked and reported
- [ ] Bundle sizes within budget (First Load < 200KB)
- [ ] Dynamic imports reduce initial load
- [ ] Lighthouse Performance score > 90
- [ ] Mobile performance excellent (4G simulation)
</verification>

<success_criteria>

- All tasks completed
- Image optimization production-ready (WebP, lazy load, blur)
- SEO foundation comprehensive (structured data, meta tags, sitemap)
- Analytics system capturing key events
- Core Web Vitals monitored and optimized
- Bundle size optimized with code splitting
- Performance budget met
- Lighthouse scores: Performance >90, SEO >95, Accessibility >90
- Site ready for production launch
  </success_criteria>

<output>
After completion, create `.planning/phases/08-character-delight/08-08-SUMMARY.md`
</output>
