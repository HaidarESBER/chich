---
phase: 27-email-marketing-retention
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migration-newsletter.sql
  - src/types/newsletter.ts
  - src/lib/newsletter.ts
  - src/lib/email.ts
  - src/app/api/newsletter/subscribe/route.ts
  - src/app/api/newsletter/unsubscribe/route.ts
  - src/components/newsletter/NewsletterForm.tsx
  - src/components/layout/Footer.tsx
  - src/emails/WelcomeEmail.tsx
  - src/app/desabonnement/page.tsx
autonomous: true
domain: next-js
---

<objective>
Create the newsletter subscription system with signup, welcome email, and one-click unsubscribe.

Purpose: Build the email collection foundation for marketing campaigns — newsletter subscribers table, footer signup form, branded welcome email, and GDPR-compliant unsubscribe flow with signed tokens.
Output: Working newsletter signup in footer, welcome email on subscribe, unsubscribe page with token verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/email.ts
@src/emails/OrderConfirmationEmail.tsx
@src/components/layout/Footer.tsx
@src/types/user.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create newsletter subscribers table, types, and API endpoints</name>
  <files>supabase/migration-newsletter.sql, src/types/newsletter.ts, src/lib/newsletter.ts, src/app/api/newsletter/subscribe/route.ts, src/app/api/newsletter/unsubscribe/route.ts, src/lib/email.ts</files>
  <action>
  1. Create `supabase/migration-newsletter.sql`:
     - newsletter_subscribers table:
       - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
       - email TEXT UNIQUE NOT NULL
       - status TEXT CHECK ('active', 'unsubscribed') DEFAULT 'active'
       - source TEXT DEFAULT 'footer' (where they signed up: 'footer', 'popup', 'checkout')
       - subscribed_at TIMESTAMPTZ DEFAULT now()
       - unsubscribed_at TIMESTAMPTZ
       - created_at TIMESTAMPTZ DEFAULT now()
     - RLS: No public access. Admin can read all. Subscribe/unsubscribe via API routes using service role.
     - Index on email for fast lookup
     - Index on status for active subscriber queries

  2. Create `src/types/newsletter.ts`:
     - NewsletterSubscriber interface (camelCase matching table)
     - SubscribeResult type: { success: boolean, alreadySubscribed?: boolean, error?: string }

  3. Create `src/lib/newsletter.ts` ("use server"):
     - Uses createAdminClient pattern
     - subscribe(email: string, source?: string): insert or reactivate if previously unsubscribed
     - unsubscribe(email: string): set status='unsubscribed', unsubscribed_at=now()
     - getSubscribers(status?: 'active' | 'unsubscribed'): list subscribers
     - getSubscriberCount(): count active subscribers
     - isSubscribed(email: string): check if actively subscribed
     - generateUnsubscribeToken(email: string): create HMAC-SHA256 signed token using CRON_SECRET as key (reuse existing secret, no new env var). Token = base64url(email + ':' + hmac(email))
     - verifyUnsubscribeToken(token: string): verify and extract email from token. Returns email if valid, null if invalid.

  4. Create `src/app/api/newsletter/subscribe/route.ts`:
     - POST endpoint accepting { email: string, source?: string }
     - Validate email format (basic regex)
     - Call subscribe() from lib/newsletter
     - If new subscriber, send welcome email via sendWelcomeEmail()
     - Return { success: true } or { error: string }
     - Rate limit: check if email was recently subscribed (prevent spam)

  5. Create `src/app/api/newsletter/unsubscribe/route.ts`:
     - GET endpoint accepting ?token=xxx query param (for one-click from email links)
     - Verify token via verifyUnsubscribeToken()
     - If valid: call unsubscribe(email), redirect to /desabonnement?success=true
     - If invalid: redirect to /desabonnement?error=invalid
     - Also handle POST with { email: string } for manual unsubscribe (from unsubscribe page)

  6. Add to `src/lib/email.ts`:
     - Import WelcomeEmail component
     - Add sendWelcomeEmail(email: string, unsubscribeUrl: string) function following existing pattern (fire-and-forget, FROM_ADDRESS, getResendClient)
     - Add helper: getUnsubscribeUrl(email: string) that generates full URL with signed token: `${SITE_URL}/api/newsletter/unsubscribe?token=${generateUnsubscribeToken(email)}`
     - This helper will be reused by all marketing emails in Plan 02
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit. API routes respond to requests.</verify>
  <done>Newsletter subscribers table ready, subscribe/unsubscribe API endpoints work, signed token unsubscribe system functional, welcome email function ready</done>
</task>

<task type="auto">
  <name>Task 2: Create footer newsletter form, welcome email template, and unsubscribe page</name>
  <files>src/components/newsletter/NewsletterForm.tsx, src/components/layout/Footer.tsx, src/emails/WelcomeEmail.tsx, src/app/desabonnement/page.tsx</files>
  <action>
  1. Create `src/emails/WelcomeEmail.tsx`:
     - React Email template matching existing brand style (same colors: #2C2C2C primary, #D4A5A5 accent, #F7F5F3 background)
     - Header: "Nuage" + "L'Art de la Detente" tagline (same as OrderConfirmationEmail)
     - Body: "Bienvenue dans l'univers Nuage !" heading
     - Text: Thank the subscriber, mention they'll receive exclusive offers, new products, and hookah culture content
     - CTA button: "Decouvrir nos produits" linking to /produits (accent color button)
     - Footer: Unsubscribe link using the unsubscribeUrl prop (GDPR required)
     - Props: { unsubscribeUrl: string }
     - Copyright: same pattern as other emails

  2. Create `src/components/newsletter/NewsletterForm.tsx`:
     - Client component ("use client")
     - Compact inline form: email input + "S'inscrire" button on same row
     - Props: variant?: 'footer' | 'standalone' (footer = dark bg text, standalone = light bg)
     - States: idle, loading, success, error
     - On submit: POST to /api/newsletter/subscribe with { email, source: 'footer' }
     - Success: show "Merci ! Verifiez votre boite mail" with checkmark icon
     - Error: show error message from API
     - Already subscribed: show "Vous etes deja inscrit(e) !" (friendly, not error)
     - Auto-reset to idle after 5 seconds on success
     - Input: placeholder "Votre email", type="email", required
     - Footer variant: text-background, bg-transparent border, button with accent color
     - Framer Motion: subtle fade transition between states

  3. Modify `src/components/layout/Footer.tsx`:
     - Add newsletter section between the brand column and the copyright bar
     - Full-width section with border-t border-background/20 above it
     - Centered layout: "Restez informe" heading + brief text + NewsletterForm (variant="footer")
     - Text: "Recevez nos offres exclusives et nouveautes directement dans votre boite mail."
     - Responsive: stacked on mobile, inline on desktop

  4. Create `src/app/desabonnement/page.tsx`:
     - Server component (reads searchParams)
     - If ?success=true: show "Desabonnement confirme" message with checkmark
     - If ?error=invalid: show "Lien invalide" with message to contact support
     - Default (no params): show manual unsubscribe form (email input + button)
     - Manual form: POST to /api/newsletter/unsubscribe with { email }
     - Clean page layout matching site design (Container, brand colors)
     - Include link back to homepage
     - French copy throughout
  </action>
  <verify>Run `npm run build` - all pages compile. Footer shows newsletter form. /desabonnement page renders.</verify>
  <done>Newsletter form in footer collects emails, welcome email sent on subscribe, unsubscribe page works for both token-based and manual unsubscription</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Newsletter migration SQL is valid
- [ ] Subscribe API creates subscriber and sends welcome email
- [ ] Unsubscribe API verifies token and deactivates subscriber
- [ ] Footer shows newsletter form with success/error states
- [ ] /desabonnement page handles both token and manual unsubscribe
- [ ] Welcome email uses brand styling consistent with other emails
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Newsletter signup works end-to-end (subscribe → welcome email → unsubscribe)
- Signed token system prevents unauthorized unsubscription
- GDPR-compliant unsubscribe link in welcome email
</success_criteria>

<output>
After completion, create `.planning/phases/27-email-marketing-retention/27-01-SUMMARY.md`
</output>
