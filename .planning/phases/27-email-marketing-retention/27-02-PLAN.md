---
phase: 27-email-marketing-retention
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/emails/AbandonedCartEmail.tsx
  - src/emails/WinBackEmail.tsx
  - src/lib/email.ts
  - src/lib/email-campaigns.ts
  - src/app/api/webhooks/stripe/route.ts
  - src/app/api/cron/email-campaigns/route.ts
  - vercel.json
autonomous: true
domain: next-js
---

<objective>
Implement abandoned cart recovery emails and automated re-engagement campaigns.

Purpose: Recover lost revenue from abandoned checkouts with targeted recovery emails, and re-engage inactive customers with personalized win-back campaigns. Both use the unsubscribe infrastructure from Plan 01.
Output: Abandoned cart email triggered on Stripe session expiry, re-engagement cron job with win-back emails for inactive customers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-email-marketing-retention/27-01-SUMMARY.md

@src/app/api/webhooks/stripe/route.ts
@src/lib/email.ts
@src/lib/newsletter.ts
@src/types/order.ts
@vercel.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create abandoned cart email and trigger from Stripe webhook</name>
  <files>src/emails/AbandonedCartEmail.tsx, src/lib/email.ts, src/app/api/webhooks/stripe/route.ts</files>
  <action>
  1. Create `src/emails/AbandonedCartEmail.tsx`:
     - React Email template matching brand style (same colors as OrderConfirmationEmail)
     - Header: "Nuage" + tagline
     - Subject line: "Vous avez oublie quelque chose..."
     - Body heading: "Votre panier vous attend"
     - Text: Friendly reminder that items are still available, encourage completing purchase
     - Show order items list (product name, quantity, price) from the cancelled order data
     - Show order subtotal
     - CTA button: "Reprendre mes achats" linking to /produits (not /panier since cart is localStorage - items may be gone). Use accent color (#D4A5A5) button.
     - Optional: If a promotion code exists (BIENVENUE10), include a small "Utilisez le code BIENVENUE10 pour 10% de remise" incentive
     - Footer: Unsubscribe link using unsubscribeUrl prop (from Plan 01's getUnsubscribeUrl)
     - Props: { order: Order, unsubscribeUrl: string }

  2. Add to `src/lib/email.ts`:
     - Import AbandonedCartEmail
     - Add sendAbandonedCartEmail(order: Order):
       - Check user hasn't unsubscribed (check newsletter_subscribers status or profiles email_order_updates preference)
       - Generate unsubscribe URL via getUnsubscribeUrl(order.shippingAddress.email)
       - Send via Resend with subject "Vous avez oublie quelque chose, {firstName} ?"
       - Fire-and-forget pattern (same as other email functions)
       - Use "Nuage <bonjour@nuage.fr>" as from address (marketing vs transactional distinction)

  3. Modify `src/app/api/webhooks/stripe/route.ts`:
     - In the `checkout.session.expired` case, after marking order as cancelled:
     - Fetch the full order data with items (same pattern as checkout.session.completed)
     - Map to Order type via mapToOrderType
     - Call sendAbandonedCartEmail(mappedOrder) with fire-and-forget (.catch for error logging)
     - Only send if order has a valid email (shippingAddress.email exists)
     - Add a 1-hour delay consideration: Instead of sending immediately on session expiry (24h after checkout start), send the email immediately since Stripe sessions expire after 24h by default - this is already a natural delay
  </action>
  <verify>Run `npm run build` - webhook handler compiles. AbandonedCartEmail template renders.</verify>
  <done>Abandoned cart email sent automatically when Stripe checkout session expires. Email shows order items, friendly copy, CTA to return to store, and unsubscribe link.</done>
</task>

<task type="auto">
  <name>Task 2: Create re-engagement cron job and win-back email</name>
  <files>src/emails/WinBackEmail.tsx, src/lib/email-campaigns.ts, src/app/api/cron/email-campaigns/route.ts, src/lib/email.ts, vercel.json</files>
  <action>
  1. Create `src/emails/WinBackEmail.tsx`:
     - React Email template matching brand style
     - Subject: "Vous nous manquez, {firstName} !"
     - Body heading: "Cela fait un moment..."
     - Text: Personalized re-engagement message mentioning it's been a while since their last visit
     - Show 2-3 featured/new products as recommendations (product name + price, no images - keep email lightweight)
     - CTA button: "Decouvrir les nouveautes" linking to /produits
     - Optional incentive: "Code exclusif RETOUR15 pour 15% de remise sur votre prochaine commande" (only if such promo exists)
     - Footer: Unsubscribe link via unsubscribeUrl prop
     - Props: { firstName: string, products: Array<{name: string, price: number}>, unsubscribeUrl: string }

  2. Create `src/lib/email-campaigns.ts` ("use server"):
     - Uses createAdminClient pattern
     - getInactiveCustomers(daysSinceLastOrder: number): Query orders table grouped by user_email, find customers whose latest order is older than daysSinceLastOrder days, AND who have not unsubscribed (check newsletter_subscribers status != 'unsubscribed'). Return array of { email, firstName, lastName, lastOrderDate }.
     - getRecentProducts(limit: number): Fetch latest published products for email recommendations
     - runWinBackCampaign():
       a. Get inactive customers (30+ days since last order)
       b. Get 3 recent products for recommendations
       c. For each customer: send win-back email via sendWinBackEmail()
       d. Rate limit: max 50 emails per cron run (Resend free tier consideration)
       e. Log: count sent, count skipped (already unsubscribed), count errors
       f. Return campaign summary
     - runAbandonedCartFollowUp(): (future extension point - for now just a stub that returns)

  3. Add to `src/lib/email.ts`:
     - Import WinBackEmail
     - Add sendWinBackEmail(email: string, firstName: string, products: Array<{name: string, price: number}>):
       - Generate unsubscribe URL via getUnsubscribeUrl(email)
       - Send via Resend with personalized subject
       - Fire-and-forget pattern
       - From: "Nuage <bonjour@nuage.fr>"

  4. Create `src/app/api/cron/email-campaigns/route.ts`:
     - GET endpoint (Vercel Cron uses GET)
     - Authenticate with Authorization: Bearer CRON_SECRET (same pattern as existing crons)
     - Call runWinBackCampaign()
     - Return summary JSON with counts
     - Error handling: catch and log, return 200 to prevent Vercel cron retries

  5. Modify `vercel.json`:
     - Add email campaigns cron: { "path": "/api/cron/email-campaigns", "schedule": "0 10 * * 1" }
     - Schedule: Every Monday at 10:00 AM (good time for marketing emails, weekly frequency)
     - This runs the win-back campaign once per week
  </action>
  <verify>Run `npm run build` - all files compile. Cron route responds to authenticated GET request. vercel.json is valid JSON.</verify>
  <done>Win-back emails sent weekly to inactive customers (30+ days), abandoned cart emails triggered on Stripe session expiry, email campaigns cron registered in Vercel, all emails include unsubscribe links</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Abandoned cart email triggers on Stripe session expiry
- [ ] Win-back email template renders with product recommendations
- [ ] Cron endpoint authenticates and runs campaign
- [ ] vercel.json is valid with new cron entry
- [ ] All marketing emails include unsubscribe links
- [ ] Rate limiting prevents excessive email sending
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Abandoned cart recovery: automatic email on Stripe session expiry with order items
- Re-engagement: weekly cron sends win-back emails to 30+ day inactive customers
- All marketing emails respect unsubscribe preferences
- Email sending uses fire-and-forget pattern (non-blocking)
</success_criteria>

<output>
After completion, create `.planning/phases/27-email-marketing-retention/27-02-SUMMARY.md`
</output>
