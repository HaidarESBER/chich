---
phase: 20-analytics-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [supabase/migrations/analytics_events.sql, src/app/api/analytics/track/route.ts, src/lib/analytics.ts, src/types/analytics.ts]
autonomous: true
---

<objective>
Create server-side event tracking infrastructure to persist analytics events in Supabase for admin dashboards and business intelligence.

Purpose: Move from localStorage-only event storage to database persistence, enabling historical analysis, admin dashboards, and business insights.
Output: Analytics events table, server-side tracking API, and integrated client-side event forwarding.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing analytics implementation
@src/lib/analytics.ts
@src/types/analytics.ts

# Database patterns from prior phases
# Phase 09-01: Established Supabase patterns (server client, RLS policies)
# Phase 18-02: Browse history tracking (similar event-based tracking, 90-day retention)

# Current state:
# - Client-side analytics.ts tracks events to localStorage + external providers (GA4, Meta, TikTok)
# - browse_history table tracks product views for authenticated users
# - No centralized event storage for admin analytics
# - No historical event data beyond localStorage (100 events max, client-only)

# Goal for this plan:
# - Create analytics_events table for all event types (page views, cart actions, searches, etc.)
# - Build POST /api/analytics/track endpoint for server-side event persistence
# - Integrate client-side analytics.ts to forward events to server
# - Time-series optimization for efficient querying
# - Privacy-compliant (anonymous session IDs, GDPR-ready)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics events table with time-series optimization</name>
  <files>supabase/migrations/analytics_events.sql, src/types/analytics.ts</files>
  <action>
Create Supabase migration for analytics_events table:
- id (uuid, primary key, default gen_random_uuid())
- event_type (text, not null) - e.g., 'page_view', 'add_to_cart', 'search'
- event_data (jsonb) - flexible event payload
- session_id (uuid) - anonymous session identifier (not user_id for privacy)
- user_id (uuid, nullable, foreign key to auth.users) - only for authenticated events
- created_at (timestamptz, default now(), not null)
- url (text) - page URL where event occurred
- referrer (text, nullable) - HTTP referrer
- user_agent (text, nullable) - browser user agent

Create indexes for common queries:
- idx_analytics_events_type_time: (event_type, created_at DESC)
- idx_analytics_events_session: (session_id, created_at DESC)
- idx_analytics_events_user: (user_id, created_at DESC) WHERE user_id IS NOT NULL

Add RLS policies:
- No public access (disable all public reads/writes)
- Admin analytics access: SELECT for users WHERE profiles.is_admin = true
- Service role for writes (API will use service role to insert events)

Add auto-cleanup trigger (similar to browse_history pattern):
- Delete events older than 90 days
- Scheduled daily via pg_cron or manual cleanup

Privacy considerations:
- Use session_id (anonymous) instead of always requiring user_id
- No PII in event_data (sanitize on client before sending)
- Respect DNT header (handled in client-side analytics.ts)

Extend src/types/analytics.ts:
- Add ServerAnalyticsEvent interface matching table schema
- Add EventTrackingOptions interface for API payload
  </action>
  <verify>Migration runs successfully: npx supabase migration up, check table exists with correct columns and indexes</verify>
  <done>analytics_events table created with time-series indexes, RLS policies for admin access, auto-cleanup trigger, and TypeScript types defined</done>
</task>

<task type="auto">
  <name>Task 2: Create server-side event tracking API</name>
  <files>src/app/api/analytics/track/route.ts</files>
  <action>
Create POST /api/analytics/track endpoint:
- Accept payload: { eventType: string, eventData: object, sessionId: string, url: string, referrer?: string }
- Use createAdminClient (service role) to bypass RLS and insert events
- Extract user_id from session if authenticated (optional, for signed-in users)
- Extract user_agent from request headers
- Insert into analytics_events table
- Return 200 with empty body on success, 500 on error
- NEVER throw errors (fire-and-forget pattern like browse tracking)

Rate limiting considerations:
- Add simple in-memory rate limit (max 100 events per session per minute)
- Use Map<sessionId, { count: number, resetAt: number }> for tracking
- Reset counter every minute
- Silently drop events if rate limit exceeded (no error response)

Privacy compliance:
- Respect DNT header: if request has 'DNT: 1', return 200 but don't insert event
- Sanitize event_data: remove any PII fields (email, phone, full name)
- Use anonymous session_id from client

Error handling:
- Try/catch around database insert
- Log errors to console but return 200 (never break client experience)
- Fire-and-forget pattern: client doesn't wait for response

Why fire-and-forget:
- Analytics should never block user experience
- Failed tracking is acceptable (better than failed page load)
- Similar pattern to Phase 18-02 browse tracking
  </action>
  <verify>curl -X POST /api/analytics/track with test payload returns 200, event appears in analytics_events table</verify>
  <done>API endpoint accepts events, inserts to database with rate limiting, privacy compliance, and fire-and-forget error handling</done>
</task>

<task type="auto">
  <name>Task 3: Integrate client-side analytics to forward events to server</name>
  <files>src/lib/analytics.ts</files>
  <action>
Extend existing trackEvent() function in src/lib/analytics.ts:
- After logging to console and localStorage (keep existing behavior)
- After sending to external providers (GA4, Meta, TikTok - keep existing)
- Add server-side persistence: POST to /api/analytics/track

Implementation:
- Generate anonymous sessionId on first page load (store in sessionStorage, not localStorage)
  - Use crypto.randomUUID() for session ID
  - sessionStorage key: 'nuage_session_id'
  - Persists for browser tab lifetime, resets on tab close (privacy-friendly)
- Add sendToServer() helper function:
  - POST to /api/analytics/track with fetch
  - Include: eventType, eventData, sessionId, url (window.location.href), referrer (document.referrer)
  - Use keepalive: true flag (ensures event sent even on page unload)
  - No error handling (fire-and-forget)
  - Don't await response (async, non-blocking)
- Call sendToServer() from trackEvent() after existing logic

Why sessionStorage vs localStorage:
- sessionStorage resets on tab close (better privacy)
- Each tab = new session (more accurate session tracking)
- Complies with GDPR (anonymous, short-lived identifier)

Preserve existing behavior:
- Keep all existing localStorage storage (for debugging)
- Keep all existing provider integrations (GA4, Meta, TikTok, Clarity)
- Keep DNT header check (don't send to server if DNT: 1)

Add helper to get/create session ID:
- function getOrCreateSessionId(): string
- Check sessionStorage for existing ID
- If none, generate new UUID and store
- Return session ID
  </action>
  <verify>Trigger analytics event (e.g., add to cart), check browser DevTools Network tab shows POST to /api/analytics/track, verify event in analytics_events table</verify>
  <done>Client-side analytics forwards all events to server for persistence while maintaining existing localStorage and provider integrations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] Migration runs successfully and table schema is correct
- [ ] API endpoint returns 200 and inserts events to database
- [ ] Client-side events (page view, add to cart, search) appear in analytics_events table
- [ ] Session ID persists in sessionStorage and is included in all events
- [ ] Rate limiting prevents spam (test with 101 rapid events)
- [ ] DNT header is respected (no events inserted if DNT: 1)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- analytics_events table created with time-series indexes and RLS policies
- POST /api/analytics/track endpoint functional with rate limiting and privacy compliance
- Client-side analytics forwards events to server while preserving existing behavior
- Events appear in database with correct session tracking
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/20-analytics-foundation/20-01-SUMMARY.md`
</output>
