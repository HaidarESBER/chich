---
phase: 20-analytics-foundation
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified: [supabase/migrations/daily_metrics.sql, src/lib/analytics-server.ts, src/app/api/analytics/aggregate/route.ts]
autonomous: true
---

<objective>
Create metrics aggregation system to pre-compute daily analytics rollups for fast admin dashboard queries.

Purpose: Avoid expensive real-time queries on analytics_events table (millions of rows), pre-aggregate metrics daily for instant dashboard loads.
Output: Daily metrics table, aggregation functions, and admin query helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-analytics-foundation/20-01-SUMMARY.md

# Dependencies:
# - Plan 20-01 created analytics_events table with time-series data
# - Events are now persisting to database from client-side tracking

# Current state after 20-01:
# - analytics_events table stores all events with timestamps
# - Raw event data ready for aggregation
# - No pre-computed metrics (dashboards would need to scan millions of rows)

# Goal for this plan:
# - Create daily_metrics table for pre-aggregated stats
# - Build aggregation logic to compute daily rollups
# - Create admin query helpers for common analytics queries
# - Enable fast dashboard loads (Phase 21 will consume these metrics)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create daily metrics table with common KPIs</name>
  <files>supabase/migrations/daily_metrics.sql</files>
  <action>
Create Supabase migration for daily_metrics table:
- id (uuid, primary key, default gen_random_uuid())
- date (date, not null, unique) - the day being measured
- total_events (integer, default 0) - total events that day
- unique_sessions (integer, default 0) - count of distinct session_ids
- unique_users (integer, default 0) - count of distinct user_ids (authenticated only)
- page_views (integer, default 0) - count of page_view events
- product_views (integer, default 0) - count of product_view events
- add_to_cart_count (integer, default 0) - count of add_to_cart events
- purchases (integer, default 0) - count of purchase events
- total_revenue (integer, default 0) - sum of purchase amounts in cents
- search_queries (integer, default 0) - count of search events
- avg_session_duration (integer, default 0) - average session length in seconds (placeholder for future)
- bounce_rate (decimal, default 0) - percentage of single-page sessions (placeholder for future)
- created_at (timestamptz, default now())
- updated_at (timestamptz, default now())

Create unique index:
- idx_daily_metrics_date: UNIQUE(date) - one row per day

Add RLS policies:
- No public access
- Admin read access: SELECT for users WHERE profiles.is_admin = true
- Service role for writes (aggregation cron will use service role)

Create upsert function for idempotent aggregation:
- Function: aggregate_daily_metrics(target_date date)
- Deletes existing row for target_date (if exists)
- Inserts new row with aggregated stats from analytics_events
- Uses COUNT(DISTINCT session_id), COUNT(DISTINCT user_id), etc.
- Filters analytics_events WHERE DATE(created_at) = target_date
- Returns void

Why upsert pattern:
- Re-running aggregation for same day updates metrics (idempotent)
- Allows backfill of historical data
- Safe for cron retries
  </action>
  <verify>Migration runs successfully, daily_metrics table created, aggregate_daily_metrics() function callable</verify>
  <done>daily_metrics table created with KPI columns, RLS policies, and upsert function for aggregation</done>
</task>

<task type="auto">
  <name>Task 2: Create admin analytics query helpers</name>
  <files>src/lib/analytics-server.ts</files>
  <action>
Create server-side analytics helper library (DO NOT confuse with client-side src/lib/analytics.ts):
- File: src/lib/analytics-server.ts (new file)
- Use createAdminClient() from src/lib/supabase/server.ts for admin access

Export helper functions:

1. getDailyMetrics(startDate: Date, endDate: Date): Promise<DailyMetrics[]>
   - Query daily_metrics table for date range
   - ORDER BY date ASC
   - Return array of metrics objects
   - Use for dashboard charts (Phase 21)

2. getMetricsSummary(days: number = 30): Promise<MetricsSummary>
   - Aggregate last N days from daily_metrics
   - Return totals: { totalSessions, totalUsers, totalRevenue, totalPurchases, avgRevenuePerUser, conversionRate }
   - Conversion rate = (purchases / unique_sessions) * 100
   - Use for dashboard summary cards (Phase 21)

3. getTopEvents(eventType: string, limit: number = 10): Promise<TopEvent[]>
   - Query analytics_events table for specific event_type
   - Group by event_data.productId or event_data.query (depending on event type)
   - Count occurrences
   - ORDER BY count DESC
   - LIMIT to top N
   - Use for "Most Viewed Products", "Top Searches", etc.

4. getRealtimeEvents(limit: number = 50): Promise<AnalyticsEvent[]>
   - Query analytics_events table for most recent events
   - ORDER BY created_at DESC
   - LIMIT to N
   - Use for real-time activity feed in admin dashboard (Phase 21)

5. triggerDailyAggregation(date?: Date): Promise<void>
   - Call aggregate_daily_metrics() function for given date (default: yesterday)
   - Use for manual backfill or testing
   - Will be called by cron in production

TypeScript types:
- Export DailyMetrics interface (matches daily_metrics table)
- Export MetricsSummary interface (aggregated summary)
- Export TopEvent interface (event type with count)
- Import AnalyticsEvent from src/types/analytics.ts

Error handling:
- All functions return Promise<T>
- Throw errors on database failures (admin-only, safe to surface errors)
- Add try/catch in Phase 21 dashboard pages

Performance considerations:
- getDailyMetrics queries pre-aggregated table (fast)
- getMetricsSummary queries pre-aggregated table (fast)
- getTopEvents queries raw events but with indexes (acceptable for admin)
- getRealtimeEvents queries raw events with LIMIT (acceptable for admin)
  </action>
  <verify>Import functions in test script, call getDailyMetrics() and getMetricsSummary(), verify they return data without errors</verify>
  <done>Server-side analytics helpers created for querying metrics, ready for admin dashboard integration in Phase 21</done>
</task>

<task type="auto">
  <name>Task 3: Create aggregation API endpoint for manual/cron triggering</name>
  <files>src/app/api/analytics/aggregate/route.ts</files>
  <action>
Create POST /api/analytics/aggregate endpoint for triggering daily aggregation:
- Accept optional payload: { date?: string } - date in YYYY-MM-DD format, defaults to yesterday
- Check authentication: require admin user (profiles.is_admin = true)
- Parse date from payload or default to yesterday
- Call triggerDailyAggregation(date) from src/lib/analytics-server.ts
- Return 200 with { success: true, date, metrics } on success
- Return 401 if not admin
- Return 500 on database errors

Authentication check:
- Use createClient() from src/lib/supabase/server.ts to get session
- Query profiles table for current user's is_admin flag
- Reject if not admin

Why manual endpoint:
- Allows admin to backfill historical data (call with past dates)
- Allows testing aggregation logic before setting up cron
- Phase 21 admin dashboard can trigger on-demand
- Future: Set up Vercel Cron to call this endpoint daily (not in this plan)

Cron setup (future work, document for Phase 21):
- Add to vercel.json: { "crons": [{ "path": "/api/analytics/aggregate", "schedule": "0 1 * * *" }] }
- Schedule: daily at 1 AM UTC (after midnight, ensures full day's data)
- Requires CRON_SECRET env var for authentication (similar to Phase 13-02 pattern)

For now:
- Just create the endpoint with manual triggering
- Admin can call via dashboard button (Phase 21)
- Cron setup deferred to Phase 21 or later
  </action>
  <verify>curl -X POST /api/analytics/aggregate as admin returns 200, daily_metrics table has new row for aggregated date</verify>
  <done>Aggregation endpoint created for manual triggering, ready for Phase 21 integration and future cron setup</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] daily_metrics table created with correct schema
- [ ] aggregate_daily_metrics() function callable and idempotent
- [ ] analytics-server.ts exports all query helpers
- [ ] getDailyMetrics() and getMetricsSummary() return data
- [ ] POST /api/analytics/aggregate requires admin auth
- [ ] Manual aggregation creates daily_metrics row
- [ ] No errors or warnings introduced
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- daily_metrics table created with KPI columns and aggregation function
- Server-side query helpers ready for admin dashboards (Phase 21)
- Aggregation endpoint functional with admin auth
- Metrics can be pre-computed and queried efficiently
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/20-analytics-foundation/20-02-SUMMARY.md`
</output>
