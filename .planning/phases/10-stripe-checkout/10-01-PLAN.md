---
phase: 10-stripe-checkout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, src/lib/stripe.ts, .env.local, src/types/order.ts, src/components/admin/OrderStatusBadge.tsx, src/components/admin/OrderStatusSelect.tsx, src/app/api/checkout/route.ts, src/app/commande/page.tsx, src/components/checkout/CheckoutForm.tsx, src/components/checkout/PaymentMethods.tsx, supabase/migration-stripe.sql]
autonomous: false
---

<objective>
Install Stripe, update order types for payment flow, create Checkout Session API, and modify the checkout page to redirect to Stripe for payment.

Purpose: Replace the current "order without payment" flow with real Stripe Checkout. After this plan, clicking "Pay" on checkout redirects the customer to Stripe's hosted payment page.
Output: Working Stripe Checkout Session creation, updated order types with payment statuses, and checkout page redirect to Stripe.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-supabase-migration-auth/09-01-PLAN.md
@.planning/phases/09-supabase-migration-auth/09-02-PLAN.md

@src/types/order.ts
@src/types/checkout.ts
@src/types/cart.ts
@src/app/commande/page.tsx
@src/components/checkout/CheckoutForm.tsx
@src/components/checkout/PaymentMethods.tsx
@src/components/admin/OrderStatusBadge.tsx
@src/lib/orders.ts
@src/lib/supabase/server.ts
@src/lib/supabase/admin.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe, create server helper, update order types and DB schema</name>
  <files>package.json, src/lib/stripe.ts, .env.local, src/types/order.ts, src/components/admin/OrderStatusBadge.tsx, src/components/admin/OrderStatusSelect.tsx, supabase/migration-stripe.sql</files>
  <action>
1. Install Stripe server SDK: `npm install stripe`

2. Create `src/lib/stripe.ts` — server-only Stripe instance:
   ```typescript
   import Stripe from 'stripe'

   export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
     typescript: true,
   })
   ```
   This file must ONLY be imported in server-side code (Route Handlers, Server Actions, server components). Never import in client components.

3. Update `.env.local` — add Stripe environment variables (append to existing file, do NOT overwrite Supabase vars):
   ```
   # Stripe
   STRIPE_SECRET_KEY=sk_test_your_key_here
   STRIPE_WEBHOOK_SECRET=whsec_your_secret_here
   NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_your_key_here
   ```

4. Update `src/types/order.ts`:
   - Add `"pending_payment"` to the `OrderStatus` union type (BEFORE "pending"):
     ```typescript
     export type OrderStatus =
       | "pending_payment"
       | "pending"
       | "confirmed"
       | "processing"
       | "shipped"
       | "delivered"
       | "cancelled";
     ```
   - Add to `orderStatusLabels`:
     ```typescript
     pending_payment: "En attente de paiement",
     ```
   - Add Stripe fields to `Order` interface:
     ```typescript
     /** Stripe Checkout Session ID */
     stripeSessionId?: string;
     /** Stripe Payment Intent ID */
     stripePaymentIntentId?: string;
     ```

5. Update `src/components/admin/OrderStatusBadge.tsx`:
   - Add `pending_payment` to `statusStyles`:
     ```typescript
     pending_payment: "bg-orange-100 text-orange-800",
     ```

6. Update `src/components/admin/OrderStatusSelect.tsx` (if it exists and has a list of selectable statuses):
   - Add `pending_payment` to the status options list

7. Create `supabase/migration-stripe.sql` — SQL to add Stripe columns and update the status constraint:
   ```sql
   -- Add Stripe columns to orders table
   ALTER TABLE orders ADD COLUMN IF NOT EXISTS stripe_session_id TEXT;
   ALTER TABLE orders ADD COLUMN IF NOT EXISTS stripe_payment_intent_id TEXT;

   -- Update status CHECK constraint to include pending_payment
   -- First drop the existing constraint, then re-add with new values
   ALTER TABLE orders DROP CONSTRAINT IF EXISTS orders_status_check;
   ALTER TABLE orders ADD CONSTRAINT orders_status_check
     CHECK (status IN ('pending_payment', 'pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled'));
   ```

IMPORTANT: Do NOT modify the Supabase client helpers — they are already set up in Phase 9.
IMPORTANT: The `stripe` import is server-only. If any client component needs Stripe (for embedded checkout), that would use `@stripe/stripe-js` — but we're using redirect mode so no client-side Stripe SDK is needed.
  </action>
  <verify>Run `npm ls stripe` to confirm installation. Run `npm run build` to check no TypeScript errors. Verify migration SQL file exists.</verify>
  <done>Stripe package installed. Server helper at src/lib/stripe.ts. Order types updated with pending_payment status and Stripe fields. Admin status badge handles new status. Migration SQL ready to apply.</done>
</task>

<task type="auto">
  <name>Task 2: Create Checkout Session API and modify checkout page to redirect to Stripe</name>
  <files>src/app/api/checkout/route.ts, src/app/commande/page.tsx, src/components/checkout/CheckoutForm.tsx, src/components/checkout/PaymentMethods.tsx</files>
  <action>
1. Create `src/app/api/checkout/route.ts` — POST endpoint that creates a Stripe Checkout Session:

   ```typescript
   import { NextRequest, NextResponse } from 'next/server'
   import { stripe } from '@/lib/stripe'
   import { createOrder } from '@/lib/orders'
   import { getAllProducts } from '@/lib/products'
   ```

   The endpoint receives: `{ items: OrderItem[], shippingAddress: ShippingAddress, shippingCost: number, notes?: string }`

   Flow:
   a. Validate required fields (items, shippingAddress).
   b. **Security: Look up product prices from DB** — fetch all products with `getAllProducts()`, build a map by ID. For each item in the request, use the DB price (NOT the client-sent price). This prevents price manipulation. If a product ID is not found, return 400.
   c. Calculate subtotal from DB-verified prices: `sum(dbPrice * quantity)`.
   d. Calculate total: `subtotal + shippingCost`.
   e. Create order in DB with `createOrder()` using status `"pending_payment"` — modify the call to pass status. NOTE: If `createOrder()` doesn't accept a status parameter, you'll need to update the function or create the order manually via Supabase. The simplest approach: after creating the order with default status, immediately update it to `pending_payment`. Or modify `CreateOrderData` to accept an optional `status` field.
   f. Build Stripe `line_items` from order items:
      ```typescript
      const line_items = items.map(item => ({
        price_data: {
          currency: 'eur',
          product_data: {
            name: item.productName,
            images: item.productImage ? [item.productImage.startsWith('http') ? item.productImage : `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}${item.productImage}`] : [],
          },
          unit_amount: dbPriceMap[item.productId], // DB-verified price in cents
        },
        quantity: item.quantity,
      }))
      ```
   g. Create Stripe Checkout Session:
      ```typescript
      const session = await stripe.checkout.sessions.create({
        mode: 'payment',
        line_items,
        shipping_options: shippingCost > 0 ? [{
          shipping_rate_data: {
            type: 'fixed_amount',
            fixed_amount: { amount: shippingCost, currency: 'eur' },
            display_name: 'Livraison',
          },
        }] : [{
          shipping_rate_data: {
            type: 'fixed_amount',
            fixed_amount: { amount: 0, currency: 'eur' },
            display_name: 'Livraison gratuite',
          },
        }],
        customer_email: shippingAddress.email,
        client_reference_id: order.id,
        metadata: {
          orderId: order.id,
          orderNumber: order.orderNumber,
        },
        locale: 'fr',
        success_url: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/commande/confirmation/${order.orderNumber}?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/panier`,
      })
      ```
   h. Update order with `stripeSessionId`:
      - Use Supabase admin client to update: `supabase.from('orders').update({ stripe_session_id: session.id }).eq('id', order.id)`
   i. Return `{ url: session.url, orderNumber: order.orderNumber }` with status 200.
   j. Wrap everything in try/catch, return 500 on errors.

   IMPORTANT: Do NOT use `payment_method_types` — let Stripe auto-detect (dynamic payment methods). This ensures Carte Bancaire, Apple Pay, Google Pay, etc. show automatically based on customer location.
   IMPORTANT: The `{CHECKOUT_SESSION_ID}` template in success_url is a Stripe placeholder — Stripe replaces it with the actual session ID at redirect time.

2. **Modify `src/app/commande/page.tsx`** — Change handleSubmit to call the checkout API:

   Replace the current handleSubmit implementation. New flow:
   a. Build orderItems from cart (same as before).
   b. Calculate subtotal (same as before).
   c. Call `fetch('/api/checkout', { method: 'POST', body: JSON.stringify({ items: orderItems, shippingAddress: updatedAddress, shippingCost, notes }) })`.
   d. Parse response. If error, show error message.
   e. If success, redirect to Stripe: `window.location.href = data.url`.
   f. Do NOT clear cart here — cart is cleared on the success/confirmation page after payment.
   g. Do NOT send confirmation email here — email is sent by the webhook after payment confirmation.
   h. Remove the import of `createOrder` from `@/lib/orders` (no longer called directly from client).

3. **Update `src/components/checkout/CheckoutForm.tsx`**:
   - Change the submit button text from "Commander" to "Procéder au paiement" (or "Payer maintenant").
   - Change the loading text from "Traitement en cours" to "Redirection vers le paiement".
   - Keep the animated cloud spinner — it fits the brand.

4. **Update `src/components/checkout/PaymentMethods.tsx`**:
   - Remove the mock disabled payment form (disabled inputs for card number, expiry, CVV, cardholder).
   - Remove the "Le paiement sera activé prochainement" blue info banner.
   - Keep the payment method icons (Visa, Mastercard, Amex) and security messaging.
   - Keep the "Paiement 100% sécurisé" section with SSL, no-store, 3D Secure badges.
   - Change the bottom "Futur paiement sécurisé par" to "Paiement sécurisé par" (remove "Futur").
   - Add a short message: "Vous serez redirigé vers notre partenaire de paiement sécurisé Stripe pour finaliser votre achat." — place this where the mock form was.
   - Remove the `paymentGateway` prop and the `PaymentGateway` type — no longer needed.
   - Remove the commented-out Stripe Elements code at the bottom of the file.

IMPORTANT: The checkout API route verifies prices server-side. Never trust prices from the client request.
IMPORTANT: For images in Stripe line_items, product images stored as relative paths (e.g., `/images/product.jpg`) must be converted to absolute URLs. Use `NEXT_PUBLIC_SITE_URL` env var or fall back to `http://localhost:3000`.
  </action>
  <verify>
1. `npm run build` succeeds without errors.
2. Start dev server with `npm run dev`.
3. Add item to cart, go to checkout, fill form, click "Procéder au paiement".
4. Verify the API call is made to /api/checkout (check Network tab).
5. If Stripe credentials are configured: user is redirected to Stripe Checkout page with correct items and prices.
6. If Stripe credentials are NOT configured: error is returned and displayed (expected — credentials set up in checkpoint).
  </verify>
  <done>
Checkout API route creates Stripe Checkout Session with DB-verified prices. Checkout page redirects to Stripe instead of creating order directly. Payment form placeholder replaced with Stripe redirect messaging. Submit button says "Procéder au paiement".
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set up Stripe test account and configure credentials</action>
  <instructions>
    I've installed Stripe and created all the code. Now you need to:

    1. **Stripe Account:**
       - Go to https://dashboard.stripe.com and sign in (or create account)
       - Make sure you're in **Test mode** (toggle in top-right)

    2. **API Keys** (Settings → Developers → API Keys):
       - Copy **Publishable key** (pk_test_...) → `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` in `.env.local`
       - Copy **Secret key** (sk_test_...) → `STRIPE_SECRET_KEY` in `.env.local`

    3. **Apply database migration:**
       - Go to Supabase SQL Editor
       - Run the contents of `supabase/migration-stripe.sql`

    4. **Optional — NEXT_PUBLIC_SITE_URL:**
       - Add `NEXT_PUBLIC_SITE_URL=http://localhost:3000` to `.env.local` (used for Stripe success/cancel URLs and product image URLs)

    5. **Test the checkout:**
       - Run `npm run dev`
       - Add item to cart → Checkout → Fill form → Click "Procéder au paiement"
       - You should be redirected to Stripe's test checkout page
       - Use test card: `4242 4242 4242 4242`, any future expiry, any CVC
       - After payment, you'll return to the confirmation page (webhook not set up yet — that's Plan 02)

    Webhook setup happens in Plan 02 — for now just verify the redirect works.
  </instructions>
  <verification>Stripe test checkout page loads with correct items, prices in EUR, and French locale. After test payment with 4242 card, user returns to confirmation URL.</verification>
  <resume-signal>Type "done" when Stripe credentials are configured and test redirect works</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `stripe` package in package.json dependencies
- [ ] `src/lib/stripe.ts` exports Stripe instance
- [ ] OrderStatus type includes "pending_payment"
- [ ] Order interface includes stripeSessionId and stripePaymentIntentId
- [ ] Admin status badge handles pending_payment
- [ ] POST /api/checkout creates Stripe Checkout Session
- [ ] Checkout page redirects to Stripe (not direct order creation)
- [ ] PaymentMethods shows Stripe redirect messaging (no mock form)
- [ ] Migration SQL file ready
</verification>

<success_criteria>

- Stripe SDK installed and configured
- Order types updated with payment statuses and Stripe fields
- Checkout API creates Stripe Session with DB-verified prices
- Checkout page redirects to Stripe's hosted payment page
- French locale and EUR currency on Stripe page
- Dynamic payment methods (Carte Bancaire, Apple Pay auto-detected)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-stripe-checkout/10-01-SUMMARY.md`
</output>
