---
phase: 26-social-media-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/referral.ts, src/app/api/referral/track/route.ts, src/components/account/ReferralDashboard.tsx, src/app/compte/profil/page.tsx, supabase/migrations/20260213000003_referral_tracking.sql]
autonomous: true
---

<objective>
Implement referral tracking and UTM parameter capture to measure and incentivize viral growth.

Purpose: Track referral sources and UTM campaigns to understand which channels drive traffic and conversions. Enable customer referral program for word-of-mouth growth.
Output: UTM tracking system, referral link generation, and dashboard for users to track their referrals.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-analytics-foundation/20-01-SUMMARY.md

Existing analytics:
@src/lib/analytics.ts - Event tracking system with trackEvent function
@src/lib/supabase/client.ts - Supabase client for database operations

Database patterns:
- Use snake_case for columns
- RLS policies for security
- Supabase migrations in supabase/migrations/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create referral tracking database schema</name>
  <files>supabase/migrations/20260213000003_referral_tracking.sql</files>
  <action>Create Supabase migration for referral tracking. Tables: 1) utm_visits (id uuid, visitor_id text (session storage), utm_source text, utm_medium text, utm_campaign text, utm_term text, utm_content text, landing_page text, referrer text, created_at timestamptz, converted boolean default false, order_id uuid nullable). 2) referral_links (id uuid, user_id uuid references auth.users, referral_code text unique, clicks integer default 0, conversions integer default 0, created_at timestamptz). Add indexes on utm_source, utm_campaign, referral_code, user_id. RLS: utm_visits public read for analytics, referral_links user can read own rows, admins can read all. Auto-generate referral_code as 8-char alphanumeric on insert trigger.</action>
  <verify>Migration file created with proper SQL syntax</verify>
  <done>Database schema supports UTM and referral tracking</done>
</task>

<task type="auto">
  <name>Task 2: Create UTM capture and referral tracking library</name>
  <files>src/lib/referral.ts</files>
  <action>Create referral tracking library. Functions: 1) captureUTMParams() - client-side function that reads URL search params (utm_source, utm_medium, utm_campaign, utm_term, utm_content), stores in sessionStorage, calls trackVisit(). 2) trackVisit(utmParams, referralCode?) - saves to utm_visits table with visitor session ID from sessionStorage (generate if not exists). 3) generateReferralLink(userId) - creates or gets user's referral code, returns https://nuage.fr/?ref=CODE. 4) trackReferralClick(referralCode) - increments clicks on referral_links. 5) trackReferralConversion(visitorId, orderId) - marks utm_visit as converted and increments referral_links.conversions. Use Supabase client for DB operations. Handle errors gracefully (log but don't throw).</action>
  <verify>Referral library exports all tracking functions</verify>
  <done>Referral tracking logic implemented and tested</done>
</task>

<task type="auto">
  <name>Task 3: Integrate UTM capture on app load</name>
  <files>src/app/layout.tsx</files>
  <action>Create client component UTMCapturer that calls captureUTMParams() on mount (useEffect with empty deps). Only runs on client (typeof window !== 'undefined'). Place UTMCapturer as child of body in root layout (before CartProvider). Component is invisible (renders null). Captures on every page load but sessionStorage prevents duplicates. If ?ref= param present, call trackReferralClick. Ensures UTM and referral attribution tracked across site.</action>
  <verify>UTM parameters captured on page load, stored in sessionStorage</verify>
  <done>UTM tracking active site-wide</done>
</task>

<task type="auto">
  <name>Task 4: Create referral dashboard for user accounts</name>
  <files>src/components/account/ReferralDashboard.tsx, src/app/compte/profil/page.tsx</files>
  <action>Create ReferralDashboard component (client). Shows: 1) User's referral link with copy button. 2) Stats: total clicks, conversions, conversion rate. 3) Share buttons (WhatsApp, Email, Copy) pre-filled with referral message "Découvrez Nuage, boutique chicha premium! Utilisez mon lien: [link]". Fetch user's referral data from Supabase referral_links table. Use Framer Motion for micro-interactions (copy success feedback). Style with Tailwind cards. Add to profile page (/compte/profil) after account details, before order history. Section heading: "Parrainage". Include explanation: "Partagez Nuage avec vos amis et suivez vos parrainages."</action>
  <verify>Referral dashboard displays user's link and stats</verify>
  <done>Users can generate and share referral links</done>
</task>

<task type="auto">
  <name>Task 5: Connect referral tracking to order completion</name>
  <files>src/app/api/checkout/success/route.ts</files>
  <action>In checkout success handler (or wherever orders are marked complete after payment), call trackReferralConversion with visitor session ID from cookie/header and order ID. Retrieve session ID from request cookies or headers (set by UTMCapturer). Mark utm_visit as converted and increment referral_links conversions if visitor came via referral. This closes the loop: click → visit → purchase → attribution. Ensure this runs after order is confirmed (payment successful) but before success page renders.</action>
  <verify>Orders trigger referral conversion tracking when applicable</verify>
  <done>Referral attribution complete from click to conversion</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Supabase migration applied (check with supabase db pull)
- [ ] UTM parameters captured on page load
- [ ] Referral links generated for authenticated users
- [ ] Referral dashboard displays on profile page
- [ ] Share buttons work with pre-filled message
- [ ] Order completion triggers conversion tracking
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- Database schema supports UTM and referral tracking
- UTM parameters captured site-wide
- Referral links generated and sharable
- Conversion tracking from click to purchase
- User dashboard shows referral stats
- No errors in analytics pipeline
  </success_criteria>

<output>
After completion, create `.planning/phases/26-social-media-integration/26-03-SUMMARY.md`
</output>
