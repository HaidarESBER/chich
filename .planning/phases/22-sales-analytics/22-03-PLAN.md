---
phase: 22-sales-analytics
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/analytics-server.ts, src/components/admin/OrderHeatmap.tsx, src/components/admin/ShippingBreakdown.tsx, src/components/admin/StatusFunnel.tsx, src/app/admin/analytics/orders/page.tsx]
autonomous: true
---

<objective>
Create order intelligence dashboard analyzing order patterns by time (day of week, hour), shipping method distribution, and order status conversion funnel to identify trends and optimization opportunities.

Purpose: Help admins understand when customers order most, which shipping methods are popular, and where orders drop off in the lifecycle, enabling data-driven decisions about operations, marketing timing, and shipping offerings.

Output: /admin/analytics/orders page with time-based heatmap, shipping distribution, and status funnel visualization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-analytics-foundation/20-02-SUMMARY.md
@.planning/phases/21-admin-dashboard/21-02-SUMMARY.md
@src/lib/analytics-server.ts
@src/types/order.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order pattern analytics helpers in analytics-server.ts</name>
  <files>src/lib/analytics-server.ts</files>
  <action>
Add three new order intelligence helpers to analytics-server.ts:

1. **getOrdersByTimePattern(days = 30)** - Returns order volume by day of week and hour
   - Query orders from last N days
   - Extract day of week (0-6, Sunday = 0) and hour (0-23) from created_at
   - Group by dayOfWeek and hour, count orders
   - Return array of {dayOfWeek, hour, orderCount}
   - Include zero counts for all day/hour combinations (for complete heatmap)
   - Use createAdminClient()
   - Also calculate peak times: busiest day of week, busiest hour

2. **getShippingDistribution()** - Returns order count by shipping cost tier
   - Query all orders
   - Group by shipping amount (0 = free, >0 = paid)
   - Calculate distribution:
     - Free shipping (shipping = 0): count, percentage
     - Standard shipping (shipping > 0 && shipping < 1000): count, percentage
     - Express shipping (shipping >= 1000): count, percentage
   - Return array of {shippingTier, label, orderCount, percentage, totalRevenue}
   - Sort by orderCount descending

3. **getOrderStatusFunnel()** - Returns order counts by status for conversion funnel
   - Query orders grouped by status
   - Count orders for each OrderStatus
   - Calculate percentages (of total orders)
   - Calculate drop-off rates between stages:
     - pending_payment → pending (payment completion rate)
     - pending → confirmed (confirmation rate)
     - confirmed → processing → shipped → delivered (fulfillment pipeline)
     - cancelled orders (cancellation rate)
   - Return array of {status, label (French), orderCount, percentage, dropOffRate}
   - Order by typical lifecycle sequence

Add TypeScript interfaces:
- TimePattern {dayOfWeek: number, hour: number, orderCount: number}
- PeakTimes {peakDay: string, peakHour: number, peakDayCount: number, peakHourCount: number}
- ShippingDistribution {shippingTier: string, label: string, orderCount: number, percentage: number, totalRevenue: number}
- StatusFunnelStep {status: OrderStatus, label: string, orderCount: number, percentage: number, dropOffRate?: number}

Export all three functions and interfaces. Include helper to convert dayOfWeek number to French day name.
  </action>
  <verify>TypeScript compiles without errors (npm run build succeeds)</verify>
  <done>Three order pattern helpers exported from analytics-server.ts with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create order analysis components</name>
  <files>src/components/admin/OrderHeatmap.tsx, src/components/admin/ShippingBreakdown.tsx, src/components/admin/StatusFunnel.tsx</files>
  <action>
Create three order intelligence components following established patterns:

**1. OrderHeatmap.tsx** - Time-based order volume heatmap
- Props: data (TimePattern[]), peakTimes (PeakTimes)
- Visual heatmap grid: days of week (rows) x hours (columns)
- Color intensity based on orderCount (0 orders = white/cream, high orders = dark/accent)
- Use pure CSS with background color gradients (no external library)
- Show French day names (Lundi, Mardi, etc.) on Y-axis
- Show hours (0-23) on X-axis
- Display orderCount on hover/as data attribute
- Show peak insights above grid: "Pic: [Mercredi] à [14h] avec [X] commandes"
- Responsive: scroll horizontally on mobile if needed
- Legend showing color scale (0 → max orders)

**2. ShippingBreakdown.tsx** - Shipping method distribution
- Props: data (ShippingDistribution[])
- Horizontal bar chart (pure CSS flexbox like 21-02 RevenueChart)
- Bars showing percentage width for each shipping tier
- Labels: tier name, order count, percentage, revenue
- Color coding: Free (green/success), Standard (blue), Express (purple)
- French labels: "Livraison Gratuite", "Livraison Standard", "Livraison Express"
- Show totals: total orders, total shipping revenue
- Format currency with toLocaleString('fr-FR')

**3. StatusFunnel.tsx** - Order status conversion funnel
- Props: data (StatusFunnelStep[])
- Funnel visualization with decreasing widths (pure CSS)
- Each step shows: status label (French), order count, percentage of total
- Show drop-off rate between steps (red text if >20% drop)
- Highlight completed orders (delivered) in green
- Highlight cancelled orders in red
- French status labels from orderStatusLabels
- Conversion metrics summary at bottom:
  - Payment completion rate
  - Order fulfillment rate
  - Cancellation rate

All components:
- Client components ("use client")
- French labels and formatting
- Consistent admin styling
- Empty state handling
- Responsive design
  </action>
  <verify>Components render without errors, visualizations clear and informative</verify>
  <done>Three order analysis components created with heatmap, shipping breakdown, and status funnel</done>
</task>

<task type="auto">
  <name>Task 3: Create /admin/analytics/orders page</name>
  <files>src/app/admin/analytics/orders/page.tsx</files>
  <action>
Create order intelligence page at /admin/analytics/orders:

**Server Component** (force-dynamic for real-time data):
- export const dynamic = 'force-dynamic';
- Fetch data using analytics-server helpers:
  - const {patterns, peakTimes} = await getOrdersByTimePattern(30)
  - const shippingDist = await getShippingDistribution()
  - const statusFunnel = await getOrderStatusFunnel()
- Error handling with try/catch per data source
- Calculate summary metrics:
  - Total orders analyzed
  - Peak ordering time
  - Most popular shipping method
  - Overall conversion rate (delivered / total)

**Page Layout:**
```tsx
<div className="space-y-6">
  <div className="flex items-center justify-between">
    <h1>Analyse des Commandes</h1>
    <Link href="/admin" className="text-sm text-stone-600">← Retour</Link>
  </div>

  {/* Summary Cards */}
  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
    <InfoCard title="Total Commandes" value={totalOrders} />
    <InfoCard title="Heure de Pic" value={peakHour} />
    <InfoCard title="Livraison Populaire" value={popularShipping} />
    <InfoCard title="Taux de Conversion" value={conversionRate}% />
  </div>

  {/* Order Heatmap */}
  <section>
    <h2>Répartition Temporelle des Commandes</h2>
    <p className="text-sm text-stone-600 mb-4">
      Volume de commandes par jour de la semaine et heure (30 derniers jours)
    </p>
    <OrderHeatmap data={patterns} peakTimes={peakTimes} />
  </section>

  {/* Shipping Distribution */}
  <section>
    <h2>Distribution des Livraisons</h2>
    <p className="text-sm text-stone-600 mb-4">
      Méthodes de livraison choisies par les clients
    </p>
    <ShippingBreakdown data={shippingDist} />
  </section>

  {/* Status Funnel */}
  <section>
    <h2>Entonnoir de Statut des Commandes</h2>
    <p className="text-sm text-stone-600 mb-4">
      Progression des commandes dans le cycle de vie
    </p>
    <StatusFunnel data={statusFunnel} />
  </section>

  {/* Insights */}
  <section>
    <h2>Insights</h2>
    <div className="bg-cream p-4 rounded border border-stone-200">
      <ul className="list-disc list-inside space-y-2 text-sm">
        <li>Jour le plus actif: {peakDay}</li>
        <li>Heure de pic: {peakHour}h avec {peakCount} commandes</li>
        <li>Préférence livraison: {mostPopularShipping}</li>
        <li>Taux d'abandon paiement: {paymentAbandonRate}%</li>
      </ul>
    </div>
  </section>
</div>
```

**Styling:**
- Consistent with existing admin pages
- Section descriptions for context
- Insights summary box at bottom with key takeaways
- Responsive grid layout
- French labels throughout

**Navigation:**
- Back link to /admin dashboard
- Page accessible via admin sidebar analytics section
  </action>
  <verify>Page loads at /admin/analytics/orders, all visualizations display correctly with French labels</verify>
  <done>/admin/analytics/orders page complete with time heatmap, shipping distribution, and status funnel</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] /admin/analytics/orders page loads and displays data
- [ ] Heatmap shows time patterns clearly with color gradient
- [ ] Shipping breakdown percentages sum to 100%
- [ ] Status funnel shows logical order progression
- [ ] French formatting applied to all labels and data
- [ ] Components handle empty states gracefully
- [ ] Insights section provides actionable takeaways
</verification>

<success_criteria>

- All tasks completed
- Three order pattern helpers in analytics-server.ts
- Three order analysis components created
- /admin/analytics/orders page functional
- Time heatmap, shipping distribution, and status funnel working
- Actionable insights displayed
- All data formatted in French
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/22-sales-analytics/22-03-SUMMARY.md`
</output>
