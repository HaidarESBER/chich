---
phase: 22-sales-analytics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/analytics-server.ts, src/components/admin/StockAlerts.tsx, src/components/admin/InventoryVelocity.tsx, src/components/admin/RestockRecommendations.tsx, src/app/admin/analytics/inventory/page.tsx]
autonomous: true
---

<objective>
Create inventory management dashboard with stock alerts, sales velocity analysis, and automated restock recommendations based on current stock levels and sales patterns.

Purpose: Help admins proactively manage inventory by identifying low-stock products, calculating days of inventory remaining, and recommending restock quantities based on sales velocity to prevent stockouts.

Output: /admin/analytics/inventory page with stock alerts, velocity metrics, and restock recommendations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-analytics-foundation/20-02-SUMMARY.md
@src/lib/analytics-server.ts
@src/types/order.ts
@src/types/product.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inventory analytics helpers in analytics-server.ts</name>
  <files>src/lib/analytics-server.ts</files>
  <action>
Add three new inventory-focused analytics helpers to analytics-server.ts:

1. **getStockAlerts()** - Returns products with low stock levels
   - Query products table where inStock = true
   - Filter products where stockLevel exists and stockLevel <= 10 (limited or urgent)
   - Calculate urgency: stockLevel 0 = out of stock, 1-5 = urgent, 6-10 = limited
   - Return array of {productId, name, category, stockLevel, urgency}
   - Sort by urgency (most urgent first)
   - Use createAdminClient()

2. **getInventoryVelocity(days = 30)** - Returns sales velocity per product
   - Query order_items for last N days
   - Group by productId, count total units sold
   - Calculate daily velocity: units_sold / days
   - Join with products to get current stockLevel
   - Calculate days of inventory remaining: stockLevel / dailyVelocity (handle division by zero)
   - Return array of {productId, name, stockLevel, unitsSold, dailyVelocity, daysRemaining}
   - Sort by daysRemaining ascending (products running out soonest first)
   - Include only products with stockLevel > 0

3. **getRestockRecommendations(targetDays = 60)** - Returns restock recommendations
   - Use getInventoryVelocity() data
   - For each product with daysRemaining < targetDays:
     - Calculate recommended restock quantity: (dailyVelocity * targetDays) - currentStock
     - Round up to nearest 5 or 10 for practical ordering
     - Estimate when stockout will occur: today + daysRemaining
   - Return array of {productId, name, currentStock, dailyVelocity, daysRemaining, recommendedRestock, estimatedStockoutDate}
   - Sort by urgency (soonest stockout first)

Add TypeScript interfaces:
- StockAlert {productId, name, category, stockLevel, urgency: 'critical' | 'urgent' | 'limited'}
- InventoryVelocity {productId, name, stockLevel, unitsSold, dailyVelocity, daysRemaining}
- RestockRecommendation {productId, name, currentStock, dailyVelocity, daysRemaining, recommendedRestock, estimatedStockoutDate}

Export all three functions and interfaces.
  </action>
  <verify>TypeScript compiles without errors (npm run build succeeds)</verify>
  <done>Three inventory analytics helpers exported from analytics-server.ts with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create inventory visualization components</name>
  <files>src/components/admin/StockAlerts.tsx, src/components/admin/InventoryVelocity.tsx, src/components/admin/RestockRecommendations.tsx</files>
  <action>
Create three inventory management components following established patterns:

**1. StockAlerts.tsx** - Low stock alerts table
- Props: data (StockAlert[])
- Table with columns: Product, Category, Stock Level, Status
- Status badge with color coding:
  - Critical (0 stock): red background
  - Urgent (1-5): orange background
  - Limited (6-10): yellow background
- Use categoryLabels from @/types/product for French names
- Show count summary at top: "X produits nécessitent une attention"
- Empty state: "Aucune alerte de stock"
- Alternating row backgrounds

**2. InventoryVelocity.tsx** - Sales velocity and days remaining table
- Props: data (InventoryVelocity[])
- Table with columns: Product, Stock, Units Sold (30d), Daily Velocity, Days Remaining
- Highlight products with daysRemaining < 30 (accent color)
- Format dailyVelocity to 1 decimal place
- Format daysRemaining as integer
- Show "N/A" for products with zero velocity
- Empty state handling
- Sort by daysRemaining ascending

**3. RestockRecommendations.tsx** - Restock recommendations table
- Props: data (RestockRecommendation[])
- Table with columns: Product, Current Stock, Daily Velocity, Days Left, Recommended Restock, Est. Stockout
- Highlight urgent restocks (daysRemaining < 14) with accent background
- Format dates in French (toLocaleDateString('fr-FR'))
- Show recommended restock quantity prominently
- Include action hint: "Commander avant [date]"
- Empty state: "Aucune recommandation de réapprovisionnement"
- Sort by urgency (soonest stockout first)

All components:
- Client components ("use client")
- French number formatting with toLocaleString('fr-FR')
- Consistent admin styling (Charcoal text, Mist/Cream backgrounds)
- Error boundaries with graceful fallbacks
- Responsive design (stack on mobile)
  </action>
  <verify>Components render without errors, TypeScript types correct</verify>
  <done>Three inventory components created with French formatting and urgency indicators</done>
</task>

<task type="auto">
  <name>Task 3: Create /admin/analytics/inventory page</name>
  <files>src/app/admin/analytics/inventory/page.tsx</files>
  <action>
Create inventory management page at /admin/analytics/inventory:

**Server Component** (force-dynamic for real-time data):
- export const dynamic = 'force-dynamic';
- Fetch data using analytics-server helpers:
  - const stockAlerts = await getStockAlerts()
  - const inventoryVelocity = await getInventoryVelocity(30)
  - const restockRecs = await getRestockRecommendations(60)
- Error handling with try/catch per data source
- Calculate summary metrics:
  - Total products with alerts
  - Products requiring immediate restock (< 14 days)
  - Total recommended restock units

**Page Layout:**
```tsx
<div className="space-y-6">
  <div className="flex items-center justify-between">
    <h1>Gestion des Stocks</h1>
    <Link href="/admin" className="text-sm text-stone-600">← Retour</Link>
  </div>

  {/* Summary Cards */}
  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
    <AlertCard title="Alertes de Stock" value={alertCount} urgent={urgentCount} />
    <AlertCard title="Réapprovisionnement Urgent" value={urgentRestockCount} />
    <InfoCard title="Unités à Commander" value={totalRestockUnits} />
  </div>

  {/* Stock Alerts */}
  <section>
    <h2>Alertes de Stock</h2>
    <p className="text-sm text-stone-600 mb-4">
      Produits avec stock limité ou en rupture
    </p>
    <StockAlerts data={stockAlerts} />
  </section>

  {/* Inventory Velocity */}
  <section>
    <h2>Vélocité des Stocks</h2>
    <p className="text-sm text-stone-600 mb-4">
      Jours de stock restant basés sur les ventes des 30 derniers jours
    </p>
    <InventoryVelocity data={inventoryVelocity} />
  </section>

  {/* Restock Recommendations */}
  <section>
    <h2>Recommandations de Réapprovisionnement</h2>
    <p className="text-sm text-stone-600 mb-4">
      Quantités suggérées pour maintenir 60 jours de stock
    </p>
    <RestockRecommendations data={restockRecs} />
  </section>
</div>
```

**Styling:**
- Consistent with existing admin pages (white backgrounds, borders, padding)
- Alert-focused design (use accent colors for urgent items)
- Section descriptions for clarity
- Responsive grid layout
- French labels throughout

**Navigation:**
- Back link to /admin dashboard
- Page accessible via admin sidebar analytics section
  </action>
  <verify>Page loads at /admin/analytics/inventory, all alerts and recommendations display correctly</verify>
  <done>/admin/analytics/inventory page complete with stock alerts, velocity metrics, and restock recommendations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] /admin/analytics/inventory page loads and displays data
- [ ] Stock alerts show urgency levels correctly
- [ ] Days remaining calculations accurate
- [ ] Restock recommendations make sense (positive quantities, future dates)
- [ ] French formatting applied to all numbers and dates
- [ ] Components handle edge cases (zero velocity, out of stock)
</verification>

<success_criteria>

- All tasks completed
- Three inventory analytics helpers in analytics-server.ts
- Three inventory components created
- /admin/analytics/inventory page functional
- Stock alerts, velocity, and restock logic working
- All data formatted in French
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/22-sales-analytics/22-02-SUMMARY.md`
</output>
