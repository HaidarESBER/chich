---
phase: 22-sales-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/analytics-server.ts, src/components/admin/SalesByCategory.tsx, src/components/admin/TopSellers.tsx, src/components/admin/AOVChart.tsx, src/app/admin/analytics/sales/page.tsx]
autonomous: true
---

<objective>
Create comprehensive sales performance dashboard showing revenue breakdown by category, top-selling products by revenue, and average order value trends.

Purpose: Enable admins to identify which product categories drive revenue, which products are best sellers, and track order value trends over time for strategic inventory and pricing decisions.

Output: /admin/analytics/sales page with category revenue analysis, top sellers ranking, and AOV trend visualization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-analytics-foundation/20-02-SUMMARY.md
@.planning/phases/21-admin-dashboard/21-02-SUMMARY.md
@src/lib/analytics-server.ts
@src/types/order.ts
@src/types/product.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sales analytics helpers in analytics-server.ts</name>
  <files>src/lib/analytics-server.ts</files>
  <action>
Add three new server-side analytics helpers to analytics-server.ts:

1. **getRevenueByCategory()** - Returns revenue breakdown by product category
   - Query orders and order_items joined with products table
   - Group by product.category, sum order_items revenue (price * quantity)
   - Return array of {category, revenue, orderCount, avgOrderValue}
   - Use createAdminClient() for RLS bypass
   - Handle empty results gracefully

2. **getTopSellingProducts(limit = 10)** - Returns top products by total revenue
   - Query order_items joined with products
   - Group by product_id, sum (price * quantity) as revenue, sum quantity as units_sold
   - Order by revenue DESC
   - Include product name, category, revenue, units sold, average price
   - Return TopSellingProduct[] interface

3. **getAOVTrends(days = 30)** - Returns daily average order value trends
   - Query orders grouped by date (created_at truncated to day)
   - Calculate AVG(total) for each day
   - Return array of {date, avgOrderValue, orderCount}
   - Use last N days from current date

Add TypeScript interfaces:
- TopSellingProduct {productId, name, category, revenue, unitsSold, avgPrice}
- CategoryRevenue {category, revenue, orderCount, avgOrderValue}
- AOVTrend {date, avgOrderValue, orderCount}

Export all three functions and interfaces.
  </action>
  <verify>TypeScript compiles without errors (npm run build succeeds)</verify>
  <done>Three new helpers exported from analytics-server.ts with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create sales visualization components</name>
  <files>src/components/admin/SalesByCategory.tsx, src/components/admin/TopSellers.tsx, src/components/admin/AOVChart.tsx</files>
  <action>
Create three visualization components following Phase 21 patterns (pure CSS/HTML, no external chart libraries):

**1. SalesByCategory.tsx** - Category revenue table
- Props: data (CategoryRevenue[])
- Table with columns: Category, Revenue (€), Orders, Avg Order Value (€)
- Use categoryLabels from @/types/product for French names
- Format currency with toLocaleString('fr-FR', {style: 'currency', currency: 'EUR'})
- Top category highlighted with accent color
- Alternating row backgrounds (Mist/Cream from 21-03 pattern)
- Show percentage of total revenue per category
- Empty state: "Aucune donnée disponible"
- Sort by revenue descending

**2. TopSellers.tsx** - Top selling products table
- Props: data (TopSellingProduct[])
- Table with columns: Rank, Product, Category, Revenue (€), Units Sold, Avg Price (€)
- Top 3 ranks highlighted with accent color (from 21-03 pattern)
- Format numbers with toLocaleString('fr-FR')
- Alternating row backgrounds
- Empty state handling
- Sort by revenue descending (already sorted from query)

**3. AOVChart.tsx** - Average order value line chart
- Props: data (AOVTrend[])
- SVG line chart (follow 21-02 OrderTrends pattern)
- X-axis: dates, Y-axis: average order value (€)
- Line path through data points
- Flexbox container with proper scaling
- Show min/max AOV values
- Format currency on Y-axis labels
- Empty state handling

All components:
- Client components ("use client")
- Error boundaries with try/catch where needed
- French number formatting
- Consistent styling with existing admin dashboard (Charcoal text, Mist/Cream backgrounds)
  </action>
  <verify>Components render without errors, TypeScript types correct</verify>
  <done>Three visualization components created with French formatting and consistent admin styling</done>
</task>

<task type="auto">
  <name>Task 3: Create /admin/analytics/sales page</name>
  <files>src/app/admin/analytics/sales/page.tsx</files>
  <action>
Create sales analytics page at /admin/analytics/sales:

**Server Component** (force-dynamic for real-time data):
- export const dynamic = 'force-dynamic';
- Fetch data using analytics-server helpers:
  - const categoryRevenue = await getRevenueByCategory()
  - const topSellers = await getTopSellingProducts(15) // top 15
  - const aovTrends = await getAOVTrends(30) // last 30 days
- Error handling with try/catch per data source (graceful fallback if one fails)
- Calculate total revenue across all categories for summary

**Page Layout:**
```tsx
<div className="space-y-6">
  <div className="flex items-center justify-between">
    <h1>Analyse des Ventes</h1>
    <Link href="/admin" className="text-sm text-stone-600">← Retour</Link>
  </div>

  {/* Summary Cards */}
  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
    <SummaryCard title="Revenu Total" value={totalRevenue in €} />
    <SummaryCard title="Valeur Moyenne" value={avgOrderValue in €} />
    <SummaryCard title="Total Commandes" value={totalOrders} />
  </div>

  {/* Revenue by Category */}
  <section>
    <h2>Revenu par Catégorie</h2>
    <SalesByCategory data={categoryRevenue} />
  </section>

  {/* Top Sellers */}
  <section>
    <h2>Meilleures Ventes</h2>
    <TopSellers data={topSellers} />
  </section>

  {/* AOV Trends */}
  <section>
    <h2>Évolution du Panier Moyen</h2>
    <AOVChart data={aovTrends} />
  </section>
</div>
```

**Styling:**
- Consistent with existing admin pages (white backgrounds, borders, padding)
- Responsive grid layout
- Section headings with bottom border (from 21-02/21-03 pattern)
- French labels and formatting throughout

**Navigation:**
- Back link to /admin dashboard
- Page already accessible via admin sidebar (analytics section added in 21-02)
  </action>
  <verify>Page loads at /admin/analytics/sales, data displays correctly, no errors in console</verify>
  <done>/admin/analytics/sales page complete with category breakdown, top sellers, and AOV trends</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] /admin/analytics/sales page loads and displays data
- [ ] All three data sources fetch and render correctly
- [ ] French formatting applied to all numbers and currency
- [ ] Components handle empty states gracefully
- [ ] Styling consistent with existing admin pages
</verification>

<success_criteria>

- All tasks completed
- Three new analytics helpers in analytics-server.ts
- Three visualization components created
- /admin/analytics/sales page functional
- All data formatted in French (currency, numbers)
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/22-sales-analytics/22-01-SUMMARY.md`
</output>
