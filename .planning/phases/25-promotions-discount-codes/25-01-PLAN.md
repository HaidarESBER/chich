---
phase: 25-promotions-discount-codes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migration-promotions.sql
  - src/types/promotion.ts
  - src/lib/promotions.ts
  - src/app/admin/promotions/page.tsx
  - src/app/admin/promotions/actions.ts
  - src/app/admin/layout.tsx
autonomous: true
domain: next-js
---

<objective>
Create the promotions backend infrastructure and admin management UI.

Purpose: Enable the admin to create, manage, and control discount codes with percentage/fixed discounts, usage limits, minimum order requirements, and time-limited validity (flash sales).
Output: Supabase promotions table, TypeScript types, CRUD library, and admin management page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/admin/layout.tsx
@src/lib/supabase/admin.ts
@src/lib/orders.ts
@src/app/admin/produits/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create promotions table, TypeScript types, and CRUD library</name>
  <files>supabase/migration-promotions.sql, src/types/promotion.ts, src/lib/promotions.ts</files>
  <action>
  1. Create `supabase/migration-promotions.sql` with promotions table:
     - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
     - code TEXT UNIQUE NOT NULL (uppercase, e.g., BIENVENUE10)
     - description TEXT (admin note, e.g., "10% first purchase discount")
     - discount_type TEXT CHECK ('percentage', 'fixed_amount') NOT NULL
     - discount_value INTEGER NOT NULL (percentage: 10 = 10%, fixed: 1000 = 10.00€ in cents)
     - minimum_order INTEGER DEFAULT 0 (minimum cart subtotal in cents, 0 = no minimum)
     - max_uses INTEGER (NULL = unlimited)
     - current_uses INTEGER DEFAULT 0
     - starts_at TIMESTAMPTZ DEFAULT now()
     - expires_at TIMESTAMPTZ (NULL = no expiry)
     - is_active BOOLEAN DEFAULT true
     - created_at TIMESTAMPTZ DEFAULT now()
     - updated_at TIMESTAMPTZ DEFAULT now()
     - RLS: public read for code validation (SELECT on active codes only), admin full access via is_admin check
     - Seed BIENVENUE10 as 10% discount, no minimum, no expiry, active
     - Add updated_at trigger (reuse pattern from existing migrations)

  2. Create `src/types/promotion.ts`:
     - Promotion interface matching table columns (camelCase)
     - CreatePromotionData interface (code, description, discountType, discountValue, minimumOrder, maxUses, startsAt, expiresAt)
     - DiscountType union type ('percentage' | 'fixed_amount')
     - calculateDiscount helper: (subtotalCents: number, promotion: Promotion) => number (returns discount in cents, capped at subtotal for percentage, capped at subtotal for fixed)
     - formatDiscount helper: (promotion: Promotion) => string (returns "-10%" or "-10,00 €")

  3. Create `src/lib/promotions.ts` with "use server" directive:
     - Uses createAdminClient pattern (consistent with existing codebase)
     - getPromotions(): fetch all promotions ordered by created_at desc
     - getPromotionByCode(code: string): fetch single promotion by uppercase code
     - createPromotion(data: CreatePromotionData): insert and return
     - updatePromotion(id: string, data: Partial<CreatePromotionData> & { isActive?: boolean }): update
     - deletePromotion(id: string): delete
     - incrementPromotionUses(id: string): increment current_uses by 1
     - validatePromotion(code: string, subtotalCents: number): returns { valid: boolean, promotion?: Promotion, error?: string } - checks is_active, dates, usage limits, minimum order
     - Snake_case DB mapping (same pattern as orders.ts toOrder/toOrderItem)
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit src/types/promotion.ts src/lib/promotions.ts</verify>
  <done>Promotions table SQL ready, types exported, CRUD + validation functions implemented with proper DB mapping</done>
</task>

<task type="auto">
  <name>Task 2: Create admin promotions management page</name>
  <files>src/app/admin/promotions/page.tsx, src/app/admin/promotions/actions.ts, src/app/admin/layout.tsx</files>
  <action>
  1. Create `src/app/admin/promotions/actions.ts` with server actions:
     - createPromotionAction(formData: FormData): validate inputs, call createPromotion, revalidatePath
     - updatePromotionAction(id: string, formData: FormData): call updatePromotion, revalidatePath
     - togglePromotionAction(id: string, isActive: boolean): toggle active status, revalidatePath
     - deletePromotionAction(id: string): call deletePromotion, revalidatePath
     - Follow existing server action patterns (see admin pipeline actions)

  2. Create `src/app/admin/promotions/page.tsx`:
     - Server component that fetches all promotions via getPromotions()
     - Display table with columns: Code, Type, Valeur, Min. commande, Utilisations, Validite, Statut, Actions
     - Each row shows: code (monospace bold), "%" or "€" badge for type, formatted value, min order or "—", "X/Y" or "X/∞" for uses, date range or "Permanent", active/inactive badge (green/gray), edit/toggle/delete buttons
     - "Nouveau code promo" button opens inline form (same page, not modal - follow existing admin patterns)
     - Create form with fields: code (auto-uppercase), description, discount type (radio: Pourcentage/Montant fixe), value, minimum order, max uses, start date, end date
     - Edit form reuses same fields, pre-populated
     - Expired promotions shown with muted styling
     - French labels throughout
     - Use Tailwind classes consistent with existing admin pages (bg-background-card, rounded-[--radius-card], text-primary, etc.)

  3. Add "Promotions" link to admin sidebar in `src/app/admin/layout.tsx`:
     - Add between "Pipeline" and "Analytics" section
     - Import Tag icon from lucide-react
     - Same link pattern as existing nav items
  </action>
  <verify>Run `npm run build` - page compiles without errors. Navigate to /admin/promotions shows empty state or seeded BIENVENUE10.</verify>
  <done>Admin can view, create, edit, toggle, and delete promotions at /admin/promotions. BIENVENUE10 visible if seeded. Sidebar has Promotions link.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Migration SQL is valid and creates proper table with RLS
- [ ] TypeScript types compile cleanly
- [ ] Admin promotions page renders
- [ ] CRUD operations work through server actions
- [ ] Admin sidebar shows Promotions link
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Promotions table ready with BIENVENUE10 seeded
- Admin can fully manage promotion codes
- calculateDiscount and validatePromotion functions ready for checkout integration
</success_criteria>

<output>
After completion, create `.planning/phases/25-promotions-discount-codes/25-01-SUMMARY.md`
</output>
