---
phase: 25-promotions-discount-codes
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/app/api/promotions/validate/route.ts
  - src/components/checkout/DiscountCodeInput.tsx
  - src/components/checkout/CheckoutForm.tsx
  - src/components/checkout/OrderSummary.tsx
  - src/app/api/checkout/route.ts
  - src/types/order.ts
  - src/types/checkout.ts
  - src/components/marketing/ExitIntentModal.tsx
autonomous: true
domain: next-js
---

<objective>
Integrate discount codes into the checkout flow end-to-end.

Purpose: Customers can enter a discount code at checkout, see the discount applied in real-time, and pay the discounted total via Stripe. The ExitIntentModal's BIENVENUE10 code becomes functional.
Output: Working discount code flow from input to payment to order record.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-promotions-discount-codes/25-01-SUMMARY.md

@src/components/checkout/CheckoutForm.tsx
@src/components/checkout/OrderSummary.tsx
@src/app/api/checkout/route.ts
@src/types/order.ts
@src/types/checkout.ts
@src/types/promotion.ts
@src/lib/promotions.ts
@src/components/marketing/ExitIntentModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discount validation API and checkout UI components</name>
  <files>src/app/api/promotions/validate/route.ts, src/components/checkout/DiscountCodeInput.tsx, src/components/checkout/CheckoutForm.tsx, src/components/checkout/OrderSummary.tsx, src/types/checkout.ts</files>
  <action>
  1. Create `src/app/api/promotions/validate/route.ts`:
     - POST endpoint accepting { code: string, subtotal: number } (subtotal in cents)
     - Call validatePromotion(code, subtotal) from lib/promotions
     - On valid: return { valid: true, promotion: { code, discountType, discountValue, description }, discountAmount: number (calculated cents) }
     - On invalid: return { valid: false, error: string } with appropriate French error messages:
       - "Code promo introuvable" (not found)
       - "Ce code promo a expire" (expired)
       - "Ce code promo n'est pas encore actif" (not started)
       - "Ce code promo a atteint sa limite d'utilisation" (max uses reached)
       - "Commande minimum de X € requise" (min order not met)

  2. Create `src/components/checkout/DiscountCodeInput.tsx`:
     - Client component with input field + "Appliquer" button
     - Props: subtotalCents: number, onDiscountApplied: (discount: { code: string, amount: number, label: string } | null) => void
     - Input auto-uppercases on change
     - On submit: POST to /api/promotions/validate with code and subtotal
     - Loading state on button during validation
     - Success state: show green badge with code + discount label (e.g., "BIENVENUE10 : -10%") + "Retirer" button to clear
     - Error state: show error message below input in red
     - When discount applied, call onDiscountApplied with { code, amount (cents), label }
     - When removed, call onDiscountApplied(null)
     - Re-validate if subtotal changes (discount might become invalid if items removed below minimum)
     - Style consistent with checkout form (same input classes, rounded-[--radius-button], accent colors)

  3. Modify `src/components/checkout/CheckoutForm.tsx`:
     - Add discountCode state: { code: string, amount: number, label: string } | null
     - Add DiscountCodeInput component between ShippingCalculator and PaymentMethods sections
     - Pass subtotal (calculateSubtotal(items)) and onDiscountApplied handler
     - Pass discountCode to OrderSummary (both mobile and desktop instances)
     - Include discountCode and discountAmount in onSubmit data

  4. Modify `src/types/checkout.ts`:
     - Add to CheckoutFormData: discountCode?: string, discountAmount?: number

  5. Modify `src/components/checkout/OrderSummary.tsx`:
     - Add optional prop: discount?: { code: string, amount: number, label: string }
     - If discount provided, show discount line between Sous-total and Livraison:
       - Left: "Remise (CODE)" in accent/green color
       - Right: "-X,XX €" in accent/green color
     - Recalculate total: subtotal - discountAmount + shippingCost
     - Ensure total never goes below 0 (defensive)
  </action>
  <verify>Run `npm run build` - all components compile. Discount input renders in checkout form. OrderSummary shows discount line when provided.</verify>
  <done>Discount code input validates against API, displays success/error states, OrderSummary shows discount breakdown, total recalculated with discount</done>
</task>

<task type="auto">
  <name>Task 2: Apply discount in checkout API and wire ExitIntentModal</name>
  <files>src/app/api/checkout/route.ts, src/types/order.ts, src/components/marketing/ExitIntentModal.tsx</files>
  <action>
  1. Modify `src/types/order.ts`:
     - Add to Order interface: discountCode?: string, discountAmount?: number (both already exist in DB, just missing from TS types)
     - Add to CreateOrderData interface: discountCode?: string, discountAmount?: number

  2. Modify `src/app/api/checkout/route.ts`:
     - Add discountCode and discountAmount to CheckoutRequestBody interface (both optional)
     - After calculating subtotal, if discountCode provided:
       a. Re-validate the code server-side via validatePromotion(discountCode, subtotal) - NEVER trust client discount amount
       b. Calculate discount via calculateDiscount(subtotal, promotion)
       c. If validation fails, return 400 with error (code may have expired between validation and checkout)
       d. Recalculate total: subtotal - discountAmount + shippingCost
     - Pass discountCode and discountAmount to createOrder()
     - After successful Stripe session creation, call incrementPromotionUses(promotion.id) to track usage
     - For Stripe: apply discount as a negative line item with name "Remise (CODE)" OR reduce the total sent to Stripe. Use Stripe's `discounts` with a coupon created on-the-fly:
       - Create a one-time Stripe coupon via stripe.coupons.create({ amount_off: discountAmount, currency: 'eur', duration: 'once', name: `Remise ${discountCode}` }) for fixed amounts, or { percent_off: discountValue, duration: 'once' } for percentages
       - Pass coupon to session via discounts: [{ coupon: coupon.id }]
       - This ensures Stripe receipt shows the discount properly
     - Add discount info to session metadata: discountCode, discountAmount

  3. Modify `src/components/marketing/ExitIntentModal.tsx`:
     - After copying BIENVENUE10 to clipboard, also store it in sessionStorage key 'pendingDiscountCode'
     - The checkout form can optionally check sessionStorage on mount and pre-fill the discount code input
     - Update DiscountCodeInput to check sessionStorage('pendingDiscountCode') on mount, auto-apply if found, then clear from sessionStorage
     - This creates a seamless flow: user sees exit intent → copies code → goes to checkout → code is auto-applied
  </action>
  <verify>Run `npm run build` succeeds. Test flow: apply BIENVENUE10 in checkout, verify discount appears in order summary, verify Stripe session includes discount.</verify>
  <done>Discount codes work end-to-end: validated server-side, applied to Stripe session with proper coupon, stored in order record, ExitIntentModal's BIENVENUE10 auto-fills at checkout</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Discount code input appears in checkout between shipping calculator and payment
- [ ] Valid code shows success badge, invalid shows error
- [ ] OrderSummary displays discount line with recalculated total
- [ ] Checkout API re-validates code server-side
- [ ] Stripe session includes discount coupon
- [ ] Order record stores discount_code and discount_amount
- [ ] ExitIntentModal's BIENVENUE10 auto-applies at checkout
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Complete discount flow: enter code → validate → see discount → pay discounted total → order records discount
- BIENVENUE10 works as a real functional discount code
- Server-side validation prevents client manipulation
</success_criteria>

<output>
After completion, create `.planning/phases/25-promotions-discount-codes/25-02-SUMMARY.md`
</output>
