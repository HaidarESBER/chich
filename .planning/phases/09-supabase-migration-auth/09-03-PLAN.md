---
phase: 09-supabase-migration-auth
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified: [src/lib/session.ts, src/lib/users.ts, src/middleware.ts, src/app/api/auth/login/route.ts, src/app/api/auth/register/route.ts, src/app/api/auth/logout/route.ts, src/app/api/auth/session/route.ts, src/app/admin/layout.tsx, src/contexts/AuthContext.tsx]
autonomous: true
---

<objective>
Migrate from custom cookie-based auth to Supabase Auth. Replace manual session management with Supabase's built-in auth system.

Purpose: Secure the admin panel with production-grade authentication. Replace hand-rolled bcrypt auth and cookie sessions with Supabase Auth's battle-tested implementation.
Output: Supabase Auth fully integrated — signup, login, logout, session management, admin protection via middleware.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-supabase-migration-auth/09-01-SUMMARY.md

@src/lib/session.ts
@src/lib/users.ts
@src/middleware.ts
@src/app/api/auth/login/route.ts
@src/app/api/auth/register/route.ts
@src/app/api/auth/logout/route.ts
@src/app/api/auth/session/route.ts
@src/lib/supabase/server.ts
@src/lib/supabase/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate auth API routes to Supabase Auth</name>
  <files>src/app/api/auth/register/route.ts, src/app/api/auth/login/route.ts, src/app/api/auth/logout/route.ts, src/app/api/auth/session/route.ts, src/lib/users.ts</files>
  <action>
**Rewrite auth API routes to use Supabase Auth:**

1. **POST /api/auth/register** (`src/app/api/auth/register/route.ts`):
   - Import `createClient` from `@/lib/supabase/server`
   - Call `supabase.auth.signUp({ email, password, options: { data: { first_name, last_name } } })`
   - The `handle_new_user` trigger (from Plan 01 schema) auto-creates the profile row
   - After signup, update the profile with first_name and last_name: `supabase.from('profiles').update({ first_name, last_name }).eq('id', user.id)`
   - Return user session data
   - Keep existing password validation rules on the server side (min 12 chars, complexity) BEFORE calling Supabase signUp

2. **POST /api/auth/login** (`src/app/api/auth/login/route.ts`):
   - Call `supabase.auth.signInWithPassword({ email, password })`
   - On success, Supabase automatically sets the auth cookie
   - Fetch profile to check is_admin: `supabase.from('profiles').select('*').eq('id', user.id).single()`
   - Return session with profile data (firstName, lastName, isAdmin)

3. **POST /api/auth/logout** (`src/app/api/auth/logout/route.ts`):
   - Call `supabase.auth.signOut()`
   - Return success

4. **GET /api/auth/session** (`src/app/api/auth/session/route.ts`):
   - Call `supabase.auth.getUser()` to get current user
   - If authenticated, fetch profile: `supabase.from('profiles').select('*').eq('id', user.id).single()`
   - Return UserSession shape: `{ id, email, firstName, lastName, isAdmin }`

5. **Update src/lib/users.ts:**
   - Remove `registerUser()` and `loginUser()` functions (replaced by Supabase Auth)
   - Keep `getUserById()` and `getUserByEmail()` but rewrite to query profiles table
   - Remove all `fs` imports and file I/O
   - Remove bcryptjs dependency from this file (Supabase handles password hashing)

IMPORTANT: Do NOT remove bcryptjs from package.json yet — other code may use it. Just remove it from users.ts imports.

IMPORTANT: Supabase Auth cookies are managed automatically by @supabase/ssr. Do NOT manually set/delete cookies. The createServerClient from Plan 01's server.ts helper handles cookie exchange.
  </action>
  <verify>Test register: POST /api/auth/register with new user → 200, user appears in Supabase Auth dashboard. Test login: POST /api/auth/login → 200, session cookie set. Test session: GET /api/auth/session → returns user data. Test logout: POST /api/auth/logout → session cleared.</verify>
  <done>All 4 auth endpoints use Supabase Auth. No more manual bcrypt hashing or cookie management in auth routes. Profile auto-created on signup via trigger.</done>
</task>

<task type="auto">
  <name>Task 2: Update session helpers and middleware for Supabase Auth</name>
  <files>src/lib/session.ts, src/middleware.ts, src/contexts/AuthContext.tsx</files>
  <action>
**Rewrite session.ts to use Supabase Auth:**

1. **`src/lib/session.ts`** — Replace cookie-based session with Supabase:
   - Remove all cookie import/manipulation
   - Import `createClient` from `@/lib/supabase/server`

   - `getSession()`: Call `supabase.auth.getUser()`. If authenticated, fetch profile from profiles table. Return `UserSession` shape (id, email, firstName, lastName, isAdmin) or null.
   - `requireAuth()`: Call getSession(), throw redirect to /compte if null.
   - `requireAdmin()`: Call getSession(), throw redirect if null or !isAdmin.
   - `isAuthenticated()`: Return boolean from getSession().
   - `isAdmin()`: Return boolean from getSession() checking isAdmin.

   Keep the same function signatures so all consumers (admin pages, API routes) continue working.

2. **`src/middleware.ts`** — Rewrite for Supabase Auth:
   - Import `updateSession` from `@/lib/supabase/middleware`
   - The middleware MUST call `updateSession(request)` on EVERY request to refresh the auth cookie (Supabase requirement)
   - After session refresh, apply route protection:
     - For `/admin/*`: Check if user is authenticated AND is_admin
     - For protected API routes: Same admin check, return 401/403
     - For public routes: Pass through
   - To check admin status in middleware: Create a Supabase client from the request, call `getUser()`, then query profiles table for is_admin
   - IMPORTANT: Use `supabase.auth.getUser()` (server-validated), NOT `getSession()` (client-claimed, not secure for middleware)

   Middleware flow:
   ```
   1. updateSession(request) — refresh auth cookie
   2. If route is /admin/* or protected API:
      a. supabase.auth.getUser() → get user
      b. If no user → redirect /compte or 401
      c. Query profiles.is_admin → if false, redirect / or 403
   3. Return response
   ```

3. **Update `src/contexts/AuthContext.tsx`** (if it exists):
   - Update to use the /api/auth/session endpoint for checking auth state
   - Or use Supabase client-side: `supabase.auth.onAuthStateChange()` listener
   - Make sure the auth context provides: user, isAdmin, isLoading, login(), logout(), register()

IMPORTANT: The middleware.ts matcher should include ALL routes that need session refresh. At minimum: `/admin/:path*` and the protected API routes. Optionally include all routes for consistent session handling.

IMPORTANT: Do NOT use `supabase.auth.getSession()` in middleware — it reads from cookies without server validation. Use `supabase.auth.getUser()` which validates the JWT with Supabase servers.
  </action>
  <verify>
1. npm run build passes
2. Visit /admin without auth → redirected to /compte
3. Login as admin → can access /admin
4. Login as non-admin → redirected away from /admin
5. Session persists across page refreshes
6. Logout clears session
  </verify>
  <done>Session management uses Supabase Auth. Middleware refreshes auth cookies and protects admin routes. Admin check uses profiles.is_admin via server-validated getUser(). All existing session helper function signatures preserved.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Register new user → profile auto-created in profiles table
- [ ] Login → session established, persists across pages
- [ ] Logout → session cleared
- [ ] Admin routes protected (non-admin redirected)
- [ ] Protected API routes return 401/403 for unauthorized
- [ ] Session survives page refresh (middleware cookie refresh working)
- [ ] No references to manual cookie set/delete in session.ts
- [ ] No bcrypt usage in auth flow (Supabase handles it)
</verification>

<success_criteria>

- All auth flows use Supabase Auth (signUp, signIn, signOut)
- Session management via Supabase (no manual cookies)
- Middleware refreshes auth session on every request
- Admin protection uses server-validated getUser() + profiles.is_admin
- Existing function signatures in session.ts preserved
- Build passes, no TypeScript errors
- An admin user can be created (register + set is_admin=true in Supabase dashboard)
</success_criteria>

<output>
After completion, create `.planning/phases/09-supabase-migration-auth/09-03-SUMMARY.md`
</output>
