---
phase: 09-supabase-migration-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, src/lib/supabase/server.ts, src/lib/supabase/client.ts, src/lib/supabase/middleware.ts, .env.local, supabase/schema.sql]
autonomous: false
---

<objective>
Set up Supabase foundation: install packages, create client helpers, define database schema with RLS, and prepare seed data migration.

Purpose: Foundation for all Supabase-dependent work in Phase 9. Every subsequent plan depends on this setup.
Output: Working Supabase connection with database schema ready for data access and auth migration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/types/product.ts
@src/types/order.ts
@src/types/user.ts
@data/products.json
@data/orders.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase packages and create client helpers</name>
  <files>package.json, src/lib/supabase/server.ts, src/lib/supabase/client.ts, src/lib/supabase/middleware.ts, .env.local, supabase/schema.sql</files>
  <action>
1. Install packages: `npm install @supabase/supabase-js @supabase/ssr`

2. Create `src/lib/supabase/server.ts`:
   - Export `createClient()` function using `createServerClient` from `@supabase/ssr`
   - Use `cookies()` from `next/headers` (async in Next.js 15+)
   - Configure with `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` env vars
   - Cookie handling: implement `getAll()` and `setAll()` methods using Next.js cookies API

3. Create `src/lib/supabase/client.ts`:
   - Export `createClient()` function using `createBrowserClient` from `@supabase/ssr`
   - Configure with same env vars (NEXT_PUBLIC_ prefix makes them available client-side)

4. Create `src/lib/supabase/middleware.ts`:
   - Export `updateSession(request)` function using `createServerClient` from `@supabase/ssr`
   - Handles cookie refresh on every request (critical for Supabase Auth)
   - Creates NextResponse, reads/writes cookies from request/response
   - Calls `supabase.auth.getUser()` to refresh session

5. Create `.env.local` with placeholder values:
   ```
   NEXT_PUBLIC_SUPABASE_URL=your-project-url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
   ```
   IMPORTANT: Use the service role key only in server-side code for admin operations (bypasses RLS).

6. Create `supabase/schema.sql` with complete database schema:

   **products table:**
   ```sql
   CREATE TABLE products (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     slug TEXT UNIQUE NOT NULL,
     name TEXT NOT NULL,
     description TEXT NOT NULL,
     short_description TEXT NOT NULL,
     price INTEGER NOT NULL,
     compare_at_price INTEGER,
     images TEXT[] NOT NULL DEFAULT '{}',
     category TEXT NOT NULL CHECK (category IN ('chicha', 'bol', 'tuyau', 'charbon', 'accessoire')),
     in_stock BOOLEAN NOT NULL DEFAULT true,
     stock_level INTEGER DEFAULT 10,
     featured BOOLEAN NOT NULL DEFAULT false,
     created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
     updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
   );
   ```

   **profiles table** (extends auth.users):
   ```sql
   CREATE TABLE profiles (
     id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
     email TEXT UNIQUE NOT NULL,
     first_name TEXT NOT NULL DEFAULT '',
     last_name TEXT NOT NULL DEFAULT '',
     is_admin BOOLEAN NOT NULL DEFAULT false,
     created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
     updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
   );
   ```

   **orders table:**
   ```sql
   CREATE TABLE orders (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     order_number TEXT UNIQUE NOT NULL,
     user_email TEXT NOT NULL,
     subtotal INTEGER NOT NULL,
     shipping INTEGER NOT NULL DEFAULT 0,
     total INTEGER NOT NULL,
     status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled')),
     shipping_address JSONB NOT NULL,
     notes TEXT,
     discount_code TEXT,
     discount_amount INTEGER DEFAULT 0,
     tracking_number TEXT,
     tracking_url TEXT,
     estimated_delivery TEXT,
     shipped_at TIMESTAMPTZ,
     delivered_at TIMESTAMPTZ,
     created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
     updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
   );
   ```

   **order_items table:**
   ```sql
   CREATE TABLE order_items (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
     product_id TEXT NOT NULL,
     product_name TEXT NOT NULL,
     product_image TEXT NOT NULL,
     price INTEGER NOT NULL,
     quantity INTEGER NOT NULL CHECK (quantity > 0)
   );
   ```

   **RLS Policies:**
   ```sql
   -- Enable RLS on all tables
   ALTER TABLE products ENABLE ROW LEVEL SECURITY;
   ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
   ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;
   ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

   -- Products: public read, admin write
   CREATE POLICY "Products are viewable by everyone" ON products FOR SELECT USING (true);
   CREATE POLICY "Products are editable by admins" ON products FOR ALL USING (
     EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND profiles.is_admin = true)
   );

   -- Orders: admin read all, users read own
   CREATE POLICY "Users can view own orders" ON orders FOR SELECT USING (
     user_email = (SELECT email FROM profiles WHERE id = auth.uid())
     OR EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND profiles.is_admin = true)
   );
   CREATE POLICY "Anyone can create orders" ON orders FOR INSERT WITH CHECK (true);
   CREATE POLICY "Admins can update orders" ON orders FOR UPDATE USING (
     EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND profiles.is_admin = true)
   );

   -- Order items: same access as parent order
   CREATE POLICY "Users can view own order items" ON order_items FOR SELECT USING (
     EXISTS (SELECT 1 FROM orders WHERE orders.id = order_items.order_id AND (
       orders.user_email = (SELECT email FROM profiles WHERE id = auth.uid())
       OR EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND profiles.is_admin = true)
     ))
   );
   CREATE POLICY "Anyone can create order items" ON order_items FOR INSERT WITH CHECK (true);

   -- Profiles: users read own, admins read all
   CREATE POLICY "Users can view own profile" ON profiles FOR SELECT USING (
     id = auth.uid() OR EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND profiles.is_admin = true)
   );
   CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (id = auth.uid());
   ```

   **Auto-create profile on signup (trigger):**
   ```sql
   CREATE OR REPLACE FUNCTION public.handle_new_user()
   RETURNS TRIGGER AS $$
   BEGIN
     INSERT INTO public.profiles (id, email, first_name, last_name)
     VALUES (NEW.id, NEW.email, '', '');
     RETURN NEW;
   END;
   $$ LANGUAGE plpgsql SECURITY DEFINER;

   CREATE TRIGGER on_auth_user_created
     AFTER INSERT ON auth.users
     FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
   ```

   **Seed data:** Include INSERT statements for existing products from data/products.json (8 products). Do NOT seed orders or users (orders will start fresh, users will re-register via Supabase Auth).

   **Updated_at trigger:**
   ```sql
   CREATE OR REPLACE FUNCTION update_updated_at()
   RETURNS TRIGGER AS $$
   BEGIN
     NEW.updated_at = now();
     RETURN NEW;
   END;
   $$ LANGUAGE plpgsql;

   CREATE TRIGGER products_updated_at BEFORE UPDATE ON products FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   CREATE TRIGGER orders_updated_at BEFORE UPDATE ON orders FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   CREATE TRIGGER profiles_updated_at BEFORE UPDATE ON profiles FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   ```

  IMPORTANT: Use snake_case for all database columns (PostgreSQL convention). The TypeScript types will map camelCase to snake_case.
  </action>
  <verify>npm ls @supabase/supabase-js @supabase/ssr shows both installed. All files created. Schema SQL file is valid SQL.</verify>
  <done>Supabase packages installed, client helpers created for server/browser/middleware, .env.local template ready, schema.sql complete with tables, RLS policies, triggers, and seed data.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Supabase project and configure credentials</action>
  <instructions>
    I've created all the code and schema files. Now you need to:

    1. Go to https://supabase.com and create a new project (or use existing)
    2. Copy your project credentials to `.env.local`:
       - Project URL → `NEXT_PUBLIC_SUPABASE_URL`
       - Anon/Public key → `NEXT_PUBLIC_SUPABASE_ANON_KEY`
       - Service Role key → `SUPABASE_SERVICE_ROLE_KEY`
       (Find these in: Project Settings → API)
    3. Run the schema SQL:
       - Go to SQL Editor in Supabase dashboard
       - Copy contents of `supabase/schema.sql`
       - Run the query
    4. Verify tables created in Table Editor
  </instructions>
  <verification>Check that .env.local has real values (not placeholders) and npm run dev starts without Supabase connection errors</verification>
  <resume-signal>Type "done" when Supabase project is set up and schema is applied</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run dev` starts without errors
- [ ] Supabase client can connect (no auth/connection errors in console)
- [ ] Tables visible in Supabase Table Editor (products, orders, order_items, profiles)
- [ ] Products seeded (8 products visible)
- [ ] RLS policies active
</verification>

<success_criteria>

- Supabase packages installed
- Client helpers created for server, browser, and middleware contexts
- Database schema deployed with all tables
- RLS policies configured
- Seed data for products loaded
- Environment variables configured with real credentials
</success_criteria>

<output>
After completion, create `.planning/phases/09-supabase-migration-auth/09-01-SUMMARY.md`
</output>
