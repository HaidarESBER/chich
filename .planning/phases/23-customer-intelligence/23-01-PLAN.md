---
phase: 23-customer-intelligence
plan: 01
wave: 1
autonomous: true
subsystem: analytics
tags: [customer-intelligence, rfm-analysis, segmentation, analytics]

# Dependency graph
requires:
  - phase: 20-analytics-foundation
    provides: analytics_events table, analytics-server.ts pattern
  - phase: 21-admin-dashboard
    provides: admin dashboard layout, KPI components
  - phase: 22-sales-analytics
    provides: sales analytics patterns, visualization components
provides:
  - Customer segmentation helpers (getRFMSegments, getCustomerSegments, getCustomerProfiles)
  - RFM analysis components (RFMDistribution, CustomerSegments, TopCustomers)
  - /admin/analytics/customers dashboard page
affects: [23-02-cohort-ltv, future-marketing-campaigns]

# Tech tracking
tech-stack:
  added: []
  patterns: [RFM analysis, customer segmentation, behavioral scoring]

key-files:
  to-create:
    - src/lib/customer-analytics.ts (customer intelligence query helpers)
    - src/components/admin/RFMDistribution.tsx
    - src/components/admin/CustomerSegments.tsx
    - src/components/admin/TopCustomers.tsx
    - src/app/admin/analytics/customers/page.tsx
  to-modify: []

key-decisions:
  - "RFM scoring: Recency (0-90 days), Frequency (order count), Monetary (total revenue)"
  - "5-tier RFM scores: 1 (lowest) to 5 (highest) based on quintiles"
  - "Segment definitions: VIP (555), Champions (454-555), Loyal (344-454), At-Risk (233-343), Churned (111-232)"
  - "Query orders + order_items joined for customer-level aggregation"
  - "Application-level RFM calculation (SQL can't easily score quintiles)"
  - "Admin-only access via createAdminClient() pattern"

patterns-to-establish:
  - "Customer intelligence helpers in src/lib/customer-analytics.ts"
  - "RFM segment visualization with color-coded badges"
  - "Customer profile cards with purchase history summaries"
  - "French segment labels (VIP, Champions, Fidèles, À Risque, Inactifs)"

issues-to-defer: []
---

# Plan 23-01: Customer Segmentation & RFM Analysis

**Build RFM (Recency, Frequency, Monetary) analysis system to segment customers by purchase behavior and identify high-value, at-risk, and churned customers**

## Objective

Create customer intelligence foundation with RFM analysis to segment customers by purchase patterns, identify VIP customers, detect churn risk, and provide actionable insights for marketing and retention.

**Purpose:** Enable data-driven customer retention strategies by understanding who are the best customers, who needs attention, and who has churned.

## Context

### What We Have
- orders table with user_email, total, created_at
- order_items table for purchase details
- profiles table for customer info
- analytics_events, browse_history, wishlist for behavioral data
- Sales analytics pattern from Phase 22
- Admin dashboard pattern from Phase 21

### What We Need
1. RFM scoring algorithm to classify customers
2. Customer segment definitions (VIP, Champions, Loyal, At-Risk, Churned)
3. Query helpers to calculate RFM scores and segments
4. Dashboard to visualize customer distribution and top customers

### Success Criteria
- Admin can see customer segments (VIP, Champions, At-Risk, Churned)
- RFM distribution shows customer breakdown by segment
- Top customers ranked by total revenue with purchase summaries
- French labels and formatting throughout

## Tasks

### Task 1: Create customer intelligence query helpers
**File:** `src/lib/customer-analytics.ts`

Create new library for customer-level analytics with RFM analysis:

**Interfaces:**
```typescript
export interface CustomerRFM {
  email: string;
  firstName: string;
  lastName: string;
  recency: number; // days since last order
  frequency: number; // total orders
  monetary: number; // total revenue in cents
  recencyScore: number; // 1-5
  frequencyScore: number; // 1-5
  monetaryScore: number; // 1-5
  rfmScore: string; // e.g., "555", "344"
  segment: 'VIP' | 'Champions' | 'Fidèles' | 'À Risque' | 'Inactifs';
  firstOrderDate: string;
  lastOrderDate: string;
  avgOrderValue: number; // cents
}

export interface CustomerSegmentStats {
  segment: string;
  count: number;
  percentage: number;
  totalRevenue: number; // cents
  avgOrderValue: number; // cents
}
```

**Helper functions:**

1. **`getRFMSegments(): Promise<CustomerRFM[]>`**
   - Query all orders grouped by user_email
   - Calculate recency (days since last order)
   - Calculate frequency (count of orders)
   - Calculate monetary (sum of order totals)
   - Score each metric on 1-5 scale using quintiles
   - Assign segment based on RFM score:
     - VIP: 555, 554, 545, 455
     - Champions: 544, 454, 445, 444, 543
     - Fidèles: 434, 443, 344, 353, 433
     - À Risque: 343, 334, 333, 324, 243
     - Inactifs: 234, 233, 224, 223, 134, 133, 124, 123, 114, 113
   - Join with profiles for first_name, last_name
   - Return sorted by monetary DESC

2. **`getCustomerSegmentStats(): Promise<CustomerSegmentStats[]>`**
   - Call getRFMSegments()
   - Group by segment
   - Calculate count, percentage, total revenue, avg order value
   - Return sorted by total revenue DESC

3. **`getTopCustomers(limit: number = 20): Promise<CustomerRFM[]>`**
   - Call getRFMSegments()
   - Return top N by monetary value
   - Include all RFM metrics

**Technical approach:**
- Use createAdminClient() for admin-only access
- Query orders with email grouping
- Calculate RFM metrics in application (Map aggregation)
- Score quintiles by sorting customers and dividing into 5 groups
- All revenue values in cents
- French segment labels

**Verification:**
- TypeScript types compile
- Functions return correct data shape
- RFM scores calculated accurately
- Segments assigned correctly

---

### Task 2: Create customer segmentation visualization components
**Files:**
- `src/components/admin/RFMDistribution.tsx`
- `src/components/admin/CustomerSegments.tsx`
- `src/components/admin/TopCustomers.tsx`

**Component 1: RFMDistribution**
- Props: `stats: CustomerSegmentStats[]`
- Display: Horizontal bar chart showing customer count per segment
- Color coding: VIP (accent/blush), Champions (green), Fidèles (blue), À Risque (orange), Inactifs (gray)
- Show percentage next to each bar
- Total customers count at top
- Empty state: "Aucun client trouvé"

**Component 2: CustomerSegments**
- Props: `stats: CustomerSegmentStats[]`
- Display: Table with segment stats
- Columns: Segment, Clients, Revenu Total, Panier Moyen
- Highlight VIP and Champions rows
- French number formatting
- Sorted by total revenue DESC

**Component 3: TopCustomers**
- Props: `customers: CustomerRFM[]` (top 20)
- Display: Table with customer details
- Columns: Rang, Client (name + email), Segment (badge), Commandes, Revenu Total, Panier Moyen, Dernière Commande
- Segment badges with color coding
- Top 3 customers highlighted with accent color
- French date formatting for last order
- Alternating row backgrounds

**Design:**
- Reuse admin panel styling (Charcoal/Cream/Mist/Blush)
- French labels throughout
- Server components (no "use client" unless needed for interactivity)
- Graceful empty states
- Responsive tables (scroll on mobile)

**Verification:**
- Components render without errors
- Empty states display correctly
- French formatting applied
- Color coding matches segment definitions

---

### Task 3: Create /admin/analytics/customers dashboard page
**File:** `src/app/admin/analytics/customers/page.tsx`

Build comprehensive customer intelligence dashboard:

**Layout:**
```
┌─────────────────────────────────────┐
│ Customer Intelligence               │
│ ─────────────────────────────────── │
│ [Total Customers] [VIP Count]       │
│ [Active] [At Risk] [Churned]        │
│ ─────────────────────────────────── │
│ RFM Distribution (bar chart)        │
│ ─────────────────────────────────── │
│ Customer Segments (table)           │
│ ─────────────────────────────────── │
│ Top Customers (table)               │
└─────────────────────────────────────┘
```

**Data fetching:**
- `const segments = await getRFMSegments()`
- `const stats = await getCustomerSegmentStats()`
- `const topCustomers = await getTopCustomers(20)`

**Summary KPIs:**
- Total Customers: `segments.length`
- VIP Count: `stats.find(s => s.segment === 'VIP')?.count || 0`
- Active Customers: VIP + Champions + Fidèles count
- At Risk: À Risque segment count
- Churned: Inactifs segment count

**Components:**
- 5 KPI cards (using StatCard pattern from Phase 21)
- RFMDistribution component
- CustomerSegments component
- TopCustomers component

**Error handling:**
- Try/catch per data source
- Graceful fallback to empty arrays
- Error messages in French

**Styling:**
- Consistent with /admin/analytics/sales from Phase 22
- Spacing and section dividers
- Responsive grid layout

**Verification:**
- Page renders without errors
- All KPIs display correctly
- Charts and tables populated
- Navigation link in admin sidebar works (already exists from Phase 21)

---

## Execution Strategy

1. **Sequential task execution** (each task depends on previous)
   - Task 1: Build data layer (customer-analytics.ts)
   - Task 2: Build UI components (visualization)
   - Task 3: Assemble dashboard page

2. **Verification after each task:**
   - npm run build (TypeScript validation)
   - Visual check of components/page
   - Data accuracy validation

3. **Git commits:**
   - One commit per task
   - Format: `feat(23-01): {task description}`

## Verification

After all tasks:
- [ ] npm run build succeeds
- [ ] /admin/analytics/customers page loads
- [ ] RFM segments calculated correctly
- [ ] Customer distribution visualized
- [ ] Top customers ranked by revenue
- [ ] French labels and formatting throughout
- [ ] Error handling prevents page crashes

## Success Criteria

**Functional:**
- Admin can view customer segments (VIP, Champions, Fidèles, À Risque, Inactifs)
- RFM scores calculated using quintile method
- Customers ranked by total revenue
- Purchase patterns visible (frequency, avg order value, recency)

**Technical:**
- Clean TypeScript compilation
- Server-side data fetching (no client state)
- Graceful error handling
- French localization
- Consistent admin panel styling

**Business Value:**
- Identify top 20% customers (VIP + Champions)
- Detect at-risk customers for retention campaigns
- Understand customer purchase behavior
- Data-driven marketing segmentation

## Output

- `src/lib/customer-analytics.ts` - Customer intelligence query helpers
- `src/components/admin/RFMDistribution.tsx` - Segment distribution chart
- `src/components/admin/CustomerSegments.tsx` - Segment stats table
- `src/components/admin/TopCustomers.tsx` - Top customers ranking
- `src/app/admin/analytics/customers/page.tsx` - Customer intelligence dashboard
