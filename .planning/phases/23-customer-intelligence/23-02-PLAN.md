---
phase: 23-customer-intelligence
plan: 02
wave: 2
autonomous: true
subsystem: analytics
tags: [cohort-analysis, ltv, retention, customer-lifetime-value]

# Dependency graph
requires:
  - phase: 23-01
    provides: customer-analytics.ts library, RFM analysis foundation
  - phase: 22-sales-analytics
    provides: analytics visualization patterns
provides:
  - Cohort analysis helpers (getCohorts, getCohortRetention, getCustomerLTV)
  - LTV tracking components (CohortRetention, LTVMetrics, CustomerBehavior)
  - Enhanced /admin/analytics/customers page with cohort and LTV insights
affects: [future-retention-campaigns, future-predictive-analytics]

# Tech tracking
tech-stack:
  added: []
  patterns: [cohort analysis, retention tracking, LTV calculation, behavioral metrics]

key-files:
  to-create:
    - src/components/admin/CohortRetention.tsx
    - src/components/admin/LTVMetrics.tsx
    - src/components/admin/CustomerBehavior.tsx
  to-modify:
    - src/lib/customer-analytics.ts (add cohort and LTV helpers)
    - src/app/admin/analytics/customers/page.tsx (add cohort and LTV sections)

key-decisions:
  - "Cohorts defined by month of first purchase (YYYY-MM)"
  - "Retention measured as % of cohort making repeat purchases in subsequent months"
  - "LTV calculated as total revenue + projected future value (avg order value × expected purchases)"
  - "Behavioral metrics: purchase frequency, category affinity, browse-to-purchase conversion"
  - "90-day LTV projection based on cohort average purchase frequency"
  - "Query orders + browse_history + wishlist for comprehensive behavior"

patterns-to-establish:
  - "Monthly cohort retention matrix (heatmap visualization)"
  - "LTV metrics dashboard with current and projected values"
  - "Customer behavior cards with conversion metrics"
  - "French cohort labels (janvier 2026, février 2026, etc.)"

issues-to-defer: []
---

# Plan 23-02: Cohort Analysis & Lifetime Value Tracking

**Build cohort retention analysis and lifetime value tracking to measure customer retention over time and project future revenue per customer**

## Objective

Create cohort analysis and LTV tracking to measure customer retention rates, understand cohort performance over time, and calculate customer lifetime value for strategic decision-making.

**Purpose:** Enable retention strategy optimization by understanding which customer cohorts have best retention, how LTV varies by segment, and what behaviors correlate with higher customer value.

## Context

### What We Have
- RFM segmentation from Plan 23-01
- customer-analytics.ts library foundation
- orders, profiles, browse_history, wishlist tables
- Analytics visualization patterns from Phase 22

### What We Need
1. Cohort grouping by first purchase month
2. Retention rate calculation (% returning each month)
3. LTV calculation (historical + projected)
4. Behavioral metrics (browse/wishlist/purchase conversion)
5. Visualization components for cohorts and LTV

### Success Criteria
- Admin can see monthly cohort retention matrix
- LTV metrics show current and projected customer value
- Behavioral insights show conversion patterns
- All metrics integrated into /admin/analytics/customers page

## Tasks

### Task 1: Add cohort and LTV helpers to customer-analytics.ts
**File:** `src/lib/customer-analytics.ts` (extend existing)

Add new interfaces and helper functions for cohort analysis:

**New Interfaces:**
```typescript
export interface Cohort {
  cohortMonth: string; // YYYY-MM
  cohortLabel: string; // "Janvier 2026"
  customerCount: number;
  firstOrderTotal: number; // cents
  totalRevenue: number; // cents (all-time)
  retention: Record<number, number>; // month offset → % retained
  // e.g., { 0: 100, 1: 45, 2: 38, 3: 32 }
}

export interface CustomerLTV {
  email: string;
  currentLTV: number; // cents (total spent to date)
  projectedLTV: number; // cents (current + expected future)
  orderCount: number;
  avgOrderValue: number; // cents
  daysSinceFirstOrder: number;
  purchaseFrequency: number; // orders per 90 days
  expectedFutureOrders: number; // projected orders in next 90 days
  segment: string; // from RFM
}

export interface BehavioralMetrics {
  totalCustomers: number;
  browsersOnly: number; // browsed but never purchased
  wishlisters: number; // added to wishlist
  purchasers: number; // made at least 1 purchase
  browseToCart: number; // % who browse and add to cart
  wishlistToPurchase: number; // % who wishlist and purchase
  avgDaysToPurchase: number; // avg days from first browse to first purchase
}
```

**New Helper Functions:**

1. **`getCohorts(): Promise<Cohort[]>`**
   - Query orders grouped by month of first order per customer
   - For each cohort month (e.g., "2026-01"):
     - Count unique customers
     - Sum first order totals
     - Sum all-time revenue from cohort customers
     - Calculate retention for each subsequent month:
       - Month 0: 100% (everyone has at least 1 order)
       - Month 1: % who ordered again in next month
       - Month 2: % who ordered again by month 2
       - etc.
   - Return cohorts sorted by cohortMonth DESC (newest first)
   - French month labels: "Janvier 2026", "Février 2026"

2. **`getCustomerLTV(email?: string): Promise<CustomerLTV[]>`**
   - If email provided, return LTV for specific customer
   - Otherwise, return LTV for all customers
   - Calculate per customer:
     - currentLTV: sum of all order totals
     - orderCount: count of orders
     - avgOrderValue: currentLTV / orderCount
     - daysSinceFirstOrder: today - first order date
     - purchaseFrequency: (orderCount - 1) / (daysSinceFirstOrder / 90)
       - How many orders per 90 days (excluding first order)
     - expectedFutureOrders: purchaseFrequency (next 90 days)
     - projectedLTV: currentLTV + (expectedFutureOrders × avgOrderValue)
   - Join with RFM segments to include segment
   - Return sorted by projectedLTV DESC

3. **`getBehavioralMetrics(): Promise<BehavioralMetrics>`**
   - Count total authenticated users (from profiles)
   - Browsers: users with browse_history but no orders
   - Wishlisters: users with wishlist entries
   - Purchasers: users with orders
   - Browse-to-cart conversion: users who browsed product then added to cart (from analytics_events)
   - Wishlist-to-purchase: users who wishlisted product then purchased
   - Avg days to purchase: avg(first_order_date - profile_created_at) for purchasers

**Technical approach:**
- Use createAdminClient() for all queries
- Application-level aggregation using Map/Set
- Cohort retention calculation:
  - For each cohort, track which customers ordered in month 0, 1, 2, etc.
  - Retention[N] = (customers who ordered by month N / total cohort) × 100
- LTV projection assumes past purchase frequency continues
- French month formatting using Intl.DateTimeFormat

**Verification:**
- TypeScript compiles
- Cohort retention calculates correctly
- LTV projection formula accurate
- Behavioral metrics return expected ranges

---

### Task 2: Create cohort and LTV visualization components
**Files:**
- `src/components/admin/CohortRetention.tsx`
- `src/components/admin/LTVMetrics.tsx`
- `src/components/admin/CustomerBehavior.tsx`

**Component 1: CohortRetention**
- Props: `cohorts: Cohort[]`
- Display: Retention matrix (heatmap-style table)
- Rows: Cohort months (Janvier 2026, Février 2026, etc.)
- Columns: Month 0, Month 1, Month 2, ... (up to 6 months)
- Cells: Retention percentage with color intensity (100% = darkest, 0% = lightest)
- Color scale: Blush (accent color) with opacity 20% to 100%
- Show customer count per cohort in first column
- Empty state: "Pas encore de données de cohorte"

**Component 2: LTVMetrics**
- Props: `ltvData: CustomerLTV[]` (top 20)
- Display: Summary cards + top customers table
- Summary cards (3 cards):
  - Avg Current LTV: average currentLTV across all customers
  - Avg Projected LTV: average projectedLTV across all customers
  - Avg Purchase Frequency: average purchaseFrequency
- Table columns: Client, Segment, LTV Actuel, LTV Projeté, Fréquence d'Achat, Panier Moyen
- Highlight top 5 customers by projected LTV
- French currency formatting
- Sort by projectedLTV DESC

**Component 3: CustomerBehavior**
- Props: `metrics: BehavioralMetrics`
- Display: Behavior funnel visualization
- Show progression: Total Users → Browsers → Wishlisters → Purchasers
- Conversion cards:
  - Browse-to-Cart: percentage + count
  - Wishlist-to-Purchase: percentage + count
  - Avg Days to First Purchase: number
- Visual funnel using decreasing width bars
- Conversion percentages in accent color if > 50%
- Empty state: "Données insuffisantes"

**Design:**
- Consistent with admin panel styling
- French labels and formatting
- Server components (no client state)
- Responsive layouts
- Graceful empty states

**Verification:**
- Components render without errors
- Heatmap colors apply correctly
- LTV calculations display accurately
- Funnel visualization shows progression

---

### Task 3: Integrate cohort and LTV into customer intelligence dashboard
**File:** `src/app/admin/analytics/customers/page.tsx` (modify)

Enhance existing dashboard with cohort and LTV sections:

**Updated Layout:**
```
┌─────────────────────────────────────┐
│ Customer Intelligence               │
│ ─────────────────────────────────── │
│ [KPIs from Plan 23-01]              │
│ ─────────────────────────────────── │
│ RFM Distribution                    │
│ Customer Segments                   │
│ ─────────────────────────────────── │
│ Lifetime Value Metrics (NEW)        │
│ ─────────────────────────────────── │
│ Cohort Retention Matrix (NEW)      │
│ ─────────────────────────────────── │
│ Customer Behavior Funnel (NEW)      │
│ ─────────────────────────────────── │
│ Top Customers                       │
└─────────────────────────────────────┘
```

**Additional data fetching:**
- `const cohorts = await getCohorts()`
- `const ltvData = await getCustomerLTV()`
- `const behaviorMetrics = await getBehavioralMetrics()`

**New sections:**
- **Lifetime Value Metrics section:**
  - H2: "Valeur Vie Client (LTV)"
  - LTVMetrics component with ltvData

- **Cohort Retention section:**
  - H2: "Rétention par Cohorte"
  - Description: "Taux de rétention mensuel par cohorte d'acquisition"
  - CohortRetention component with cohorts

- **Customer Behavior section:**
  - H2: "Comportement Client"
  - Description: "Conversion du parcours client"
  - CustomerBehavior component with behaviorMetrics

**Error handling:**
- Try/catch for each new data source
- Fallback to empty arrays/default values
- Display partial data if some sources fail

**Styling:**
- Section dividers between major sections
- Consistent spacing (mb-8 between sections)
- Responsive grid where appropriate
- Maintains existing RFM section layout

**Verification:**
- Page loads without errors
- All sections render correctly
- Data flows to new components
- Existing RFM sections unchanged
- French labels throughout

---

## Execution Strategy

1. **Sequential task execution:**
   - Task 1: Extend customer-analytics.ts with cohort/LTV helpers
   - Task 2: Build visualization components
   - Task 3: Integrate into dashboard page

2. **Verification after each task:**
   - npm run build (TypeScript validation)
   - Visual check of new components
   - Data accuracy validation (cohort math, LTV projection)

3. **Git commits:**
   - One commit per task
   - Format: `feat(23-02): {task description}`

## Verification

After all tasks:
- [ ] npm run build succeeds
- [ ] Cohort retention matrix displays correctly
- [ ] LTV metrics show current and projected values
- [ ] Behavioral funnel shows conversion rates
- [ ] All metrics integrated into /admin/analytics/customers page
- [ ] French labels and formatting throughout
- [ ] Error handling prevents page crashes

## Success Criteria

**Functional:**
- Cohort retention rates calculated and visualized
- LTV projection formula accurate and actionable
- Behavioral metrics show customer journey conversion
- Comprehensive customer intelligence dashboard

**Technical:**
- Clean TypeScript compilation
- Server-side data fetching
- Graceful error handling
- French localization
- Consistent styling

**Business Value:**
- Measure customer retention over time
- Identify high-LTV customers for VIP treatment
- Understand which cohorts have best retention
- Optimize conversion funnel based on behavior metrics
- Project future revenue from customer base

## Output

- `src/lib/customer-analytics.ts` - Extended with cohort and LTV helpers
- `src/components/admin/CohortRetention.tsx` - Retention heatmap matrix
- `src/components/admin/LTVMetrics.tsx` - LTV summary and top customers
- `src/components/admin/CustomerBehavior.tsx` - Conversion funnel visualization
- `src/app/admin/analytics/customers/page.tsx` - Enhanced with cohort and LTV sections
