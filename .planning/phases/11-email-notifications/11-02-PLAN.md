---
phase: 11-email-notifications
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified: [src/lib/orders.ts, src/app/commande/page.tsx]
autonomous: true
---

<objective>
Wire centralized email service into order lifecycle — all status changes and order creation trigger appropriate emails automatically from the server.

Purpose: Replace client-side fetch and HTTP self-call patterns with direct server-side email calls. Ensure every order status transition notifies the customer.
Output: Updated `lib/orders.ts` with email triggers on all status changes + updated checkout page removing client-side email fetch.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-email-notifications/11-01-SUMMARY.md

@src/lib/orders.ts
@src/lib/email.ts
@src/app/commande/page.tsx
@src/types/order.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire email triggers into order lifecycle</name>
  <files>src/lib/orders.ts</files>
  <action>
Update `src/lib/orders.ts` to use the centralized email service from `src/lib/email.ts`.

Changes to `createOrder()`:
- After writing the order to file and before returning, call `sendOrderConfirmationEmail(newOrder)` in background (don't await — use `.catch()` pattern to log errors without blocking)
- This replaces the client-side fetch in the checkout page

Changes to `updateOrderStatus()`:
- Remove the existing HTTP self-call `fetch()` block that sends shipping emails (lines ~162-171)
- Replace with centralized email calls based on status:
  - Status → "shipped" AND trackingNumber exists: call `sendShippingNotificationEmail(orders[index])` (non-blocking)
  - Status → "confirmed", "processing", "delivered", "cancelled": call `sendOrderStatusUpdateEmail(orders[index], status, previousStatus)` (non-blocking)
  - Status → "pending": no email (this is the initial state)
- All email calls must be non-blocking: use `sendXxx(...).catch(err => console.error(...))` pattern
- Pass the OLD status as `oldStatus` param — capture it before updating the order object

Import `sendOrderConfirmationEmail`, `sendShippingNotificationEmail`, `sendOrderStatusUpdateEmail` from `@/lib/email`.

CRITICAL: Email failures must NEVER prevent order operations. All email calls are fire-and-forget with error logging.
  </action>
  <verify>
1. `npm run build` succeeds
2. Read the file and confirm: no `fetch()` calls to `/api/send-*` remain in orders.ts
3. Confirm email functions are called non-blocking (no `await` on email calls)
  </verify>
  <done>
- createOrder sends confirmation email automatically
- updateOrderStatus sends appropriate email for every status change
- No HTTP self-calls remain in orders.ts
- All email calls are non-blocking
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove client-side email fetch from checkout</name>
  <files>src/app/commande/page.tsx</files>
  <action>
Remove the client-side email sending block from the checkout page's `handleSubmit` function.

Delete the entire `fetch("/api/send-order-email", ...)` block (lines ~63-70) including the `.catch()` handler. The email is now sent server-side by `createOrder()` in lib/orders.ts.

No other changes needed — the order creation, cart clearing, and redirect all stay the same.
  </action>
  <verify>`npm run build` succeeds, no reference to `send-order-email` in commande/page.tsx</verify>
  <done>Checkout page no longer sends emails from client — fully handled server-side</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No HTTP self-calls to email APIs in lib/orders.ts
- [ ] No client-side email fetch in checkout page
- [ ] All order status transitions trigger appropriate email type
- [ ] Email calls are non-blocking throughout
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Complete email automation: order creation → confirmation email, status change → status-specific email
- Zero client-side email sending — all server-side
  </success_criteria>

<output>
After completion, create `.planning/phases/11-email-notifications/11-02-SUMMARY.md`
</output>
