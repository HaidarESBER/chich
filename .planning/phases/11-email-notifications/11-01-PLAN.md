---
phase: 11-email-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/email.ts, src/emails/OrderStatusUpdateEmail.tsx]
autonomous: true
---

<objective>
Create centralized email service and status update email template.

Purpose: Replace fragile HTTP self-call pattern with direct Resend SDK calls, and add missing status change email template so all order lifecycle transitions notify the customer.
Output: `src/lib/email.ts` email service utility + `src/emails/OrderStatusUpdateEmail.tsx` template.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/emails/OrderConfirmationEmail.tsx
@src/emails/ShippingNotificationEmail.tsx
@src/app/api/send-order-email/route.ts
@src/app/api/send-shipping-email/route.ts
@src/types/order.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create centralized email service</name>
  <files>src/lib/email.ts</files>
  <action>
Create `src/lib/email.ts` with "use server" directive (server-only). This module wraps all Resend email sending into clean async functions that can be called directly from server actions — no HTTP self-calls.

Functions to export:
- `sendOrderConfirmationEmail(order: Order): Promise<{ success: boolean; error?: string }>` — renders OrderConfirmationEmail and sends via Resend
- `sendShippingNotificationEmail(order: Order): Promise<{ success: boolean; error?: string }>` — renders ShippingNotificationEmail and sends via Resend
- `sendOrderStatusUpdateEmail(order: Order, newStatus: OrderStatus, oldStatus: OrderStatus): Promise<{ success: boolean; error?: string }>` — renders OrderStatusUpdateEmail and sends via Resend

Implementation details:
- Lazy-initialize Resend client (same pattern as existing API routes)
- `from` address: `"Nuage <commandes@nuage.fr>"` (matches existing)
- If RESEND_API_KEY is missing, return `{ success: false, error: "Email service not configured" }` — don't throw
- Log errors with console.error but never throw — email failures must not break order operations
- Import email components directly and pass as `react` prop to `resend.emails.send()`

Do NOT modify the existing API routes — they remain as external-facing endpoints. This lib is for internal server-side use.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit src/lib/email.ts` or run `npm run build`</verify>
  <done>email.ts exports 3 functions, each returns success/error object, never throws</done>
</task>

<task type="auto">
  <name>Task 2: Create order status update email template</name>
  <files>src/emails/OrderStatusUpdateEmail.tsx</files>
  <action>
Create `src/emails/OrderStatusUpdateEmail.tsx` using React Email components. This template handles all non-shipping status changes: confirmed, processing, delivered, cancelled.

Follow the exact same brand styling as existing templates (OrderConfirmationEmail, ShippingNotificationEmail):
- Brand colors: #2C2C2C (charcoal), #D4A5A5 (blush), #F7F5F3 (cream bg), #6B6B6B (muted text)
- Header: "Nuage" heading + "L'Art de la Détente" tagline
- Footer: "Des questions?" + copyright
- Same font stack, spacing, and structure

Props: `{ order: Order; newStatus: OrderStatus; oldStatus: OrderStatus }`

Content varies by status:
- **confirmed**: "Votre commande a été confirmée !" — We've received your order and are preparing it. Show order number and items summary.
- **processing**: "Votre commande est en préparation" — Items are being carefully prepared. Show order number.
- **delivered**: "Votre commande a été livrée !" — Your order has been delivered. Show order number, items, and a "Des questions?" section. Include link to tracking page: `/suivi/${orderNumber}`.
- **cancelled**: "Votre commande a été annulée" — Sorry, your order has been cancelled. Show order number and "contactez-nous" message.

Use a `getStatusContent(newStatus)` helper inside the component that returns `{ previewText, heading, bodyText, showItems, showTrackingLink }` for each status.

Subject line pattern: Use order status labels from the status — e.g., "Mise à jour de votre commande {orderNumber} — {statusLabel}"

Do NOT add emojis (except for delivered which can have a checkmark icon section).
  </action>
  <verify>TypeScript compiles without errors: `npm run build`</verify>
  <done>OrderStatusUpdateEmail renders branded template with status-specific content for confirmed, processing, delivered, and cancelled statuses</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `src/lib/email.ts` exports 3 async functions
- [ ] `src/emails/OrderStatusUpdateEmail.tsx` renders for all 4 status types
- [ ] No TypeScript errors introduced
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Email service functions return result objects (never throw)
- Status update template follows existing brand styling exactly
  </success_criteria>

<output>
After completion, create `.planning/phases/11-email-notifications/11-01-SUMMARY.md`
</output>
