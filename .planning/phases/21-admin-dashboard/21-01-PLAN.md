---
phase: 21-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: ["20-02"]
files_modified: [src/app/admin/page.tsx, src/components/admin/DashboardKPIs.tsx, src/components/admin/RealtimeActivity.tsx]
autonomous: true
---

<objective>
Transform basic admin dashboard into comprehensive analytics overview with KPIs, summary cards, and real-time activity feed.

Purpose: Provide at-a-glance business health metrics and live visitor activity for quick decision-making.
Output: Enhanced main admin dashboard with analytics integration and real-time event stream.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-analytics-foundation/20-01-SUMMARY.md
@.planning/phases/20-analytics-foundation/20-02-PLAN.md

# Dependencies:
# - Plan 20-02 creates analytics-server.ts with query helpers:
#   - getMetricsSummary() for KPI data
#   - getRealtimeEvents() for activity feed
# - Current admin dashboard at src/app/admin/page.tsx has basic product/order stats

# Goal:
# - Replace basic stats with comprehensive analytics KPIs
# - Add summary cards: sessions, users, revenue, conversion rate
# - Add real-time activity feed showing recent visitor actions
# - Maintain existing quick actions section

@src/app/admin/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable KPI dashboard component</name>
  <files>src/components/admin/DashboardKPIs.tsx</files>
  <action>
Create DashboardKPIs component displaying business metrics from analytics:

Component structure:
- Accept props: { metricsSummary: MetricsSummary } from getMetricsSummary()
- Display 6 KPI cards in responsive grid (2 cols mobile, 3 cols tablet, 6 cols desktop)

KPI Cards (use existing StatCard pattern from admin/page.tsx):
1. Total Sessions (last 30 days)
   - Value: metricsSummary.totalSessions
   - Description: "Visites uniques"

2. Total Users (authenticated)
   - Value: metricsSummary.totalUsers
   - Description: "Utilisateurs connectÃ©s"

3. Total Revenue
   - Value: Format as EUR currency (metricsSummary.totalRevenue / 100)
   - Description: "Chiffre d'affaires"
   - Highlight: true (accent color)

4. Total Purchases
   - Value: metricsSummary.totalPurchases
   - Description: "Commandes payÃ©es"

5. Avg Revenue Per User
   - Value: Format as EUR currency (metricsSummary.avgRevenuePerUser / 100)
   - Description: "Panier moyen"

6. Conversion Rate
   - Value: Format as percentage (metricsSummary.conversionRate.toFixed(2) + "%")
   - Description: "Taux de conversion"
   - Highlight if > 2% (good performance)

Styling:
- Reuse existing StatCard component from admin/page.tsx
- Grid layout with gap-6
- Charcoal text, Cream background, Blush accents for highlights

TypeScript:
- Import MetricsSummary from src/lib/analytics-server.ts
- Server component (no "use client")
- Export default DashboardKPIs
  </action>
  <verify>Import DashboardKPIs in test file, render with mock data, verify 6 cards display correctly</verify>
  <done>Reusable KPI component created displaying 6 key business metrics with proper formatting</done>
</task>

<task type="auto">
  <name>Task 2: Create real-time activity feed component</name>
  <files>src/components/admin/RealtimeActivity.tsx</files>
  <action>
Create RealtimeActivity component showing recent visitor events:

Component structure:
- Accept props: { events: AnalyticsEvent[] } from getRealtimeEvents()
- Display max 10 most recent events in scrollable list
- Show event type, timestamp, and relevant details

Event display format (use event_type to determine display):
- page_view: "ðŸ“„ Page vue: {url}" (extract pathname from url)
- product_view: "ðŸ‘ï¸ Produit vu: {event_data.productName || productId}"
- add_to_cart: "ðŸ›’ Ajout panier: {event_data.productName}"
- remove_from_cart: "âŒ Retrait panier: {event_data.productName}"
- checkout_started: "ðŸ’³ Paiement dÃ©marrÃ©"
- purchase: "âœ… Achat: {event_data.total / 100}â‚¬"
- search: "ðŸ” Recherche: {event_data.query}"
- wishlist_add: "â¤ï¸ Ajout favoris: {event_data.productName}"

Timestamp display:
- Format created_at as relative time ("il y a 2 minutes", "il y a 1 heure")
- Use Intl.RelativeTimeFormat for French formatting
- Fallback to absolute time if > 24 hours

Layout:
- Container with border, max height 400px, overflow-y-auto
- Each event as row with icon, description, timestamp
- Alternating subtle background colors for readability
- Empty state: "Aucune activitÃ© rÃ©cente" if no events

User indicator:
- Show "ðŸ‘¤ Utilisateur" if event has user_id
- Show "ðŸ‘» Visiteur" if anonymous (no user_id)

Styling:
- Consistent with admin panel design
- Charcoal text, Cream/Mist backgrounds
- Monospace font for timestamps
- Icons as emoji (no external icon library needed)

TypeScript:
- Import AnalyticsEvent from src/types/analytics.ts
- Server component (no "use client")
- Export default RealtimeActivity
  </action>
  <verify>Import RealtimeActivity with mock events, verify all event types render correctly with proper icons and formatting</verify>
  <done>Real-time activity feed component created showing recent visitor actions with formatted timestamps and event details</done>
</task>

<task type="auto">
  <name>Task 3: Enhance main admin dashboard with analytics</name>
  <files>src/app/admin/page.tsx</files>
  <action>
Replace basic product/order stats with comprehensive analytics dashboard:

Keep existing structure:
- Welcome header
- Quick Actions section (no changes)

Replace stats sections with analytics:
1. Remove existing productStats and orderStats calls
2. Add analytics imports:
   - Import { getMetricsSummary, getRealtimeEvents } from "@/lib/analytics-server"
   - Import DashboardKPIs from "@/components/admin/DashboardKPIs"
   - Import RealtimeActivity from "@/components/admin/RealtimeActivity"

3. Fetch analytics data:
   ```typescript
   const metricsSummary = await getMetricsSummary(30); // last 30 days
   const realtimeEvents = await getRealtimeEvents(10); // last 10 events
   ```

4. Replace stat grids with:
   - DashboardKPIs component (pass metricsSummary)
   - RealtimeActivity component (pass realtimeEvents)

Layout structure:
```tsx
<div className="space-y-8">
  {/* Welcome - keep existing */}

  {/* KPIs */}
  <div>
    <h3 className="text-lg font-heading font-semibold text-primary mb-4">
      MÃ©triques ClÃ©s (30 derniers jours)
    </h3>
    <DashboardKPIs metricsSummary={metricsSummary} />
  </div>

  {/* Real-time Activity */}
  <div>
    <h3 className="text-lg font-heading font-semibold text-primary mb-4">
      ActivitÃ© en Temps RÃ©el
    </h3>
    <RealtimeActivity events={realtimeEvents} />
  </div>

  {/* Quick Actions - keep existing */}
</div>
```

Remove old StatCard component (now in DashboardKPIs):
- Delete StatCard function definition
- Remove productStats/orderStats logic

Error handling:
- Add try/catch around analytics calls
- Fallback to empty data if queries fail
- Log errors but don't break page load

Why not keep product/order stats:
- Superseded by comprehensive KPIs (sessions, revenue, purchases)
- Product count available in dedicated /admin/produits page
- Order count available in dedicated /admin/commandes page
- Dashboard focus: business performance, not inventory counts
  </action>
  <verify>Visit /admin in browser, verify KPIs display with real data, activity feed shows recent events, quick actions still work</verify>
  <done>Main admin dashboard enhanced with analytics KPIs and real-time activity, replacing basic stats with comprehensive business metrics</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] DashboardKPIs component renders 6 KPI cards
- [ ] RealtimeActivity component displays events with icons and timestamps
- [ ] Main admin dashboard shows analytics data
- [ ] Quick actions section still functional
- [ ] No errors in browser console
- [ ] Page loads without database errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Admin dashboard displays comprehensive KPIs (sessions, users, revenue, conversion)
- Real-time activity feed shows recent visitor actions
- Components reusable for future analytics pages
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/21-admin-dashboard/21-01-SUMMARY.md`
</output>
