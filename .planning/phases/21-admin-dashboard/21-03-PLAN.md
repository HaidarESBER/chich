---
phase: 21-admin-dashboard
plan: 03
type: execute
wave: 1
depends_on: ["20-02"]
files_modified: [src/app/admin/analytics/products/page.tsx, src/components/admin/TopProducts.tsx, src/components/admin/SearchAnalytics.tsx, src/app/admin/layout.tsx]
autonomous: true
---

<objective>
Create product analytics page showing best sellers, most viewed products, search insights, and product performance metrics.

Purpose: Help identify popular products, optimize inventory, and understand customer search behavior.
Output: /admin/analytics/products page with product performance tables and search analytics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-analytics-foundation/20-01-SUMMARY.md
@.planning/phases/20-analytics-foundation/20-02-PLAN.md

# Dependencies:
# - Plan 20-02 creates analytics-server.ts with getTopEvents() helper
# - analytics_events table has product_view, add_to_cart, search events

# Goal:
# - Show most viewed products (from product_view events)
# - Show products added to cart most often (conversion insight)
# - Show top search queries (understand what customers want)
# - Simple table-based display (no charts needed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create top products component</name>
  <files>src/components/admin/TopProducts.tsx</files>
  <action>
Create TopProducts component displaying most viewed and most added to cart products:

Component structure:
- Accept props: { viewedProducts: TopEvent[], cartProducts: TopEvent[] }
- Display two tables side by side (stack on mobile)

TopEvent interface (from analytics-server.ts):
```typescript
interface TopEvent {
  key: string; // productId or search query
  count: number;
  metadata?: { productName?: string }; // enriched data
}
```

Table 1: Most Viewed Products
- Columns: Rank, Product, Views
- Top 10 products by product_view events
- Show product name if available, otherwise show productId
- Format count with space thousands separator

Table 2: Most Added to Cart
- Columns: Rank, Product, Additions
- Top 10 products by add_to_cart events
- Show product name and count
- Highlight if conversion rate > 10% (views to cart)

Layout:
```tsx
<div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
  {/* Most Viewed */}
  <div>
    <h4 className="text-md font-heading font-semibold text-primary mb-3">
      Produits Les Plus Vus
    </h4>
    <table className="w-full">
      <thead>
        <tr>
          <th className="text-left">#</th>
          <th className="text-left">Produit</th>
          <th className="text-right">Vues</th>
        </tr>
      </thead>
      <tbody>
        {viewedProducts.map((product, idx) => (
          <tr key={product.key}>
            <td>{idx + 1}</td>
            <td>{product.metadata?.productName || product.key}</td>
            <td className="text-right">{product.count.toLocaleString('fr-FR')}</td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  {/* Most Added to Cart */}
  <div>
    <h4 className="text-md font-heading font-semibold text-primary mb-3">
      Produits Les Plus Ajout√©s au Panier
    </h4>
    <table className="w-full">
      {/* Similar structure */}
    </table>
  </div>
</div>
```

Styling:
- Table borders and padding for readability
- Alternating row backgrounds (Mist/Cream)
- Highlight top 3 rows with subtle accent color
- Responsive: stack tables on mobile

Empty state:
- If no data: "Aucune donn√©e disponible"

TypeScript:
- Import TopEvent from src/lib/analytics-server.ts
- Server component
- Export default TopProducts
  </action>
  <verify>Render TopProducts with mock data, verify tables display correctly, formatting works</verify>
  <done>Top products component created showing most viewed and most added to cart products in tables</done>
</task>

<task type="auto">
  <name>Task 2: Create search analytics component</name>
  <files>src/components/admin/SearchAnalytics.tsx</files>
  <action>
Create SearchAnalytics component displaying top search queries and insights:

Component structure:
- Accept props: { topSearches: TopEvent[] }
- Display search queries table with counts

Table: Top Search Queries
- Columns: Rank, Query, Count
- Top 20 search queries
- Show query text and search count
- Highlight queries with 0 results (opportunity to add products)

Layout:
```tsx
<div>
  <h4 className="text-md font-heading font-semibold text-primary mb-3">
    Recherches Les Plus Fr√©quentes
  </h4>
  <table className="w-full">
    <thead>
      <tr>
        <th className="text-left">#</th>
        <th className="text-left">Requ√™te</th>
        <th className="text-right">Recherches</th>
        <th className="text-right">Statut</th>
      </tr>
    </thead>
    <tbody>
      {topSearches.map((search, idx) => (
        <tr key={search.key}>
          <td>{idx + 1}</td>
          <td className="font-mono">{search.key}</td>
          <td className="text-right">{search.count.toLocaleString('fr-FR')}</td>
          <td className="text-right">
            {/* Show badge if metadata.resultsCount === 0 */}
            {search.metadata?.resultsCount === 0 && (
              <span className="text-xs bg-accent text-primary px-2 py-1 rounded">
                0 r√©sultats
              </span>
            )}
          </td>
        </tr>
      ))}
    </tbody>
  </table>

  {/* Summary insight */}
  <p className="mt-4 text-sm text-primary/70">
    üí° Astuce: Les recherches avec 0 r√©sultats indiquent des opportunit√©s d'ajout de produits
  </p>
</div>
```

Metadata enrichment (optional for this task):
- getTopEvents() returns basic { key, count }
- Future enhancement: join with search results to show resultsCount
- For now: just display query and count

Styling:
- Monospace font for search queries (better readability)
- Badge for 0 results (accent background)
- Table styling consistent with TopProducts

TypeScript:
- Import TopEvent from src/lib/analytics-server.ts
- Server component
- Export default SearchAnalytics
  </action>
  <verify>Render SearchAnalytics with mock search data, verify table displays, 0 results badge shows</verify>
  <done>Search analytics component created showing top queries and highlighting opportunities</done>
</task>

<task type="auto">
  <name>Task 3: Create product analytics page and add navigation</name>
  <files>src/app/admin/analytics/products/page.tsx, src/app/admin/layout.tsx</files>
  <action>
Create product analytics page and integrate navigation:

1. Create /admin/analytics/products page:
```typescript
import { getTopEvents } from "@/lib/analytics-server";
import TopProducts from "@/components/admin/TopProducts";
import SearchAnalytics from "@/components/admin/SearchAnalytics";
import Link from "next/link";

export const dynamic = "force-dynamic";

export const metadata = {
  title: "Analyse des Produits - Admin Nuage",
  description: "Performance des produits et insights de recherche",
};

export default async function ProductAnalyticsPage() {
  // Fetch top events
  const viewedProducts = await getTopEvents("product_view", 10);
  const cartProducts = await getTopEvents("add_to_cart", 10);
  const topSearches = await getTopEvents("search", 20);

  return (
    <div className="space-y-8">
      {/* Header */}
      <div>
        <Link href="/admin" className="text-accent hover:underline">
          ‚Üê Retour au tableau de bord
        </Link>
        <h2 className="mt-4 text-2xl font-heading font-semibold text-primary">
          Analyse des Produits
        </h2>
        <p className="mt-2 text-primary/70">
          Performance des produits et insights de recherche
        </p>
      </div>

      {/* Top Products */}
      <section>
        <TopProducts viewedProducts={viewedProducts} cartProducts={cartProducts} />
      </section>

      {/* Search Analytics */}
      <section>
        <SearchAnalytics topSearches={topSearches} />
      </section>
    </div>
  );
}
```

Error handling:
- Add try/catch around getTopEvents() calls
- Empty state if no data
- Log errors but don't crash

2. Add analytics navigation to admin layout:

Modify src/app/admin/layout.tsx to add analytics menu:
- Current layout has navigation for products, orders, curation, scraper
- Add new section: "Analytics" with links to:
  - /admin (Dashboard)
  - /admin/analytics/revenue (Revenue)
  - /admin/analytics/products (Products)

Navigation structure:
```tsx
<nav className="space-y-2">
  {/* Existing nav items */}

  <div className="pt-4 border-t border-primary/10">
    <p className="text-xs font-semibold text-primary/50 uppercase mb-2">
      Analytics
    </p>
    <Link href="/admin" className="nav-link">
      üìä Dashboard
    </Link>
    <Link href="/admin/analytics/revenue" className="nav-link">
      üí∞ Revenus
    </Link>
    <Link href="/admin/analytics/products" className="nav-link">
      üì¶ Produits
    </Link>
  </div>
</nav>
```

Styling:
- Use existing nav-link classes from admin layout
- Match existing navigation patterns
- Keep consistent spacing and colors

Alternative (if layout is complex):
- Add "Analytics" link to main dashboard Quick Actions
- Simple approach: links to revenue and products pages from dashboard
- Can enhance layout later if needed
  </action>
  <verify>Visit /admin/analytics/products, verify tables display, navigation works, page loads correctly</verify>
  <done>Product analytics page created with navigation, showing product performance and search insights</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] TopProducts component displays two tables
- [ ] SearchAnalytics shows top queries
- [ ] /admin/analytics/products page loads correctly
- [ ] Navigation from admin dashboard works
- [ ] Tables handle empty data gracefully
- [ ] Layout integrates analytics navigation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Product analytics page shows most viewed and most added products
- Search analytics reveals customer search behavior
- Navigation integrated into admin panel
- Tables display data clearly with proper formatting
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/21-admin-dashboard/21-03-SUMMARY.md`
</output>
