---
phase: 21-admin-dashboard
plan: 02
type: execute
wave: 1
depends_on: ["20-02"]
files_modified: [src/app/admin/analytics/revenue/page.tsx, src/components/admin/RevenueChart.tsx, src/components/admin/OrderTrends.tsx]
autonomous: true
---

<objective>
Create dedicated revenue analytics page with time-series charts, order trends, and financial breakdowns.

Purpose: Provide detailed revenue insights for business planning and performance analysis.
Output: /admin/analytics/revenue page with interactive charts and trend visualization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-analytics-foundation/20-01-SUMMARY.md
@.planning/phases/20-analytics-foundation/20-02-PLAN.md

# Dependencies:
# - Plan 20-02 creates analytics-server.ts with getDailyMetrics() helper
# - daily_metrics table has revenue and purchase data per day

# Goal:
# - Create new /admin/analytics/revenue page
# - Display revenue trends over time (last 30 days)
# - Show order volume trends
# - Display average order value
# - Use pure HTML/CSS charts (no external charting library - keep it simple)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create revenue chart component</name>
  <files>src/components/admin/RevenueChart.tsx</files>
  <action>
Create RevenueChart component displaying daily revenue over time:

Component structure:
- Accept props: { data: DailyMetrics[] } - array of daily metrics (pre-sorted by date ASC)
- Display bar chart using HTML/CSS (no external library)
- Simple responsive chart container

Chart implementation (pure CSS):
- Container: 600px width (100% on mobile), 300px height
- X-axis: dates (show every 5th date to avoid crowding)
- Y-axis: revenue in EUR (format: "1 234€")
- Bars: vertical bars with height proportional to revenue
- Color: Blush for positive revenue, Mist for zero days

Layout:
```tsx
<div className="revenue-chart">
  <div className="chart-container">
    <div className="y-axis">
      {/* Max revenue label at top */}
      {/* Mid revenue label */}
      {/* 0€ at bottom */}
    </div>
    <div className="bars">
      {data.map(day => (
        <div className="bar-wrapper" key={day.date}>
          <div
            className="bar"
            style={{ height: `${(day.total_revenue / maxRevenue) * 100}%` }}
            title={`${day.date}: ${formatCurrency(day.total_revenue)}`}
          />
          <div className="bar-label">
            {formatDate(day.date)} {/* Show date if index % 5 === 0 */}
          </div>
        </div>
      ))}
    </div>
  </div>
  <p className="chart-caption">Chiffre d'affaires journalier (30 derniers jours)</p>
</div>
```

Helper functions:
- formatCurrency(cents): Convert cents to EUR with space thousand separator ("1 234€")
- formatDate(dateString): Format as "12 fév" (day + abbreviated month)
- Calculate maxRevenue: Math.max(...data.map(d => d.total_revenue))

Styling approach:
- Use Tailwind classes for layout
- Inline styles for dynamic bar heights
- Flexbox for bar container
- Responsive: stack on mobile, horizontal on desktop

Alternative if time-constrained:
- Use simple table with background bars (width proportional to revenue)
- Easier to implement, still provides visual trend

TypeScript:
- Import DailyMetrics from src/lib/analytics-server.ts
- Server component (no "use client")
- Export default RevenueChart
  </action>
  <verify>Render RevenueChart with 30 days of mock data, verify bars display proportionally, dates show correctly</verify>
  <done>Revenue chart component created displaying daily revenue trends with pure HTML/CSS visualization</done>
</task>

<task type="auto">
  <name>Task 2: Create order trends component</name>
  <files>src/components/admin/OrderTrends.tsx</files>
  <action>
Create OrderTrends component showing order volume and average order value metrics:

Component structure:
- Accept props: { data: DailyMetrics[] }
- Display 3 summary cards + simple trend chart

Summary cards (use StatCard pattern):
1. Total Orders (30 days)
   - Sum of data.map(d => d.purchases)
   - Description: "Commandes payées"

2. Average Orders Per Day
   - Total orders / 30
   - Format with 1 decimal: "3.2 commandes/jour"
   - Description: "Moyenne quotidienne"

3. Average Order Value
   - Sum of total_revenue / Sum of purchases
   - Format as currency: "€45.67"
   - Description: "Panier moyen"

Simple trend visualization:
- Line showing daily order count
- Similar to RevenueChart but smaller (200px height)
- Use dots connected by lines (simpler than bars)
- Color: Charcoal line, Blush dots

Layout:
```tsx
<div className="space-y-6">
  {/* Summary cards grid */}
  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
    <StatCard title="Total Commandes" value={totalOrders} description="30 derniers jours" />
    <StatCard title="Moyenne Quotidienne" value={avgPerDay} description="commandes/jour" />
    <StatCard title="Panier Moyen" value={formatCurrency(avgOrderValue)} description="par commande" />
  </div>

  {/* Trend chart */}
  <div className="order-trend-chart">
    {/* Simple line chart showing daily order count */}
  </div>
</div>
```

StatCard component:
- Reuse pattern from DashboardKPIs
- Can extract to shared component if needed (optional)

TypeScript:
- Import DailyMetrics from src/lib/analytics-server.ts
- Server component
- Export default OrderTrends
  </action>
  <verify>Render OrderTrends with mock data, verify summary cards calculate correctly, trend line displays</verify>
  <done>Order trends component created showing volume metrics and daily trend visualization</done>
</task>

<task type="auto">
  <name>Task 3: Create revenue analytics page</name>
  <files>src/app/admin/analytics/revenue/page.tsx</files>
  <action>
Create new admin page at /admin/analytics/revenue displaying revenue analytics:

Page structure:
- Fetch last 30 days of daily metrics using getDailyMetrics()
- Display revenue chart and order trends
- Add navigation back to main dashboard

Implementation:
```typescript
import { getDailyMetrics } from "@/lib/analytics-server";
import RevenueChart from "@/components/admin/RevenueChart";
import OrderTrends from "@/components/admin/OrderTrends";
import Link from "next/link";

export const dynamic = "force-dynamic";

export default async function RevenueAnalyticsPage() {
  // Fetch last 30 days
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - 30);

  const dailyMetrics = await getDailyMetrics(startDate, endDate);

  return (
    <div className="space-y-8">
      {/* Header with breadcrumb */}
      <div>
        <Link href="/admin" className="text-accent hover:underline">
          ← Retour au tableau de bord
        </Link>
        <h2 className="mt-4 text-2xl font-heading font-semibold text-primary">
          Analyse des Revenus
        </h2>
        <p className="mt-2 text-primary/70">
          Tendances et métriques financières sur 30 jours
        </p>
      </div>

      {/* Revenue chart */}
      <section>
        <h3 className="text-lg font-heading font-semibold text-primary mb-4">
          Évolution du Chiffre d'Affaires
        </h3>
        <RevenueChart data={dailyMetrics} />
      </section>

      {/* Order trends */}
      <section>
        <h3 className="text-lg font-heading font-semibold text-primary mb-4">
          Tendances des Commandes
        </h3>
        <OrderTrends data={dailyMetrics} />
      </section>
    </div>
  );
}
```

Error handling:
- Add try/catch around getDailyMetrics()
- If no data, show empty state: "Aucune donnée disponible"
- Log errors but don't crash page

Navigation:
- Update main dashboard (plan 21-01) to add link to revenue analytics
- Add to Quick Actions or new "Analytics" section

Page metadata:
```typescript
export const metadata = {
  title: "Analyse des Revenus - Admin Nuage",
  description: "Métriques et tendances financières",
};
```

Directory structure:
- Create src/app/admin/analytics/ directory
- Create src/app/admin/analytics/revenue/ subdirectory
- Place page.tsx in revenue subdirectory
  </action>
  <verify>Visit /admin/analytics/revenue in browser, verify charts display, data loads correctly, navigation works</verify>
  <done>Revenue analytics page created with charts and trends, accessible from admin dashboard</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] RevenueChart displays daily revenue bars
- [ ] OrderTrends shows summary cards and trend line
- [ ] /admin/analytics/revenue page loads without errors
- [ ] Navigation to/from main dashboard works
- [ ] Charts handle empty data gracefully
- [ ] Currency formatting displays correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Revenue analytics page functional with time-series charts
- Order trends and metrics display correctly
- Pure HTML/CSS charts (no external dependencies)
- Navigation integrated with main dashboard
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/21-admin-dashboard/21-02-SUMMARY.md`
</output>
